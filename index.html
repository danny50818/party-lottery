<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸</title>
    
    <!-- 1. éŒ¯èª¤æ””æˆª -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg);
            return false;
        };
    </script>

    <!-- CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 3. Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        /* å­—é«”è¨­å®šï¼šå¾®è»Ÿæ­£é»‘é«” */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #202020;
            color: #fff;
            font-weight: bold;
        }

        /* 8-Bit é¢¨æ ¼æ¡†ç·š (ä¿ç•™å¾©å¤æ„Ÿä½†ç”¨æ¸…æ™°å­—é«”) */
        .pixel-box {
            background: #fff; border: 4px solid #000; color: #000;
            box-shadow: -4px 0 0 0 #000, 4px 0 0 0 #000, 0 -4px 0 0 #000, 0 4px 0 0 #000;
        }
        .pixel-box-dark {
            background: #000; border: 4px solid #fff; color: #fff;
            box-shadow: -4px 0 0 0 #fff, 4px 0 0 0 #fff, 0 -4px 0 0 #fff, 0 4px 0 0 #fff;
        }
        .pixel-btn {
            border: 4px solid rgba(0,0,0,0.2); 
            cursor: pointer; transition: transform 0.1s;
            box-shadow: inset -4px -4px 0 rgba(0,0,0,0.3);
        }
        .pixel-btn:active { transform: translateY(4px); }

        /* Loading */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pixel-spinner { width: 48px; height: 48px; background: #fbbf24; animation: pixel-spin 0.8s steps(4) infinite; box-shadow: 4px 4px 0 #b45309; }
        @keyframes pixel-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* éŠæˆ²èƒŒæ™¯ä¸»é¡Œ */
        .theme-mario { background: linear-gradient(#5c94fc 60%, #c84c0c 60%, #c84c0c 65%, #000 65%); }
        .theme-rpg { background: #000; border: 20px solid #fff; }
        .theme-fight { background: linear-gradient(to bottom, #1a1a2e, #4a0404); }
        .theme-space { background: #000; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px; }
        .theme-maze { background: #000; }
        .theme-race { background: linear-gradient(to bottom, #365314, #14532d); }
        .theme-casino { background: radial-gradient(circle, #5e0000, #1a0000); }
        .theme-tetris { background: #111; }
        .theme-cyber { background: radial-gradient(circle, #000, #1a1a2e); }

        /* éŠæˆ²å°ˆå±¬å‹•ç•« */
        @keyframes mario-run { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
        .mario-sprite { animation: mario-run 0.2s steps(2) infinite; }
        
        @keyframes floatUp { 0% { transform: translateY(110vh); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-20vh); opacity: 0; } }
        .bubble-pixel { position: absolute; animation: floatUp linear infinite; bottom: -100px; }
        
        /* Slots */
        @keyframes reelScroll { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
        .reel-rolling .reel-track { animation: reelScroll 0.15s linear infinite; filter: blur(2px); }

        /* Claw Machine */
        @keyframes clawSwing { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
        .claw-arm { transform-origin: top center; animation: clawSwing 2s ease-in-out infinite; }
        @keyframes clawGrab { 0% { top: -20px; } 50% { top: 200px; } 100% { top: -20px; } }
        .grabbing .claw-grabber { animation: clawGrab 2s ease-in-out forwards; animation-iteration-count: 1; }

        /* Meteor */
        @keyframes meteorDrop { 0% { transform: translate(100%, -100%) scale(0.5); opacity: 1; } 100% { transform: translate(-20%, 20%) scale(0.2); opacity: 0; } }
        .meteor-anim { animation: meteorDrop 0.8s ease-in forwards; }
        @keyframes impactShake { 0%, 100% { transform: translate(0, 0); } 10%, 90% { transform: translate(-5px, 5px); } 50% { transform: translate(5px, -5px); } }
        .animate-impact { animation: impactShake 0.5s ease-in-out; }

        /* Card Flip */
        .card-flip { transform-style: preserve-3d; transition: transform 0.6s; }
        .card-flip.flipped { transform: rotateY(180deg); }
        .card-face { backface-visibility: hidden; position: absolute; inset: 0; }
        .card-back { transform: rotateY(180deg); }

        .scanlines { position: fixed; inset: 0; pointer-events: none; z-index: 50; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div class="scanlines"></div>
    <div id="loading-screen">
        <div class="pixel-spinner mb-8"></div>
        <div class="text-yellow-400 text-xl font-bold">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;
        const { createRoot } = ReactDOM;
        
        const AVATARS = ["ğŸ‘¾", "ğŸ¤–", "ğŸ‘»", "ğŸ’€", "ğŸ‘½", "ğŸ’©", "ğŸµ", "ğŸ¶", "ğŸ±", "ğŸ¦Š", "ğŸ¸", "ğŸ¼"];
        const removeLoading = () => { const el = document.getElementById('loading-screen'); if(el) el.style.display = 'none'; };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) {
                    removeLoading();
                    return <div className="h-screen flex flex-col items-center justify-center p-6 bg-red-900 text-white text-center font-bold"><h1>âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h1><button onClick={()=>window.location.reload()} className="mt-4 bg-white text-red-900 px-6 py-2 rounded-full">é‡æ–°æ•´ç†</button></div>;
                }
                return this.props.children;
            }
        }

        const useSocket = (roomId, onEvent) => {
            const socketRef = useRef(null);
            const [status, setStatus] = useState('connecting');
            useEffect(() => {
                if(!roomId || typeof io === 'undefined') return;
                const socket = io({ reconnectionAttempts: 5, timeout: 5000 }); 
                socketRef.current = socket;
                socket.on('connect', () => { setStatus('connected'); socket.emit('join_room', roomId); });
                socket.on('disconnect', () => setStatus('disconnected'));
                socket.on('player_list_update', (d) => onEvent && onEvent('player_list_update', d));
                socket.on('game_status_update', (d) => onEvent && onEvent('game_status_update', d));
                socket.on('init_data', (d) => onEvent && onEvent('init_data', d));
                socket.on('game_reset', (d) => onEvent && onEvent('game_reset', d));
                return () => socket.disconnect();
            }, [roomId]);
            const emit = (e, d) => { if(socketRef.current) socketRef.current.emit(e, { roomId, ...d }); };
            return { status, emit };
        };

        // --- è¦–è¦ºçµ„ä»¶ (ç¨ç«‹æ–¼ HostApp å¤–éƒ¨ï¼Œç¢ºä¿å‹•ç•«ä¸ä¸­æ–·) ---
        const VisualComponent = ({ candidates, targetName, isRolling, mode, winnerObj }) => {
            const [display, setDisplay] = useState("READY");
            const [horses, setHorses] = useState([]);
            const [slotStops, setSlotStops] = useState([false, false, false]);
            const [impact, setImpact] = useState(false);
            const [mazePos, setMazePos] = useState(0);

            // ç‹€æ…‹é‡ç½®èˆ‡å‹•ç•«å•Ÿå‹•
            useEffect(() => {
                let interval;
                if (isRolling) {
                    setSlotStops([false, false, false]);
                    setImpact(false);
                    
                    if (mode === 'race') {
                        // åˆå§‹åŒ–è³½é¦¬
                        const racers = candidates.slice(0, 5).map(p => ({...p, progress: 5}));
                        while(racers.length < 5) racers.push({name:'NPC', avatar:'ğŸ', progress:5});
                        setHorses(racers);
                        interval = setInterval(() => {
                            setHorses(prev => prev.map(h => ({...h, progress: Math.min(88, h.progress + Math.random() * 3)})));
                        }, 100);
                    } else if (mode === 'maze') {
                         interval = setInterval(() => setMazePos(p => (p + 10) % 360), 50);
                    } else if (mode === 'slots') {
                         // Slots é  CSS å‹•ç•«
                    } else {
                        // æ–‡å­—è·³å‹•
                        interval = setInterval(() => {
                            const randomName = candidates[Math.floor(Math.random() * candidates.length)]?.name || "...";
                            setDisplay(randomName);
                        }, 80);
                    }
                } else if (targetName) {
                    setDisplay(targetName);
                    
                    if (mode === 'race' && winnerObj) {
                        setHorses(prev => prev.map(h => h.name === winnerObj.name ? {...h, progress: 95} : h));
                    }
                    if (mode === 'slots') {
                        setTimeout(() => setSlotStops([true, false, false]), 100);
                        setTimeout(() => setSlotStops([true, true, false]), 600);
                        setTimeout(() => setSlotStops([true, true, true]), 1200);
                    }
                    if (mode === 'meteor') {
                        setImpact(true);
                    }
                }
                return () => clearInterval(interval);
            }, [isRolling, targetName, mode, winnerObj, candidates]);

            // --- æ¸²æŸ“å„æ¨¡å¼ ---

            // 1. å†’éšªå³¶
            if (mode === 'adventure') return (
                <div className="w-full h-full relative overflow-hidden theme-mario flex flex-col justify-end">
                    <div className="absolute top-10 left-10 text-6xl opacity-80 animate-pulse">â˜ï¸</div>
                    <div className="absolute top-20 right-20 text-6xl opacity-80 animate-pulse" style={{animationDelay:'1s'}}>â˜ï¸</div>
                    <div className="h-20 bg-[#c84c0c] border-t-8 border-black w-full relative z-10 flex items-center justify-center text-black/20 text-sm">GROUND</div>
                    <div className={`absolute bottom-20 left-1/2 -translate-x-1/2 transition-all duration-500 ${!isRolling && targetName ? 'bottom-48 scale-150' : ''}`}>
                        <div className="text-8xl mario-sprite relative z-20">
                            {isRolling ? 'ğŸƒ' : (winnerObj?.avatar || 'ğŸ•´ï¸')}
                        </div>
                        {!isRolling && targetName && <div className="absolute -top-16 left-1/2 -translate-x-1/2 pixel-box px-4 py-1 whitespace-nowrap animate__animated animate__bounceIn">VICTORY!</div>}
                    </div>
                </div>
            );

            // 2. è³½é¦¬
            if (mode === 'race') return (
                <div className="w-full max-w-5xl flex flex-col gap-3 relative p-6 bg-black/40 rounded-xl border-4 border-white/20 theme-race">
                    <div className="absolute right-8 top-0 bottom-0 w-2 bg-yellow-400 z-10 opacity-70"></div>
                    {horses.map((h, i) => (
                        <div key={i} className="flex items-center gap-2 relative border-b-2 border-white/30 pb-2 h-16">
                            <div className="w-24 text-right text-lg truncate text-white font-bold bg-black/50 px-2 rounded">{h.name}</div>
                            <div className="flex-1 relative h-full">
                                <div className="absolute top-1/2 -translate-y-1/2 text-5xl transition-all duration-300 ease-linear transform -translate-x-full" style={{left: `${h.progress}%`}}>{h.avatar}</div>
                            </div>
                        </div>
                    ))}
                </div>
            );

            // 3. å¤¾å¨ƒå¨ƒ
            if (mode === 'claw') return (
                <div className="relative w-[500px] h-[600px] border-[12px] border-pink-500 rounded-3xl bg-black/40 overflow-hidden mx-auto shadow-2xl">
                    <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-4 bg-gray-400 transition-all duration-[2000ms] ${isRolling?'h-60':targetName?'h-80':'h-20'}`} style={{left: isRolling?'80%': targetName ? '50%' : '15%'}}></div>
                    <div className={`absolute top-0 left-1/2 -translate-x-1/2 flex flex-col items-center transition-all duration-[2000ms] ease-in-out ${isRolling ? 'left-[80%]' : 'left-[15%]'}`} style={{left: isRolling?'80%': targetName ? '50%' : '15%', top: isRolling?'10%':targetName?'40%':'0%'}}>
                         <div className="text-9xl claw-arm">ğŸ‘¾</div>
                    </div>
                    <div className="absolute bottom-0 w-full h-1/2 flex flex-wrap content-end justify-center p-4 gap-4 opacity-90">
                        {candidates.slice(0, 15).map((c,i) => <div key={i} className="text-5xl animate-bounce" style={{animationDelay:`${i*0.1}s`}}>{c.avatar}</div>)}
                    </div>
                    {!isRolling && targetName && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 text-center animate__animated animate__zoomIn"><div className="text-9xl mb-4">{winnerObj?.avatar}</div><div className="bg-white text-pink-600 px-8 py-3 rounded-full font-black text-3xl shadow-lg border-4 border-pink-500">{targetName}</div></div>}
                </div>
            );

            // 4. æ‹‰éœ¸æ©Ÿ
            if (mode === 'slots') {
                const strip = [...candidates, ...candidates, ...candidates, ...candidates].slice(0, 40);
                return (
                    <div className="flex justify-center gap-6 bg-yellow-600 p-10 rounded-[3rem] border-8 border-yellow-400 shadow-2xl relative theme-casino">
                        <div className="absolute -top-10 left-1/2 -translate-x-1/2 bg-red-600 text-white px-8 py-2 rounded-lg font-black text-2xl border-4 border-yellow-300 shadow-lg z-20">JACKPOT</div>
                        {[0, 1, 2].map(col => (
                            <div key={col} className="bg-white h-64 w-40 md:w-48 rounded-xl border-4 border-gray-800 relative overflow-hidden shadow-inner">
                                <div className="absolute inset-0 bg-gradient-to-b from-black/40 via-transparent to-black/40 z-10 pointer-events-none"></div>
                                <div className={`w-full ${!slotStops[col] ? 'reel-rolling' : ''}`} style={{ transform: slotStops[col] ? 'translateY(0)' : undefined }}> 
                                    {!slotStops[col] ? <div className="reel-track">{strip.map((c, i) => <div key={i} className="h-64 flex flex-col items-center justify-center border-b border-gray-200"><div className="text-6xl">{c.avatar}</div></div>)}</div> : 
                                    <div className="h-64 flex flex-col items-center justify-center animate__animated animate__bounceIn"><div className="text-8xl mb-4">{winnerObj?.avatar || 'ğŸ’'}</div><div className="text-2xl font-bold text-red-600">{winnerObj?.name || targetName}</div></div>}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }
            
            // 5. æµæ˜Ÿ
            if (mode === 'meteor') return (
                <div className={`relative w-full h-full flex flex-col items-center justify-center theme-space overflow-visible ${impact?'animate-impact':''}`}>
                    {isRolling && <div className="text-white/60 text-4xl animate-pulse tracking-[1em]">âœ¨ å‡èšé¡˜åŠ›ä¸­ âœ¨</div>}
                    {!isRolling && targetName && <div className="z-20 text-center relative"><div className="text-[150px] animate__animated animate__zoomInDown mb-4 absolute top-[-200px] left-1/2 -translate-x-1/2">â˜„ï¸</div><div className="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-yellow-300 drop-shadow-2xl animate__animated animate__fadeInUp pt-32">{targetName}</div></div>}
                </div>
            );

            // 6. å¹¸é‹è½‰ç›¤
            if (mode === 'retro') return (
                <div className="relative flex items-center justify-center theme-festival w-full h-full">
                    <div className="absolute top-[-50px] text-8xl z-20 text-white drop-shadow-xl">â¬‡</div>
                    <div className={`w-[600px] h-[600px] rounded-full border-[16px] border-yellow-500 bg-red-800 flex items-center justify-center shadow-2xl overflow-hidden relative ${isRolling ? 'animate-spin' : ''}`} style={{animationDuration: isRolling ? '0.3s' : '0s'}}>
                         <div className="absolute inset-0 bg-[conic-gradient(from_0deg,#ff0000_0deg_36deg,#ffffff_36deg_72deg,#ff0000_72deg_108deg,#ffffff_108deg_144deg,#ff0000_144deg_180deg,#ffffff_180deg_216deg,#ff0000_216deg_252deg,#ffffff_252deg_288deg,#ff0000_288deg_324deg,#ffffff_324deg_360deg)] opacity-30"></div>
                         <div className={`w-60 h-60 bg-white rounded-full flex flex-col items-center justify-center z-10 border-8 border-gray-200 shadow-xl ${!isRolling ? 'animate__animated animate__rubberBand' : ''}`}>
                             {!isRolling && targetName ? <div className="text-center"><div className="text-6xl mb-2">{winnerObj?.avatar}</div><div className="text-3xl font-bold text-red-600 max-w-[180px] truncate">{targetName}</div></div> : <div className="text-6xl font-black text-gray-300">SPIN</div>}
                         </div>
                    </div>
                </div>
            );

            // 7. å‘½é‹å¡”ç¾…
            if (mode === 'magic') return (
                <div className="flex items-center justify-center h-full theme-magic">
                     <div className={`relative w-80 h-[500px] transition-all duration-[1500ms] transform-style-3d ${!isRolling && targetName ? 'flipped' : ''} card-flip`}>
                         <div className="card-face absolute inset-0 bg-gradient-to-br from-indigo-900 to-purple-900 rounded-3xl border-4 border-yellow-400 flex items-center justify-center shadow-2xl backface-hidden"><div className="text-9xl opacity-50 animate-pulse">ğŸ”®</div></div>
                         <div className="card-face card-back absolute inset-0 bg-white rounded-3xl border-8 border-purple-600 flex flex-col items-center justify-center shadow-2xl backface-hidden"><div className="text-9xl mb-8">{winnerObj?.avatar}</div><div className="text-5xl font-bold text-purple-900">{targetName}</div></div>
                     </div>
                </div>
            );

            // 8. é è¨­ (çŸ©é™£/é›·é”)
            return (
                <div className="flex flex-col items-center justify-center text-center w-full h-full theme-cyber">
                    <div className={`text-9xl font-black neon-text transition-all duration-300 ${isRolling ? 'opacity-70 blur-sm scale-95' : 'opacity-100 scale-125 text-yellow-300'}`}>{display}</div>
                    {isRolling && <div className="text-cyan-400 mt-12 text-3xl tracking-[0.5em] animate-pulse">SYSTEM DECODING...</div>}
                </div>
            );
        };

        // --- 1. Index Page ---
        const IndexPage = ({ onStartHost, initialPlayers }) => {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState(initialPlayers || []);
            const { status } = useSocket(roomId, (evt, data) => {
                if (evt === 'player_list_update') setPlayers(data);
                else if (evt === 'init_data' && data.players) setPlayers(data.players || []);
                else if (evt === 'game_reset') setPlayers([]);
            });
            useEffect(() => {
                let rid = new URLSearchParams(window.location.search).get('room');
                if(!rid) rid = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomId(rid);
                const url = `${window.location.href.split('?')[0]}?mode=player&room=${rid}`;
                if(typeof QRCode !== 'undefined') QRCode.toDataURL(url, { width: 300, margin: 2, color: { dark: '#000000', light: '#ffffff' } }, (e, u) => !e && setQrUrl(u));
            }, []);

            const PlayerBubble = ({ p }) => {
                const style = useMemo(() => ({ width: `${80+Math.random()*60}px`, height: `${80+Math.random()*60}px`, left: `${5+Math.random()*90}%`, animationDuration: `${10+Math.random()*15}s`, animationDelay: `${Math.random()*-15}s` }), []);
                return <div className="bubble-pixel flex flex-col items-center justify-center bg-white border-4 border-black text-black p-2 shadow-lg z-0" style={style}><div className="text-3xl">{p.avatar}</div><div className="font-bold text-xs mt-1 truncate max-w-[80px]">{p.name}</div></div>;
            };

            return (
                <div className="min-h-screen relative overflow-hidden bg-gray-900">
                    <div className="absolute top-4 left-4 z-20 flex gap-2"><span className={`pixel-box px-2 py-1 text-xs ${status==='connected'?'bg-green-400':'bg-red-400'}`}>{status==='connected'?'ONLINE':'CONNECTING'}</span><span className="pixel-box px-2 py-1 text-xs bg-blue-300">ROOM: {roomId}</span></div>
                    <div className="absolute inset-0 pointer-events-none">{players.map((p,i)=><PlayerBubble key={i} p={p}/>)}</div>
                    <div className="relative z-10 min-h-screen flex flex-col items-center justify-center p-6">
                        <div className="text-center mb-10">
                            <div className="text-yellow-400 text-sm mb-4 animate-pulse">â˜… PRESS START TO JOIN â˜…</div>
                            <h1 className="text-4xl md:text-6xl text-white drop-shadow-[4px_4px_0_#000] leading-tight mb-4">å®¶é˜²ä¸­å¿ƒ<br/>å°¾ç‰™ç››å…¸</h1>
                            <div className="inline-block bg-red-600 border-4 border-white text-white px-4 py-2 text-sm shadow-[4px_4px_0_#000]">SCAN QR TO JOIN</div>
                        </div>
                        <div className="pixel-box p-4 bg-white flex flex-col items-center gap-4 transform hover:scale-105 transition-transform">
                            {qrUrl ? <img src={qrUrl} className="w-48 h-48 image-pixelated" /> : <div className="w-48 h-48 flex items-center justify-center text-black">LOADING...</div>}
                            <div className="text-center text-black"><div className="text-2xl mb-1">{players.length} P</div><div className="text-xs">READY</div></div>
                        </div>
                        <div className="absolute bottom-10 right-10"><button onClick={() => onStartHost(roomId, players)} className="pixel-btn pixel-btn-yellow px-6 py-4 text-sm animate-bounce text-black">ä¸»æŒäººå…¥å£ &gt;</button></div>
                    </div>
                </div>
            );
        };

        // --- 2. Player App ---
        const PlayerApp = ({ room }) => {
            const [user, setUser] = useState(null);
            const [nameInput, setNameInput] = useState("");
            const [myAvatar, setMyAvatar] = useState(AVATARS[0]);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const { status, emit } = useSocket(room, (evt, data) => {
                if (evt === 'game_status_update') setGameStatus(data);
                if (evt === 'game_reset') { localStorage.removeItem('lottery_user'); setUser(null); setJoined(false); alert("GAME RESET"); }
            });
            useEffect(() => { try { const u = JSON.parse(localStorage.getItem('lottery_user')); if (u) { setUser(u); setJoined(true); } } catch(e){} }, []);
            useEffect(() => { if (status === 'connected' && joined && user) emit('player_join', { user }); }, [status, joined]);
            const handleJoin = () => { if(!nameInput.trim()) return; const newUser = { id: Date.now().toString(), name: nameInput.trim(), avatar: myAvatar }; setUser(newUser); setJoined(true); localStorage.setItem('lottery_user', JSON.stringify(newUser)); emit('player_join', { user: newUser }); };
            
            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;

            if(isWinner) return <div className="fixed inset-0 z-50 bg-yellow-500 flex flex-col items-center justify-center p-4 text-center"><div className="animate__animated animate__tada animate__infinite text-9xl mb-6">ğŸ†</div><div className="pixel-box-dark p-6 mb-4"><h1 className="text-2xl text-yellow-400 mb-2">YOU WIN!</h1><p className="text-sm">æ­å–œä¸­çï¼</p></div><div className="pixel-box p-4 flex flex-col items-center"><div className="text-6xl mb-2">{user?.avatar}</div><div className="text-xl font-bold">{user?.name}</div></div></div>;
            if(!joined) return <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-4"><div className="pixel-box p-6 w-full max-w-sm text-center"><h1 className="text-xl mb-6 text-blue-600">PLAYER JOIN</h1><div className="grid grid-cols-4 gap-2 mb-6">{AVATARS.slice(0, 8).map(a => <button key={a} onClick={() => setMyAvatar(a)} className={`text-2xl p-2 border-2 ${myAvatar === a ? 'border-blue-500 bg-blue-100' : 'border-transparent'}`}>{a}</button>)}</div><input type="text" className="w-full border-4 border-black p-3 font-mono text-center mb-6 text-black" placeholder="NAME" value={nameInput} onChange={e => setNameInput(e.target.value)} maxLength={8} /><button onClick={handleJoin} className="pixel-btn w-full py-4 text-lg">ENTER</button></div></div>;
            return <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center text-white p-4"><div className="absolute top-2 right-2 text-[10px] text-green-400">{status}</div>{gameStatus.status === 'playing' ? <div className="text-center animate-pulse"><div className="text-6xl mb-4">ğŸ²</div><div className="text-yellow-400 text-xl">ROLLING...</div></div> : <div className="text-center w-full max-w-sm"><div className="pixel-box-dark p-8 mb-6"><div className="text-6xl mb-4">{user.avatar}</div><div className="text-2xl text-yellow-400">{user.name}</div><div className="mt-4 text-xs text-green-400 border border-green-400 px-2 py-1 inline-block">READY</div></div></div>}</div>;
        };

        // --- 3. Host App ---
        const HostApp = ({ room, initialPlayers }) => {
            const [allPlayers, setAllPlayers] = useState(initialPlayers || []);
            const [winners, setWinners] = useState([]); 
            const [currentRound, setCurrentRound] = useState(0); 
            const [isDrawing, setIsDrawing] = useState(false); 
            const [drawQueue, setDrawQueue] = useState([]); 
            const [currentDisplayWinner, setCurrentDisplayWinner] = useState(null); 
            const [currentDisplayWinnerObj, setCurrentDisplayWinnerObj] = useState(null); 
            const [isVisualRolling, setIsVisualRolling] = useState(false); 
            const [targetCount, setTargetCount] = useState(1);
            const [gameMode, setGameMode] = useState('adventure'); // é è¨­æ¨¡å¼
            const [showWinnerModal, setShowWinnerModal] = useState(false);
            const [modalWinner, setModalWinner] = useState(null);
            
            const { emit } = useSocket(room, (evt, data) => {
                if(evt === 'player_list_update') setAllPlayers(data);
                if(evt === 'init_data' && data.players) setAllPlayers(data.players);
                if(evt === 'game_reset') { setAllPlayers([]); setWinners([]); setCurrentRound(0); setIsDrawing(false); setDrawQueue([]); }
            });

            // æ¨¡å¼åˆ—è¡¨
            const MODES = [
                { id: 'adventure', name: 'å†’éšªå³¶' }, { id: 'rpg', name: 'å‹‡è€…å‚³èªª' }, { id: 'race', name: 'è³½è»Š' }, { id: 'fighter', name: 'æ ¼é¬¥' },
                { id: 'shooter', name: 'å¤ªç©º' }, { id: 'maze', name: 'è¿·å®®' }, { id: 'slots', name: 'æ‹‰éœ¸' }, { id: 'tetris', name: 'çŸ©é™£' }
            ];
            const [unusedModes, setUnusedModes] = useState([...MODES.map(m => m.id)]);

            const availablePlayers = useMemo(() => {
                const ids = new Set(winners.map(w => w.id));
                return allPlayers.filter(p => !ids.has(p.id));
            }, [allPlayers, winners]);

            const resetGame = () => { if(confirm("RESET?")) emit('reset_game', {}); };

            const startDraw = async () => {
                if(availablePlayers.length < targetCount) { alert("äººæ•¸ä¸è¶³"); return; }
                
                // éš¨æ©Ÿåˆ‡æ›æ¨¡å¼
                let nextModes = [...unusedModes];
                if(nextModes.length === 0) nextModes = MODES.map(m=>m.id);
                const rIdx = Math.floor(Math.random()*nextModes.length);
                const mode = nextModes[rIdx];
                nextModes.splice(rIdx, 1);
                setUnusedModes(nextModes);
                setGameMode(mode);

                setIsDrawing(true);
                const nextRound = currentRound + 1;
                setCurrentRound(nextRound);

                const pool = [...availablePlayers];
                const roundWinners = [];
                for(let i=0; i<targetCount; i++){
                    const idx = Math.floor(Math.random()*pool.length);
                    roundWinners.push(pool[idx]);
                    pool.splice(idx,1);
                }
                setWinners(prev => [...prev, ...roundWinners]);
                emit('update_game_status', { status: {status:'playing', round: nextRound} });
                await processQueue(roundWinners, mode);
            };

            const processQueue = async (queue, mode) => {
                const animTime = (mode === 'race' || mode === 'claw') ? 8000 : 5000;

                await new Promise(r => setTimeout(r, 500));
                for(let i=0; i<queue.length; i++) {
                    const w = queue[i];
                    setIsVisualRolling(true);
                    setCurrentDisplayWinner(null);
                    setShowWinnerModal(false);
                    
                    await new Promise(r => setTimeout(r, animTime)); 
                    
                    setIsVisualRolling(false);
                    setCurrentDisplayWinner(w.name);
                    setCurrentDisplayWinnerObj(w);
                    
                    await new Promise(r => setTimeout(r, 2000)); // æ­æ›‰åœç•™
                    
                    setModalWinner(w);
                    setShowWinnerModal(true);
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    
                    await new Promise(r => setTimeout(r, 5000)); // å½ˆçª—åœç•™
                    setShowWinnerModal(false);
                    
                    emit('update_game_status', { status: {status:'result', round: currentRound+1, winnerName: w.name, winnerId: w.id} });
                    await new Promise(r => setTimeout(r, 500));
                }
                setIsDrawing(false);
            };

            return (
                <div className="h-screen bg-gray-900 flex flex-col relative overflow-hidden">
                    {/* å¾—çå½ˆçª— */}
                    {showWinnerModal && modalWinner && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 animate__animated animate__fadeIn">
                            <div className="text-center animate__animated animate__zoomInDown">
                                <div className="text-yellow-400 text-2xl mb-4 font-bold tracking-widest">CONGRATULATIONS</div>
                                <div className="pixel-box-dark p-12 border-8 border-yellow-500 shadow-[0_0_50px_rgba(234,179,8,0.5)]">
                                    <div className="text-9xl mb-6 animate-bounce">{modalWinner.avatar}</div>
                                    <div className="text-5xl font-black text-white">{modalWinner.name}</div>
                                    <div className="mt-8 bg-red-600 text-white px-6 py-2 text-xl inline-block">WINNER</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Top Bar */}
                    <div className="absolute top-0 left-0 w-full p-4 flex justify-between z-20">
                        <div className="pixel-box px-4 py-2 bg-blue-600 text-white text-xs">P: {allPlayers.length}</div>
                        <div className="pixel-box px-4 py-2 bg-red-600 text-white text-xs">MODE: {gameMode.toUpperCase()}</div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 flex items-center justify-center p-8 bg-grid">
                        <VisualComponent candidates={availablePlayers.concat(drawQueue)} targetName={currentDisplayWinner} isRolling={isVisualRolling} mode={gameMode} winnerObj={currentDisplayWinnerObj} />
                    </div>

                    {/* Controls */}
                    <div className="h-24 bg-gray-800 border-t-4 border-black flex items-center justify-center gap-6 p-4 z-30">
                        {!isDrawing && (
                            <div className="flex items-center gap-4 bg-black p-2 border-2 border-white">
                                <span className="text-xs text-gray-400">COUNT</span>
                                <button className="text-yellow-400 font-bold" onClick={()=>setTargetCount(Math.max(1,targetCount-1))}>-</button>
                                <span className="text-xl w-8 text-center">{targetCount}</span>
                                <button className="text-yellow-400 font-bold" onClick={()=>setTargetCount(Math.min(10,targetCount+1))}>+</button>
                            </div>
                        )}
                        <button onClick={startDraw} disabled={isDrawing || availablePlayers.length === 0} className={`pixel-btn ${isDrawing ? 'bg-gray-600' : 'pixel-btn-red'} px-8 py-3 text-xl font-bold`}>
                            {isDrawing ? 'ROLLING...' : 'START'}
                        </button>
                        {!isDrawing && <button onClick={resetGame} className="pixel-btn bg-gray-600 text-xs px-4 py-3">RESET</button>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('index');
            const [room, setRoom] = useState('');
            useEffect(() => {
                const p = new URLSearchParams(window.location.search);
                const m = p.get('mode'); const r = p.get('room');
                if (m === 'host' && r) { setMode('host'); setRoom(r); }
                else if (m === 'player' && r) { setMode('player'); setRoom(r); }
                else setMode('index');
            }, []);
            const handleStartHost = (rid, ps) => {
                sessionStorage.setItem(`lottery_players_${rid}`, JSON.stringify(ps));
                window.location.href = `?mode=host&room=${rid}`;
            };
            return (
                <ErrorBoundary>
                    {mode === 'index' && <IndexPage onStartHost={handleStartHost} initialPlayers={[]} />}
                    {mode === 'host' && <HostApp room={room} initialPlayers={JSON.parse(sessionStorage.getItem(`lottery_players_${room}`) || '[]')} />}
                    {mode === 'player' && <PlayerApp room={room} />}
                </ErrorBoundary>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        removeLoading();
    </script>
</body>
</html>
