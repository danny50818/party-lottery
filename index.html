<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸ (8-Bit)</title>
    
    <!-- 1. Pixel Font & CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 3. Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        /* å…¨åŸŸåƒç´ é¢¨æ ¼è¨­å®š */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Press Start 2P', cursive; /* åƒç´ å­—é«” */
            background-color: #202020;
            color: #fff;
            image-rendering: pixelated; /* è®“åœ–ç‰‡ç¸®æ”¾æ™‚ä¿æŒé‹¸é½’ */
        }

        /* åƒç´ æ¡†ç·š (NES é¢¨æ ¼) */
        .pixel-box {
            background: #fff;
            border: 4px solid #000;
            box-shadow: 
                -4px 0 0 0 #000,
                4px 0 0 0 #000,
                0 -4px 0 0 #000,
                0 4px 0 0 #000;
            margin: 4px;
            color: #000;
        }
        .pixel-box-dark {
            background: #000;
            border: 4px solid #fff;
            box-shadow: 
                -4px 0 0 0 #fff,
                4px 0 0 0 #fff,
                0 -4px 0 0 #fff,
                0 4px 0 0 #fff;
            color: #fff;
        }
        
        .pixel-btn {
            background: #3b82f6;
            color: white;
            border: 4px solid #1d4ed8;
            box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .pixel-btn:active { transform: translateY(4px); box-shadow: inset -2px -2px 0px 0px rgba(0,0,0,0.5); }
        .pixel-btn-red { background: #ef4444; border-color: #b91c1c; }
        .pixel-btn-yellow { background: #eab308; border-color: #a16207; color: black; }

        /* èƒŒæ™¯ç¶²æ ¼å‹•æ…‹ */
        .bg-grid {
            background-image: 
                linear-gradient(transparent 95%, #333 95%),
                linear-gradient(90deg, transparent 95%, #333 95%);
            background-size: 40px 40px;
            animation: gridMove 20s linear infinite;
        }
        @keyframes gridMove { from { background-position: 0 0; } to { background-position: 0 100%; } }

        /* 8-bit Loading */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pixel-spinner {
            width: 64px; height: 64px;
            background: #fbbf24;
            animation: pixel-spin 1s steps(4) infinite;
            box-shadow: 4px 4px 0 #b45309;
        }
        @keyframes pixel-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* éŠæˆ²å°ˆå±¬å‹•ç•« (ä½¿ç”¨ steps æ¨¡æ“¬é€æ ¼å‹•ç•«) */
        @keyframes run-cycle { 0% { transform: translateY(0); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0); } }
        .sprite-run { animation: run-cycle 0.2s steps(2) infinite; }
        
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .blink { animation: blink 1s steps(1) infinite; }

        /* æƒæç·šç‰¹æ•ˆ (CRT Monitor Effect) */
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div class="scanlines"></div>
    
    <div id="loading-screen">
        <div class="pixel-spinner mb-8"></div>
        <div class="text-yellow-400 text-xl blink">LOADING...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;
        const { createRoot } = ReactDOM;
        
        // 8-bit é¢¨æ ¼é ­åƒ (Emoji æœ¬èº«å°±æ˜¯åœ–å½¢ï¼Œä½†åœ¨åƒç´ é¢¨ä¸‹é¡¯ç¤ºä¹Ÿå¾ˆæ­)
        const AVATARS = ["ğŸ‘¾", "ğŸ¤–", "ğŸ‘»", "ğŸ’€", "ğŸ‘½", "ğŸ’©", "ğŸµ", "ğŸ¶", "ğŸ±", "ğŸ¦Š", "ğŸ¸", "ğŸ¼"];
        const removeLoading = () => { const el = document.getElementById('loading-screen'); if(el) el.style.display = 'none'; };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) {
                    removeLoading();
                    return <div className="h-screen flex flex-col items-center justify-center p-6 bg-red-900 text-white text-center font-mono"><h1>GAME CRASHED</h1><button onClick={()=>window.location.reload()} className="mt-4 pixel-btn px-4 py-2">RESTART</button></div>;
                }
                return this.props.children;
            }
        }

        const useSocket = (roomId, onEvent) => {
            const socketRef = useRef(null);
            const [status, setStatus] = useState('connecting');
            useEffect(() => {
                if(!roomId || typeof io === 'undefined') return;
                const socket = io({ reconnectionAttempts: 5, timeout: 5000 }); 
                socketRef.current = socket;
                socket.on('connect', () => { setStatus('connected'); socket.emit('join_room', roomId); });
                socket.on('disconnect', () => setStatus('disconnected'));
                socket.on('player_list_update', (d) => onEvent && onEvent('player_list_update', d));
                socket.on('game_status_update', (d) => onEvent && onEvent('game_status_update', d));
                socket.on('init_data', (d) => onEvent && onEvent('init_data', d));
                socket.on('game_reset', (d) => onEvent && onEvent('game_reset', d));
                return () => socket.disconnect();
            }, [roomId]);
            const emit = (e, d) => { if(socketRef.current) socketRef.current.emit(e, { roomId, ...d }); };
            return { status, emit };
        };

        // --- 1. è¿è³“å¤§å»³ ---
        const IndexPage = ({ onStartHost, initialPlayers }) => {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState(initialPlayers || []);
            
            useSocket(roomId, (evt, data) => {
                if (evt === 'player_list_update') setPlayers(data);
                else if (evt === 'init_data' && data.players) setPlayers(data.players);
                else if (evt === 'game_reset') setPlayers([]);
            });

            useEffect(() => {
                let rid = new URLSearchParams(window.location.search).get('room');
                if(!rid) rid = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomId(rid);
                const url = `${window.location.href.split('?')[0]}?mode=player&room=${rid}`;
                if(typeof QRCode !== 'undefined') QRCode.toDataURL(url, { width: 300, margin: 2, color: { dark: '#000000', light: '#ffffff' } }, (e, u) => !e && setQrUrl(u));
            }, []);

            // åƒç´ æ³¡æ³¡ï¼šä½¿ç”¨ CSS transform æ›¿ä»£ left/top
            const PlayerBubble = ({ p }) => {
                const style = useMemo(() => ({
                    left: `${Math.random() * 90}%`,
                    animationDuration: `${5 + Math.random() * 10}s`,
                    animationDelay: `${Math.random() * -10}s`
                }), []);
                return (
                    <div className="absolute animate-[floatUp_linear_infinite] flex flex-col items-center" style={{...style, bottom: '-100px'}}>
                        <div className="bg-white border-4 border-black p-2 shadow-lg">{p.avatar}</div>
                        <div className="bg-black text-white text-xs px-2 py-1 mt-1 font-bold truncate max-w-[100px]">{p.name}</div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-blue-900 relative overflow-hidden bg-grid">
                    <div className="absolute top-4 left-4 z-20 flex gap-4 text-xs">
                        <div className="pixel-box px-2 py-1 bg-green-400">ROOM: {roomId}</div>
                    </div>
                    
                    {/* æ¼‚æµ®ç©å®¶ */}
                    <div className="absolute inset-0 pointer-events-none">{players.map((p,i)=><PlayerBubble key={i} p={p}/>)}</div>

                    <div className="relative z-10 flex flex-col items-center justify-center h-screen p-4">
                        <div className="text-center mb-10">
                            <div className="text-yellow-400 text-sm mb-4 blink">â˜… PRESS START TO JOIN â˜…</div>
                            <h1 className="text-4xl md:text-6xl text-white drop-shadow-[4px_4px_0_#000] leading-tight mb-4 text-stroke">
                                å®¶é˜²ä¸­å¿ƒ<br/>å°¾ç‰™ç››å…¸
                            </h1>
                            <div className="inline-block bg-red-600 border-4 border-white text-white px-4 py-2 text-sm shadow-[4px_4px_0_#000]">
                                æƒæ QR CODE åŠ å…¥
                            </div>
                        </div>

                        <div className="pixel-box p-4 bg-white flex flex-col items-center gap-4 transform hover:scale-105 transition-transform">
                            {qrUrl ? <img src={qrUrl} className="w-48 h-48 image-pixelated" /> : <div className="w-48 h-48 flex items-center justify-center text-black">LOADING...</div>}
                            <div className="text-center text-black">
                                <div className="text-2xl mb-1">{players.length} P</div>
                                <div className="text-xs">READY</div>
                            </div>
                        </div>

                        <div className="absolute bottom-10 right-10">
                            <button onClick={() => onStartHost(roomId, players)} className="pixel-btn pixel-btn-yellow px-6 py-4 text-sm animate-bounce">
                                ä¸»æŒäººå…¥å£ &gt;
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 2. Player App ---
        const PlayerApp = ({ room }) => {
            const [user, setUser] = useState(null);
            const [nameInput, setNameInput] = useState("");
            const [myAvatar, setMyAvatar] = useState(AVATARS[0]);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const { status, emit } = useSocket(room, (evt, data) => {
                if (evt === 'game_status_update') setGameStatus(data);
                if (evt === 'game_reset') { localStorage.removeItem('lottery_user'); setUser(null); setJoined(false); alert("GAME RESET"); }
            });
            useEffect(() => { try { const u = JSON.parse(localStorage.getItem('lottery_user')); if (u) { setUser(u); setJoined(true); } } catch(e){} }, []);
            useEffect(() => { if (status === 'connected' && joined && user) emit('player_join', { user }); }, [status, joined]);
            const handleJoin = () => { if(!nameInput.trim()) return; const newUser = { id: Date.now().toString(), name: nameInput.trim(), avatar: myAvatar }; setUser(newUser); setJoined(true); localStorage.setItem('lottery_user', JSON.stringify(newUser)); emit('player_join', { user: newUser }); };
            
            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;

            if(isWinner) return (
                <div className="fixed inset-0 z-50 bg-yellow-500 flex flex-col items-center justify-center p-4 text-center">
                    <div className="animate__animated animate__tada animate__infinite text-9xl mb-6">ğŸ†</div>
                    <div className="pixel-box-dark p-6 mb-4">
                        <h1 className="text-2xl text-yellow-400 mb-2">YOU WIN!</h1>
                        <p className="text-sm">æ­å–œä¸­çï¼</p>
                    </div>
                    <div className="pixel-box p-4 flex flex-col items-center">
                        <div className="text-6xl mb-2">{user?.avatar}</div>
                        <div className="text-xl font-bold">{user?.name}</div>
                    </div>
                </div>
            );

            if(!joined) return (
                <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-4">
                    <div className="pixel-box p-6 w-full max-w-sm text-center">
                        <h1 className="text-xl mb-6 text-blue-600">PLAYER JOIN</h1>
                        <div className="grid grid-cols-4 gap-2 mb-6">
                            {AVATARS.slice(0, 8).map(a => <button key={a} onClick={() => setMyAvatar(a)} className={`text-2xl p-2 border-2 ${myAvatar === a ? 'border-blue-500 bg-blue-100' : 'border-transparent'}`}>{a}</button>)}
                        </div>
                        <input type="text" className="w-full border-4 border-black p-3 font-mono text-center mb-6 text-black" placeholder="YOUR NAME" value={nameInput} onChange={e => setNameInput(e.target.value)} maxLength={8} />
                        <button onClick={handleJoin} className="pixel-btn w-full py-4 text-lg">START</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center text-white p-4">
                    <div className="absolute top-2 right-2 text-[10px] text-green-400">{status}</div>
                    {gameStatus.status === 'playing' ? (
                        <div className="text-center animate-pulse">
                            <div className="text-6xl mb-4">ğŸ²</div>
                            <div className="text-yellow-400 text-xl">ROLLING...</div>
                        </div>
                    ) : (
                        <div className="text-center w-full max-w-sm">
                            <div className="pixel-box-dark p-8 mb-6">
                                <div className="text-6xl mb-4">{user.avatar}</div>
                                <div className="text-2xl text-yellow-400">{user.name}</div>
                                <div className="mt-4 text-xs text-green-400 border border-green-400 px-2 py-1 inline-block">READY</div>
                            </div>
                            {gameStatus.winnerName && <div className="pixel-box p-4 bg-gray-200"><p className="text-[10px] text-gray-500 mb-1">LAST WINNER</p><div className="text-xl text-black">{gameStatus.winnerName}</div></div>}
                        </div>
                    )}
                </div>
            );
        };

        // --- 3. Host App ---
        const HostApp = ({ room, initialPlayers }) => {
            const [allPlayers, setAllPlayers] = useState(initialPlayers || []);
            const [isDrawing, setIsDrawing] = useState(false);
            const [gameMode, setGameMode] = useState('slot'); 
            const [targetCount, setTargetCount] = useState(1);
            
            // éŠæˆ²ç‹€æ…‹
            const [displayState, setDisplayState] = useState({ 
                text: "READY", 
                subText: "WAITING...", 
                winner: null,
                rolling: false
            });

            const { emit } = useSocket(room, (evt, data) => {
                if(evt === 'player_list_update') setAllPlayers(data);
                if(evt === 'init_data' && data.players) setAllPlayers(data.players);
                if(evt === 'game_reset') { setAllPlayers([]); setIsDrawing(false); }
            });

            // éŠæˆ²æ¨¡å¼åˆ—è¡¨ (Pixel ç‰ˆ)
            const MODES = [
                { id: 'slot', name: 'æ‹‰éœ¸æ©Ÿ' },
                { id: 'race', name: 'è³½é¦¬' },
                { id: 'meteor', name: 'æµæ˜Ÿ' },
                { id: 'card', name: 'ç¿»ç‰Œ' }
            ];

            // æŠ½çé‚è¼¯
            const startDraw = async () => {
                const available = allPlayers.filter(p => !p.hasWon); // éœ€åœ¨å¾Œç«¯æˆ–å‰ç«¯æ¨™è¨˜å·²ä¸­çï¼Œé€™è£¡ç°¡åŒ–
                // é€™è£¡ç°¡å–®éš¨æ©Ÿå–æ¨£ï¼Œä¸ä¿®æ”¹åŸå§‹é™£åˆ—ä»¥å…è¤‡é›œåŒ–ï¼Œå¯¦éš›æ‡‰è¨˜éŒ„ winners
                if (allPlayers.length === 0) return alert("NO PLAYERS");
                
                setIsDrawing(true);
                emit('update_game_status', { status: { status: 'playing' } });

                // éš¨æ©Ÿåˆ‡æ›æ¨¡å¼
                const nextMode = MODES[Math.floor(Math.random() * MODES.length)].id;
                setGameMode(nextMode);

                // æ¨¡æ“¬æŠ½çéç¨‹
                const duration = nextMode === 'race' ? 8000 : 5000;
                
                setDisplayState(prev => ({ ...prev, rolling: true, winner: null }));

                // å»¶é²å‡ºçµæœ
                setTimeout(() => {
                    const winner = allPlayers[Math.floor(Math.random() * allPlayers.length)];
                    setDisplayState({ rolling: false, winner: winner, text: winner.name });
                    setIsDrawing(false);
                    
                    emit('update_game_status', { 
                        status: { status: 'result', winnerName: winner.name, winnerId: winner.id } 
                    });
                    
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }, duration);
            };

            const resetGame = () => {
                if(confirm("RESET SYSTEM?")) emit('reset_game', {});
            };

            // --- è¦–è¦ºå‘ˆç¾ (Visuals) ---
            const Visuals = () => {
                const { rolling, winner } = displayState;
                
                // 1. æ‹‰éœ¸æ©Ÿ
                if (gameMode === 'slot') {
                    return (
                        <div className="flex justify-center gap-4">
                            {[0,1,2].map(i => (
                                <div key={i} className="pixel-box p-4 w-32 h-48 flex items-center justify-center bg-gray-200">
                                    {rolling ? 
                                        <div className="text-4xl animate-bounce">â“</div> : 
                                        <div className="text-center animate__animated animate__flash">
                                            <div className="text-4xl mb-2">{winner?.avatar || 'ğŸ’'}</div>
                                            <div className="text-xs truncate max-w-[80px]">{winner ? (i===1 ? winner.name : winner.avatar) : '7'}</div>
                                        </div>
                                    }
                                </div>
                            ))}
                        </div>
                    );
                }

                // 2. è³½é¦¬
                if (gameMode === 'race') {
                    return (
                        <div className="w-full max-w-4xl bg-green-800 border-4 border-white p-4 relative overflow-hidden">
                            {/* è·‘é“ç·š */}
                            <div className="absolute right-10 top-0 bottom-0 w-2 bg-white z-0"></div>
                            {Array.from({length: 4}).map((_, i) => (
                                <div key={i} className="h-16 border-b-2 border-dashed border-white/30 relative flex items-center">
                                    <div className={`absolute text-4xl transition-all duration-[8000ms] ease-linear ${rolling ? 'left-[90%]' : 'left-2'}`} 
                                         style={{ 
                                             left: rolling ? (winner && i===1 ? '90%' : `${20 + Math.random()*60}%`) : (winner && i===1 ? '90%' : '10%'),
                                             transitionProperty: 'left',
                                             transitionDuration: rolling ? '8s' : '0.5s'
                                         }}>
                                        {winner && i===1 && !rolling ? winner.avatar : 'ğŸ'}
                                    </div>
                                    {winner && i===1 && !rolling && <div className="absolute right-0 text-white font-bold bg-black px-2">{winner.name}</div>}
                                </div>
                            ))}
                        </div>
                    );
                }

                // 3. æµæ˜Ÿ/å¡ç‰‡ (ç°¡åŒ–ç‚ºå¤§é ­åƒé¡¯ç¤º)
                return (
                    <div className="text-center">
                        {rolling ? (
                            <div className="text-yellow-400 text-2xl blink">SCANNING...</div>
                        ) : (
                            <div className="animate__animated animate__zoomIn">
                                <div className="pixel-box p-8 inline-block bg-yellow-400 text-black">
                                    <div className="text-9xl mb-4">{winner?.avatar}</div>
                                    <div className="text-4xl font-black">{winner?.name}</div>
                                </div>
                                <div className="mt-8 text-yellow-300 text-xl blink">WINNER!</div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="h-screen bg-gray-900 flex flex-col relative overflow-hidden">
                    {/* Header */}
                    <div className="absolute top-0 left-0 w-full p-4 flex justify-between z-20">
                        <div className="pixel-box px-4 py-2 bg-blue-600 text-white text-xs">P: {allPlayers.length}</div>
                        <div className="pixel-box px-4 py-2 bg-red-600 text-white text-xs">MODE: {gameMode.toUpperCase()}</div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 flex items-center justify-center p-8 bg-grid">
                        <Visuals />
                    </div>

                    {/* Controls */}
                    <div className="h-24 bg-gray-800 border-t-4 border-black flex items-center justify-center gap-6 p-4 z-30">
                        {!isDrawing && (
                            <div className="flex items-center gap-4 bg-black p-2 border-2 border-white">
                                <span className="text-xs text-gray-400">COUNT</span>
                                <button className="text-yellow-400 font-bold" onClick={()=>setTargetCount(Math.max(1,targetCount-1))}>-</button>
                                <span className="text-xl w-8 text-center">{targetCount}</span>
                                <button className="text-yellow-400 font-bold" onClick={()=>setTargetCount(Math.min(10,targetCount+1))}>+</button>
                            </div>
                        )}
                        <button 
                            onClick={startDraw} 
                            disabled={isDrawing || allPlayers.length === 0} 
                            className={`pixel-btn ${isDrawing ? 'bg-gray-600' : 'pixel-btn-red'} px-8 py-3 text-xl font-bold`}
                        >
                            {isDrawing ? 'ROLLING...' : 'START'}
                        </button>
                        {!isDrawing && <button onClick={resetGame} className="pixel-btn bg-gray-600 text-xs px-4 py-3">RESET</button>}
                    </div>
                </div>
            );
        };

        // --- App Entry ---
        const App = () => {
            const [mode, setMode] = useState('index');
            const [room, setRoom] = useState('');
            useEffect(() => {
                const p = new URLSearchParams(window.location.search);
                const m = p.get('mode'); const r = p.get('room');
                if (m === 'host' && r) { setMode('host'); setRoom(r); }
                else if (m === 'player' && r) { setMode('player'); setRoom(r); }
            }, []);
            const handleStartHost = (rid, ps) => {
                sessionStorage.setItem(`lottery_players_${rid}`, JSON.stringify(ps));
                window.location.href = `?mode=host&room=${rid}`;
            };
            return (
                <ErrorBoundary>
                    {mode === 'index' && <IndexPage onStartHost={handleStartHost} initialPlayers={[]} />}
                    {mode === 'host' && <HostApp room={room} initialPlayers={JSON.parse(sessionStorage.getItem(`lottery_players_${room}`) || '[]')} />}
                    {mode === 'player' && <PlayerApp room={room} />}
                </ErrorBoundary>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        removeLoading();
    </script>
</body>
</html>
