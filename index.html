<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Noto+Sans+TC:wght@400;900&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: "Noto Sans TC", sans-serif; background: #450a0a; color: white; }
        /* å…±ç”¨æ¨£å¼ */
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .gold-text { background: linear-gradient(to bottom, #fde68a, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 10px rgba(217, 119, 6, 0.5); }
        
        /* Player å°ˆç”¨ */
        .bg-rays { position: absolute; inset: -150%; background: repeating-conic-gradient(from 0deg, #b45309 0deg 10deg, transparent 10deg 20deg); opacity: 0.15; animation: rotate-slow 60s linear infinite; pointer-events: none; }
        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Host Themes */
        .theme-cyber { background: radial-gradient(circle, #1a1a2e, #16213e, #0f3460); color: #00ffea; }
        .theme-retro { background: radial-gradient(circle, #4a0404, #7f1d1d, #2c0b0e); color: #fcd34d; }
        .theme-space { background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e); color: #e0e7ff; }
        .theme-magic { background: radial-gradient(circle at center, #4c1d95, #2e1065, #000000); color: #d8b4fe; }
        .theme-festival { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: #be185d; }
        
        /* Animations */
        @keyframes floatUp { 0% { transform: translateY(110vh) scale(0.8); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-20vh) scale(1.1); opacity: 0; } }
        .bubble { position: absolute; animation: floatUp linear infinite; will-change: transform, opacity; bottom: -100px; }
        .neon-text { text-shadow: 0 0 10px rgba(0,255,234,0.7); font-family: 'Russo One', sans-serif; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wheel-container { transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }
        .card-flip { transform-style: preserve-3d; transition: transform 0.8s; }
        .card-flip.flipped { transform: rotateY(180deg); }
        .card-face { backface-visibility: hidden; position: absolute; inset: 0; }
        .card-back { transform: rotateY(180deg); }
        @keyframes impactShake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-10px, 10px); } 20%, 40%, 60%, 80% { transform: translate(10px, -10px); } }
        .animate-impact { animation: impactShake 0.5s ease-in-out; }
        @keyframes meteorDrop { 0% { transform: translate(100%, -100%) scale(0.5); opacity: 1; } 70% { transform: translate(0, 0) scale(1.5); opacity: 1; } 100% { transform: translate(-20%, 20%) scale(0.2); opacity: 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // MQTT è¨­å®š (ä½¿ç”¨ WebSocket)
        const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const AVATARS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ¦„"];

        // =================================================================
        //  1. è¿è³“å¤§å»³ (Index Page)
        // =================================================================
        const IndexPage = () => {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState([]);
            const [connected, setConnected] = useState(false);
            const [isLocalhost, setIsLocalhost] = useState(false);
            const clientRef = useRef(null);

            useEffect(() => {
                // æª¢æŸ¥æ˜¯å¦ç‚º localhost
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    setIsLocalhost(true);
                }

                // ç”¢ç”Ÿéš¨æ©Ÿæˆ¿é–“è™Ÿ (æˆ–æ²¿ç”¨ URL åƒæ•¸)
                const params = new URLSearchParams(window.location.search);
                let rid = params.get('room');
                if(!rid) rid = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomId(rid);

                // ç”Ÿæˆ Player é€£çµ
                const baseUrl = window.location.href.split('?')[0]; 
                const playerLink = `${baseUrl}?mode=player&room=${rid}`;
                QRCode.toDataURL(playerLink, { width: 400, margin: 1, color: { dark: '#7f1d1d', light: '#ffffff' } }, (err, url) => {
                    if(!err) setQrUrl(url);
                });

                // é€£æ¥ MQTT
                const client = mqtt.connect(MQTT_BROKER);
                clientRef.current = client;
                
                client.on('connect', () => {
                    setConnected(true);
                    client.subscribe(`tw_lottery/${rid}/join`);
                });
                
                client.on('offline', () => setConnected(false));

                client.on('message', (topic, message) => {
                    try {
                        const newPlayer = JSON.parse(message.toString());
                        setPlayers(prev => {
                            if (prev.some(p => p.id === newPlayer.id)) return prev;
                            return [...prev, newPlayer];
                        });
                    } catch (e) {}
                });

                return () => client.end();
            }, []);

            const PlayerBubble = ({ player }) => {
                const style = useMemo(() => ({
                    width: `${80 + Math.random() * 60}px`,
                    height: `${80 + Math.random() * 60}px`,
                    left: `${5 + Math.random() * 90}%`,
                    animationDuration: `${10 + Math.random() * 15}s`,
                    animationDelay: `${Math.random() * -15}s`,
                }), []);
                return (
                    <div className="bubble flex flex-col items-center justify-center bg-yellow-500/20 border border-yellow-300/40 rounded-full text-center shadow-lg backdrop-blur-sm z-0" style={style}>
                        <div className="text-3xl filter drop-shadow-md">{player.avatar}</div>
                        <div className="text-white font-bold text-sm mt-1 px-2 truncate w-full shadow-black drop-shadow-md">{player.name}</div>
                    </div>
                );
            };

            const startHost = () => {
                sessionStorage.setItem(`lottery_players_${roomId}`, JSON.stringify(players));
                window.location.href = `?mode=host&room=${roomId}`;
            };

            return (
                <div className="min-h-screen relative overflow-hidden font-sans" style={{background: 'linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%)'}}>
                    <div className="absolute top-4 left-4 z-20 flex gap-2">
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${connected ? 'bg-green-500 text-black' : 'bg-red-500 text-white'}`}>
                            {connected ? 'â— ä¼ºæœå™¨é€£ç·šæ­£å¸¸' : 'â— é€£ç·šä¸­...'}
                        </span>
                    </div>

                    <div className="absolute inset-0 pointer-events-none overflow-hidden">{players.map(p => <PlayerBubble key={p.id} player={p} />)}</div>
                    <div className="relative z-10 min-h-screen flex flex-col items-center justify-center p-6">
                        <div className="text-center mb-8 animate__animated animate__bounceIn">
                            <div className="inline-block bg-red-900/80 px-8 py-2 rounded-full border border-yellow-500/50 text-yellow-300 font-bold tracking-widest mb-6 shadow-xl backdrop-blur-md">æ­¡è¿è’è‡¨</div>
                            <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-600 drop-shadow-2xl tracking-tight mb-4">å®¶é˜²ä¸­å¿ƒå°¾ç‰™</h1>
                            <p className="text-red-100/90 text-xl font-light tracking-wider bg-black/20 inline-block px-4 py-1 rounded-lg backdrop-blur-sm">æƒæ QR Code ç«‹å³ç°½åˆ°</p>
                        </div>

                        {isLocalhost && (
                            <div className="bg-red-600 text-white px-6 py-3 rounded-xl mb-6 shadow-lg animate-pulse font-bold border-2 border-yellow-400">
                                âš ï¸ è­¦å‘Šï¼šè«‹å‹¿ä½¿ç”¨ localhostï¼æ‰‹æ©Ÿç„¡æ³•é€£ç·šã€‚<br/>
                                è«‹å°‡ç¶²å€æ”¹ç‚ºé›»è…¦ IP (ä¾‹å¦‚ 192.168.x.x)
                            </div>
                        )}

                        <div className="glass-panel p-8 rounded-[3rem] shadow-2xl flex flex-col items-center gap-6 max-w-sm w-full mx-auto transform hover:scale-105 transition-transform duration-500">
                            <div className="bg-white p-4 rounded-3xl shadow-inner">
                                {qrUrl ? <img src={qrUrl} alt="Scan" className="w-64 h-64 object-contain" /> : <div className="w-64 h-64 flex items-center justify-center text-red-300">Generating...</div>}
                            </div>
                            <div className="text-center">
                                <div className="text-yellow-400 font-black text-4xl mb-1">{players.length} äºº</div>
                                <div className="text-red-200 text-sm font-bold uppercase tracking-widest">å·²åŠ å…¥é€£ç·š</div>
                            </div>
                        </div>
                        <div className="absolute bottom-8 right-8">
                            <button onClick={startHost} className="group flex items-center gap-3 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-red-900 px-8 py-4 rounded-full font-black text-xl shadow-lg transition-all hover:scale-105">
                                <span>é€²å…¥å¤§è¢å¹•æŠ½ç</span><span className="text-2xl group-hover:translate-x-1 transition-transform">â†’</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================
        //  2. ç©å®¶ç«¯ (Player App)
        // =================================================================
        const PlayerApp = ({ room }) => {
            const [user, setUser] = useState(null);
            const [nameInput, setNameInput] = useState("");
            const [myAvatar, setMyAvatar] = useState(AVATARS[0]);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const [connected, setConnected] = useState(false);
            const clientRef = useRef(null);

            useEffect(() => {
                const savedUser = localStorage.getItem(`lottery_user_${room}`);
                if (savedUser) {
                    const u = JSON.parse(savedUser);
                    setUser(u);
                    setJoined(true);
                    connectMqtt(u, room);
                }
            }, [room]);

            const connectMqtt = (u, rid) => {
                const client = mqtt.connect(MQTT_BROKER);
                clientRef.current = client;
                client.on('connect', () => {
                    setConnected(true);
                    // åˆå§‹ç™¼é€
                    client.publish(`tw_lottery/${rid}/join`, JSON.stringify(u));
                    client.subscribe(`tw_lottery/${rid}/status`);
                    
                    // å¿ƒè·³æ©Ÿåˆ¶ï¼šæ¯3ç§’é‡é€ä¸€æ¬¡ joinï¼Œç¢ºä¿å‰›é€²å…¥å¤§è¢å¹•ä¹Ÿèƒ½æ”¶åˆ°
                    // é€™æ˜¯ä¸€å€‹ç°¡å–®çš„é˜²å‘†æ©Ÿåˆ¶
                    const heartbeat = setInterval(() => {
                        client.publish(`tw_lottery/${rid}/join`, JSON.stringify(u));
                    }, 3000);
                    client.heartbeat = heartbeat; // æš«å­˜ä»¥ä¾¿æ¸…é™¤
                });
                
                client.on('offline', () => setConnected(false));
                client.on('message', (t, m) => setGameStatus(JSON.parse(m.toString())));
            };

            const handleJoin = () => {
                if (!nameInput.trim()) return;
                const newUser = { id: Date.now() + Math.random().toString().slice(2), name: nameInput.trim(), avatar: myAvatar };
                setUser(newUser);
                setJoined(true);
                localStorage.setItem(`lottery_user_${room}`, JSON.stringify(newUser));
                connectMqtt(newUser, room);
            };

            const logout = () => {
                if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                    localStorage.removeItem(`lottery_user_${room}`);
                    setJoined(false);
                    setNameInput("");
                    if (clientRef.current && clientRef.current.heartbeat) clearInterval(clientRef.current.heartbeat);
                }
            };

            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;

            // ä¸­çç‰¹æ•ˆ
            useEffect(() => {
                if (isWinner) {
                    const end = Date.now() + 5000;
                    const frame = () => {
                        confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#FFD700'] });
                        confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#FFD700'] });
                        if (Date.now() < end && isWinner) requestAnimationFrame(frame);
                    };
                    frame();
                }
            }, [isWinner]);

            if (isWinner) return (
                <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-b from-red-900 to-black">
                    <div className="bg-rays"></div>
                    <div className="relative z-10 text-center p-6 animate__animated animate__zoomInDown">
                        <div className="text-[10rem] mb-4 animate__animated animate__tada animate__infinite">ğŸ†</div>
                        <h1 className="text-5xl font-black text-yellow-400 drop-shadow-xl mb-4">æ­å–œä¸­çï¼</h1>
                        <p className="text-xl text-white">æœ¬å›åˆçš„å¹¸é‹å…’å°±æ˜¯ä½ </p>
                        <div className="mt-8 glass-panel p-6 rounded-2xl flex flex-col items-center gap-4">
                            <div className="text-6xl">{user.avatar}</div>
                            <div className="text-3xl font-bold text-white">{user.name}</div>
                            <div className="bg-red-600 px-6 py-2 rounded-full font-bold animate-pulse">è«‹å‰å¾€å°å‰é ˜ç</div>
                        </div>
                    </div>
                </div>
            );

            if (!joined) return (
                <div className="min-h-screen bg-gradient-to-br from-red-900 to-black p-6 flex flex-col justify-center">
                    <div className="w-full max-w-md mx-auto space-y-8 animate__animated animate__fadeIn">
                        <div className="text-center"><h1 className="text-4xl font-black text-yellow-400">JOIN PARTY</h1><p className="text-red-200">è¼¸å…¥æš±ç¨±ï¼ŒåŠ å…¥ç››å…¸</p></div>
                        <div className="glass-panel rounded-3xl p-6 space-y-6">
                            <div className="grid grid-cols-4 gap-3">{AVATARS.slice(0, 12).map(a => <button key={a} onClick={() => setMyAvatar(a)} className={`text-3xl rounded-xl p-2 ${myAvatar === a ? 'bg-red-800 border-2 border-yellow-400' : 'bg-white/10'}`}>{a}</button>)}</div>
                            <input type="text" className="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-center text-xl text-white outline-none focus:border-yellow-400" placeholder="ä¾‹å¦‚: å°æ˜" value={nameInput} onChange={e => setNameInput(e.target.value)} />
                            <button onClick={handleJoin} className="w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-red-900 py-4 rounded-xl text-xl font-black shadow-lg">ğŸš€ ç«‹å³åŠ å…¥</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gradient-to-b from-red-900 to-black text-white flex flex-col items-center justify-center p-8 text-center relative overflow-hidden">
                    <div className="absolute top-4 right-4 text-xs">
                        <span className={connected ? 'text-green-400' : 'text-red-400'}>â— {connected ? 'é€£ç·šæ­£å¸¸' : 'é€£ç·šä¸­...'}</span>
                    </div>
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    
                    {gameStatus.status === 'playing' ? (
                        <div className="space-y-8 animate__animated animate__pulse animate__infinite relative z-10">
                            <div className="text-[8rem] animate-spin">ğŸ²</div>
                            <div className="text-3xl font-black text-yellow-400">æŠ½çé€²è¡Œä¸­...</div>
                            <div className="text-red-200">ç¬¬ {gameStatus.round} å›åˆ</div>
                        </div>
                    ) : (
                        <div className="w-full space-y-8 animate__animated animate__fadeIn relative z-10">
                            <div className="relative group"><div className="w-40 h-40 mx-auto bg-red-800 rounded-full flex items-center justify-center text-7xl border-4 border-yellow-500 shadow-2xl">{user.avatar}</div></div>
                            <div><h2 className="text-5xl font-black mb-3">{user.name}</h2><div className="inline-flex items-center px-5 py-2 rounded-full bg-green-900/50 text-green-400 border border-green-500/30">â— å·²é€£ç·š Ready</div></div>
                            {gameStatus.winnerName && <div className="glass-panel p-6 rounded-2xl animate__animated animate__fadeInUp"><p className="text-yellow-500 text-xs mb-2">ä¸Šå›åˆå¾—ä¸»</p><div className="text-3xl font-black">{gameStatus.winnerName}</div></div>}
                            <div className="text-red-300/50">ç­‰å¾…ä¸»æŒäººé–‹å§‹...</div>
                        </div>
                    )}
                    <button onClick={logout} className="absolute bottom-6 text-white/30 text-sm underline z-20">ç™»å‡º</button>
                </div>
            );
        };

        // =================================================================
        //  3. å¤§è¢å¹•ç«¯ (Host App)
        // =================================================================
        const HostApp = ({ room }) => {
            const [allPlayers, setAllPlayers] = useState([]);
            const [winners, setWinners] = useState([]); 
            const [currentRound, setCurrentRound] = useState(0); 
            const [isDrawing, setIsDrawing] = useState(false); 
            const [drawQueue, setDrawQueue] = useState([]); 
            const [currentDisplayWinner, setCurrentDisplayWinner] = useState(null); 
            const [currentDisplayWinnerObj, setCurrentDisplayWinnerObj] = useState(null); 
            const [isVisualRolling, setIsVisualRolling] = useState(false); 
            const [targetCount, setTargetCount] = useState(1);
            const [gameMode, setGameMode] = useState('cyber'); 
            const [showWinnerModal, setShowWinnerModal] = useState(false);
            const [modalWinner, setModalWinner] = useState(null);
            const [connected, setConnected] = useState(false);
            
            const clientRef = useRef(null);

            // --- è¦–è¦ºçµ„ä»¶ ---
            const VisualComponent = ({ candidates, targetName, isRolling, mode, winnerObj }) => {
                const [display, setDisplay] = useState("READY");
                
                useEffect(() => {
                    if (isRolling) {
                        const t = setInterval(() => setDisplay(candidates[Math.floor(Math.random()*candidates.length)]?.name || "..."), 50);
                        return () => clearInterval(t);
                    } else if (targetName) setDisplay(targetName);
                }, [isRolling, targetName, candidates]);

                // é‡å°ç‰¹å®šæ¨¡å¼çš„ç°¡å–®æ¸²æŸ“
                if (mode === 'slots') return (
                    <div className="flex justify-center gap-4">
                        {[0,1,2].map(i => <div key={i} className="bg-white h-64 w-48 rounded-xl flex items-center justify-center border-4 border-gray-800 relative overflow-hidden"><div className={`text-6xl font-black text-gray-800 ${isRolling ? 'blur-sm animate-pulse' : 'scale-110'}`}>{isRolling ? display : (winnerObj?.name || targetName)}</div></div>)}
                    </div>
                );
                
                if (mode === 'meteor') return (
                    <div className={`flex flex-col items-center justify-center h-full relative overflow-hidden ${isRolling ? '' : 'animate-impact'}`}>
                        {isRolling && <div className="absolute inset-0 flex justify-center items-center"><div className="text-4xl text-white/50 animate-pulse">æµæ˜Ÿè¨±é¡˜ä¸­...</div></div>}
                        {!isRolling && targetName && <div className="z-20 text-center animate__animated animate__zoomIn"><div className="text-[120px] mb-2">â˜„ï¸</div><div className="text-8xl font-black text-white drop-shadow-2xl">{targetName}</div></div>}
                    </div>
                );

                return (
                    <div className="flex flex-col items-center justify-center">
                        <div className={`text-9xl font-black neon-text transition-all duration-300 ${isRolling ? 'opacity-80 blur-sm' : 'opacity-100 scale-125 text-yellow-400'}`}>{display}</div>
                        {mode === 'radar' && isRolling && <div className="text-green-400 mt-4 tracking-widest animate-pulse">SCANNING...</div>}
                    </div>
                );
            };

            const GAME_MODES = [
                { id: 'cyber', name: 'çŸ©é™£æ»¾å‹•', theme: 'theme-cyber' },
                { id: 'retro', name: 'å¹¸é‹è½‰ç›¤', theme: 'theme-retro' },
                { id: 'magic', name: 'å‘½é‹å¡”ç¾…', theme: 'theme-magic' },
                { id: 'space', name: 'é›·é”é–å®š', theme: 'theme-space' },
                { id: 'vegas', name: 'é»ƒé‡‘æ‹‰éœ¸', theme: 'theme-retro' },
                { id: 'meteor', name: 'æµæ˜Ÿé™è‡¨', theme: 'theme-space' },
                { id: 'gasha', name: 'æ­¡æ¨‚æ‰­è›‹', theme: 'theme-festival' },
                { id: 'battle', name: 'ç”Ÿå­˜æ·˜æ±°', theme: 'theme-cyber' },
            ];
            const [unusedModes, setUnusedModes] = useState([...GAME_MODES.map(m => m.id)]);

            useEffect(() => {
                const storedPlayers = sessionStorage.getItem(`lottery_players_${room}`);
                if (storedPlayers) setAllPlayers(JSON.parse(storedPlayers));

                const client = mqtt.connect(MQTT_BROKER);
                clientRef.current = client;
                client.on('connect', () => {
                    setConnected(true);
                    client.subscribe(`tw_lottery/${room}/join`);
                });
                client.on('offline', () => setConnected(false));
                
                client.on('message', (t, m) => {
                    if (t.endsWith('/join')) {
                        const p = JSON.parse(m.toString());
                        setAllPlayers(prev => {
                            if (prev.some(x => x.id === p.id)) return prev;
                            const list = [...prev, p];
                            sessionStorage.setItem(`lottery_players_${room}`, JSON.stringify(list));
                            return list;
                        });
                    }
                });
                return () => client.end();
            }, [room]);

            const availablePlayers = useMemo(() => {
                const ids = new Set(winners.map(w => w.id));
                return allPlayers.filter(p => !ids.has(p.id));
            }, [allPlayers, winners]);

            const startDraw = async () => {
                if(availablePlayers.length < targetCount) { alert("äººæ•¸ä¸è¶³"); return; }
                
                let nextModes = [...unusedModes];
                if(nextModes.length === 0) nextModes = GAME_MODES.map(m=>m.id);
                const rIdx = Math.floor(Math.random()*nextModes.length);
                const mode = nextModes[rIdx];
                nextModes.splice(rIdx, 1);
                setUnusedModes(nextModes);
                setGameMode(mode);

                setIsDrawing(true);
                const nextRound = currentRound + 1;
                setCurrentRound(nextRound);

                const pool = [...availablePlayers];
                const roundWinners = [];
                for(let i=0; i<targetCount; i++){
                    const idx = Math.floor(Math.random()*pool.length);
                    roundWinners.push(pool[idx]);
                    pool.splice(idx,1);
                }
                setWinners(prev => [...prev, ...roundWinners]);
                
                if(clientRef.current) clientRef.current.publish(`tw_lottery/${room}/status`, JSON.stringify({status:'playing', round: nextRound}));

                await processQueue(roundWinners);
            };

            const processQueue = async (queue) => {
                await new Promise(r => setTimeout(r, 500));
                for(let i=0; i<queue.length; i++) {
                    const w = queue[i];
                    setIsVisualRolling(true);
                    setCurrentDisplayWinner(null);
                    setShowWinnerModal(false);
                    
                    await new Promise(r => setTimeout(r, 3500)); 
                    
                    setIsVisualRolling(false);
                    setCurrentDisplayWinner(w.name);
                    setCurrentDisplayWinnerObj(w);
                    
                    await new Promise(r => setTimeout(r, 1500)); 
                    
                    setModalWinner(w);
                    setShowWinnerModal(true);
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    if('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(`æ­å–œ ${w.name} ä¸­ç`);
                        u.lang = 'zh-TW';
                        window.speechSynthesis.speak(u);
                    }

                    await new Promise(r => setTimeout(r, 3000));
                    setShowWinnerModal(false);

                    if(clientRef.current) clientRef.current.publish(`tw_lottery/${room}/status`, JSON.stringify({status:'result', round: currentRound+1, winnerName: w.name, winnerId: w.id}));
                    
                    await new Promise(r => setTimeout(r, 500));
                }
                setIsDrawing(false);
            };

            const currentConfig = GAME_MODES.find(m => m.id === gameMode) || GAME_MODES[0];

            return (
                <div className={`h-screen flex flex-col relative overflow-hidden font-sans transition-colors duration-1000 ${currentConfig.theme}`}>
                    {/* Winner Modal */}
                    {showWinnerModal && modalWinner && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md animate__animated animate__fadeIn">
                            <div className="bg-red-900 border-4 border-yellow-500 rounded-[3rem] p-12 text-center animate__animated animate__zoomInDown shadow-[0_0_100px_rgba(255,215,0,0.5)]">
                                <div className="text-yellow-300 font-bold text-3xl mb-4 tracking-widest uppercase">Congratulations</div>
                                <div className="text-9xl mb-6 animate__animated animate__bounce infinite">{modalWinner.avatar}</div>
                                <div className="text-7xl font-black text-white drop-shadow-xl mb-4">{modalWinner.name}</div>
                                <div className="bg-yellow-500 text-red-900 px-8 py-2 rounded-full text-xl font-bold inline-block">æ­å–œä¸­ç</div>
                            </div>
                        </div>
                    )}

                    <div className="absolute top-0 left-0 w-full p-6 flex justify-between z-20 pointer-events-none">
                        <div className="glass-panel px-8 py-3 rounded-full shadow-lg flex gap-4 items-center">
                            <span className="font-bold text-2xl mr-2">{currentRound === 0 ? "æº–å‚™é–‹å§‹" : `ç¬¬ ${currentRound} å›åˆ`}</span>
                            {isDrawing && <span className="bg-red-600 text-white text-xs px-2 py-1 rounded animate-pulse">LIVE - {currentConfig.name}</span>}
                        </div>
                        <div className="flex gap-2">
                            <span className={`px-3 py-1 rounded-full text-xs font-bold self-center ${connected ? 'bg-green-500 text-black' : 'bg-red-500 text-white'}`}>{connected ? 'Online' : 'Offline'}</span>
                            <div className="glass-panel px-6 py-3 rounded-full text-white/80 font-mono">äººæ•¸: {allPlayers.length}</div>
                        </div>
                    </div>

                    <div className="flex-1 relative z-10 flex items-center justify-center p-8">
                        {allPlayers.length === 0 ? (
                            <div className="text-center animate__animated animate__fadeIn">
                                <div className="text-4xl opacity-50 mb-4 font-bold">ç­‰å¾…ç©å®¶åŠ å…¥...</div>
                            </div>
                        ) : (
                            <VisualComponent candidates={availablePlayers.concat(drawQueue)} targetName={currentDisplayWinner} isRolling={isVisualRolling} mode={gameMode} winnerObj={currentDisplayWinnerObj} />
                        )}
                    </div>

                    <div className="absolute bottom-0 w-full p-10 flex flex-col items-center justify-center z-30 pointer-events-none bg-gradient-to-t from-black/80 to-transparent">
                        {!isDrawing && (
                            <div className="flex items-center gap-4 mb-6 bg-black/40 backdrop-blur-md px-6 py-2 rounded-full border border-white/10 pointer-events-auto">
                                <span className="text-sm font-bold opacity-70">æœ¬è¼ªæŠ½å‡º</span>
                                <button onClick={() => setTargetCount(Math.max(1, targetCount-1))} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20">-</button>
                                <span className="text-2xl font-black w-8 text-center">{targetCount}</span>
                                <button onClick={() => setTargetCount(Math.min(availablePlayers.length, targetCount+1))} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20">+</button>
                                <span className="text-sm opacity-50 ml-2">äºº (å‰©é¤˜ {availablePlayers.length})</span>
                            </div>
                        )}
                        <button onClick={startDraw} disabled={isDrawing || availablePlayers.length === 0} className={`pointer-events-auto px-16 py-5 rounded-full font-black text-3xl shadow-2xl transition-all transform flex items-center gap-4 border-4 ${isDrawing ? 'bg-gray-800 text-gray-500 border-gray-700 cursor-not-allowed scale-95' : 'bg-gradient-to-r from-yellow-400 to-orange-500 text-red-900 border-yellow-300 hover:scale-105'}`}>
                            {isDrawing ? <><span className="animate-spin">ğŸ²</span> æŠ½çä¸­...</> : <>{availablePlayers.length === 0 ? "æ´»å‹•çµæŸ" : "ğŸš€ é–‹å§‹æŠ½ç"}</>}
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('index');
            const [room, setRoom] = useState('');

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const modeParam = params.get('mode');
                const roomParam = params.get('room');
                if (modeParam === 'host' && roomParam) { setMode('host'); setRoom(roomParam); }
                else if (modeParam === 'player' && roomParam) { setMode('player'); setRoom(roomParam); }
                else setMode('index');
            }, []);

            return (
                <>
                    {mode === 'index' && <IndexPage />}
                    {mode === 'host' && <HostApp room={room} />}
                    {mode === 'player' && <PlayerApp room={room} />}
                </>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>