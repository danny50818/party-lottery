<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸ (Sound FX Edition)</title>

    <!-- 1. éŒ¯èª¤æ””æˆª -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg);
            return false;
        };
    </script>

    <!-- CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        /* å­—é«”è¨­å®šï¼šå…¨åŸŸå¾®è»Ÿæ­£é»‘é«” */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #1a0000;
            color: #fff;
            font-weight: bold;
            image-rendering: pixelated;
        }

        /* UI å…ƒä»¶ */
        .pixel-box { background: #fff; border: 4px solid #000; color: #000; box-shadow: -4px 0 0 0 #000, 4px 0 0 0 #000, 0 -4px 0 0 #000, 0 4px 0 0 #000; }
        .pixel-box-dark { background: #000; border: 4px solid #fff; color: #fff; box-shadow: -4px 0 0 0 #fff, 4px 0 0 0 #fff, 0 -4px 0 0 #fff, 0 4px 0 0 #fff; }
        .pixel-btn { 
            border: 4px solid rgba(0,0,0,0.4); 
            cursor: pointer; transition: transform 0.1s; 
            box-shadow: inset -4px -4px 0 rgba(0,0,0,0.3); 
            font-family: "Microsoft JhengHei", sans-serif !important;
        }
        .pixel-btn:active { transform: translateY(4px); }
        .pixel-btn-yellow { background: #facc15; border-color: #854d0e; color: black; text-shadow: none; }

        /* --- 3D ç´…è‰²æµå‹•èƒŒæ™¯ --- */
        .retro-wrapper {
            position: fixed; inset: 0; z-index: -10;
            background: radial-gradient(circle at center, #500000 0%, #1a0000 100%);
            perspective: 800px; overflow: hidden;
        }
        .retro-grid-plane {
            position: absolute; bottom: -30%; left: -50%; width: 200%; height: 150%;
            background-image: 
                linear-gradient(rgba(255, 30, 30, 0.5) 2px, transparent 2px), 
                linear-gradient(90deg, rgba(255, 30, 30, 0.5) 2px, transparent 2px);
            background-size: 80px 80px;
            transform: rotateX(70deg);
            animation: grid-move 2s linear infinite;
            box-shadow: 0 0 150px rgba(255, 0, 0, 0.5);
        }
        .retro-horizon {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #110000 20%, transparent 60%);
            z-index: -5; pointer-events: none;
        }
        @keyframes grid-move { 0% { background-position: 0 0; } 100% { background-position: 0 80px; } }

        /* --- éŠæˆ²å‹•ç•« Keyframes --- */
        
        /* è³½é¦¬ */
        @keyframes horse-gallop { 0% { transform: translateY(0); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0); } }
        .horse-sprite { animation: horse-gallop 0.15s steps(2) infinite; display: inline-block; }

        /* æ‹‰éœ¸ */
        @keyframes reel-move { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        .reel-blur { 
            background: repeating-linear-gradient(180deg, #fff 0, #ccc 50%, #fff 100%);
            background-size: 100% 20px;
            animation: reel-move 0.1s linear infinite;
            filter: blur(2px);
            color: transparent;
        }

        /* ç‘ªåˆ©æ­å‹•ç•« */
        @keyframes mario-phase1 { 0% { left: -10%; transform: scaleX(1); } 100% { left: 110%; transform: scaleX(1); } }
        @keyframes mario-phase2 { 0% { left: 110%; transform: scaleX(-1); } 100% { left: 50%; transform: scaleX(-1); } }
        @keyframes mario-jump-up { 0% { bottom: 20px; } 50% { bottom: 250px; } 100% { bottom: 20px; } }
        .mario-p1 { animation: mario-phase1 2.5s linear forwards; }
        .mario-p2 { animation: mario-phase2 1.5s linear forwards; }
        .mario-jump-anim { animation: mario-jump-up 0.5s ease-out forwards; }
        @keyframes block-bump { 0% { transform: translateY(0); } 50% { transform: translateY(-30px); } 100% { transform: translateY(0); } }
        .block-bump-anim { animation: block-bump 0.3s ease-out; }

        /* å°„ç®­ */
        @keyframes arrow-fly-in { 0% { left: -50vw; } 100% { left: calc(50% - 140px); } } 
        .arrow-anim { animation: arrow-fly-in 0.6s ease-out forwards; }
        @keyframes target-shake { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2) rotate(10deg); } }
        .target-hit { animation: target-shake 0.5s ease-in-out; }

        /* æµæ˜Ÿé›¨ */
        @keyframes meteor-cross { 
            0% { transform: translate(100vw, -100vh) scale(0.5); opacity: 1; } 
            100% { transform: translate(-100vw, 100vh) scale(1); opacity: 0; } 
        }
        .meteor-shower-item { position: absolute; top: 0; right: 0; animation: meteor-cross 2s linear infinite; }
        @keyframes meteor-center-crash { 0% { transform: translate(100vw, -100vh) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 1; top: 50%; left: 50%; } }
        .meteor-final { position: absolute; top: 0; right: 0; animation: meteor-center-crash 0.8s ease-in forwards; }

        /* å¡”ç¾…ç‰Œ */
        .card-container { perspective: 1000px; }
        .card-inner { width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 4px solid #facc15; }
        .card-front { background: #4c1d95; transform: rotateY(0deg); }
        .card-back { background: #fff; transform: rotateY(180deg); color: #000; }
        .flipped .card-inner { transform: rotateY(180deg); }

        /* è½‰ç›¤ */
        @keyframes wheel-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wheel-spinning { animation: wheel-spin 0.3s linear infinite; }

        /* ç‰¹æ•ˆæ°£æ³¡ */
        @keyframes floatUp { 0% { transform: translateY(110vh) scale(0.8); opacity: 0; } 20% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-20vh) scale(1.1); opacity: 0; } }
        .bubble { position: absolute; bottom: -100px; animation: floatUp linear infinite; }
        @keyframes love-float { 0% { transform: translateY(100%) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-200%) scale(1.5); opacity: 0; } }
        .love-particle { position: absolute; animation: love-float 4s ease-out forwards; bottom: 0; font-size: 2rem; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <div class="retro-wrapper">
        <div class="retro-horizon"></div>
        <div class="retro-grid-plane"></div>
    </div>

    <div id="loading-screen">
        <div class="pixel-spinner mb-8"></div>
        <div class="text-yellow-400 text-xl font-bold">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;
        const { createRoot } = ReactDOM;
        
        const AVATARS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ¦„"];
        const removeLoading = () => { const el = document.getElementById('loading-screen'); if(el) { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 500); }};

        // --- éŸ³æ•ˆå¼•æ“ ---
        const AudioManager = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTension: function() {
                this.init();
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(600, now + 4);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 4);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(now + 4);
            },
            playWin: function() {
                this.init();
                const now = this.ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = f;
                    gain.gain.setValueAtTime(0.1, now + i*0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.6);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now + i*0.1);
                    osc.stop(now + i*0.1 + 0.6);
                });
            },
            speak: function(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.lang = 'zh-TW';
                    window.speechSynthesis.speak(utter);
                }
            }
        };

        // --- Socket Hook ---
        const useSocket = (roomId, onEvent) => {
            const socketRef = useRef(null);
            const [status, setStatus] = useState('connecting');
            useEffect(() => {
                if(!roomId) return;
                const socket = io({ reconnectionAttempts: 5, timeout: 10000 }); 
                socketRef.current = socket;
                socket.on('connect', () => { setStatus('connected'); socket.emit('join_room', roomId); removeLoading(); });
                socket.on('disconnect', () => setStatus('disconnected'));
                socket.on('player_list_update', (d) => onEvent('player_list_update', d));
                socket.on('game_status_update', (d) => onEvent('game_status_update', d));
                socket.on('init_data', (d) => onEvent('init_data', d));
                socket.on('game_reset', (d) => onEvent('game_reset', d));
                return () => socket.disconnect();
            }, [roomId]);
            const emit = (e, d) => { if(socketRef.current) socketRef.current.emit(e, { roomId, ...d }); };
            return { status, emit };
        };

        // --- è¦–è¦ºçµ„ä»¶ (10ç¨®æ¨¡å¼) ---
        const VisualComponent = ({ candidates, targetName, isRolling, mode, winnerObj }) => {
            const [display, setDisplay] = useState("READY");
            const [horses, setHorses] = useState([]);
            const [slotStops, setSlotStops] = useState([false, false, false]);
            const [marioPhase, setMarioPhase] = useState(0); 
            const [shooter, setShooter] = useState({x: 50, laser: false, boom: false});
            const [archery, setArchery] = useState({shoot: false, hit: false});
            const [meteorStage, setMeteorStage] = useState(0); 
            const [cardFlipState, setCardFlipState] = useState([0,0,0]);
            const [radarDot, setRadarDot] = useState(false);
            const [soccer, setSoccer] = useState({kick: false, goal: false});
            const [bomb, setBomb] = useState({size: 1, boom: false});
            const [wheelSpin, setWheelSpin] = useState(true);

            useEffect(() => {
                let interval;
                if (isRolling) {
                    setMarioPhase(1);
                    setSlotStops([false, false, false]);
                    setShooter({x: 50, laser: false, boom: false}); 
                    setArchery({shoot: false, hit: false});
                    setMeteorStage(0);
                    setCardFlipState([0,0,0]);
                    setRadarDot(false);
                    setSoccer({kick: false, goal: false});
                    setBomb({size: 1, boom: false});
                    setWheelSpin(true);

                    if (mode === 'race') {
                        const racers = candidates.slice(0, 5).map(p => ({...p, progress: 0}));
                        while(racers.length < 5) racers.push({name:'CPU', avatar:'ğŸ', progress:0});
                        setHorses(racers);
                        interval = setInterval(() => { setHorses(prev => prev.map(h => ({...h, progress: Math.min(88, h.progress + Math.random() * 2)}))); }, 100);
                    } 
                    else if (mode === 'shooter') {
                        interval = setInterval(() => { setShooter(prev => ({...prev, x: (prev.x + 1) % 80 + 10})); }, 50);
                    }
                    else if (mode === 'bomb') {
                        interval = setInterval(() => setBomb(prev => ({...prev, size: Math.min(8, prev.size + 0.05)})), 100);
                    }
                    else if (mode === 'radar') {
                        setTimeout(() => setRadarDot(true), 2000);
                    }
                    else if (!['slots', 'retro', 'magic', 'adventure', 'meteor'].includes(mode)) {
                        interval = setInterval(() => { setDisplay(`P-${Math.floor(Math.random() * 100)}`); }, 100);
                    }
                } 
                else if (targetName) {
                    setDisplay(targetName);
                    if (mode === 'race' && winnerObj) setHorses(prev => prev.map(h => h.name === winnerObj.name ? {...h, progress: 98} : h));
                    if (mode === 'slots') {
                        setTimeout(() => setSlotStops([true, false, false]), 500);
                        setTimeout(() => setSlotStops([true, true, false]), 1500);
                        setTimeout(() => setSlotStops([true, true, true]), 2500);
                    }
                    if (mode === 'adventure') {
                        setMarioPhase(2); 
                        setTimeout(() => setMarioPhase(3), 1500); 
                        setTimeout(() => setMarioPhase(4), 1600); 
                    }
                    if (mode === 'shooter') {
                        setShooter(prev => ({...prev, x: 50, laser: true}));
                        setTimeout(() => setShooter(prev => ({...prev, boom: true})), 600);
                    }
                    if (mode === 'archery') {
                        setArchery({shoot: true, hit: false});
                        setTimeout(() => setArchery(prev => ({...prev, hit: true})), 800);
                    }
                    if (mode === 'meteor') {
                        setMeteorStage(1);
                        setTimeout(() => setMeteorStage(2), 1000);
                    }
                    if (mode === 'magic') {
                        setTimeout(() => setCardFlipState([1, 0, 0]), 500);
                        setTimeout(() => setCardFlipState([1, 1, 0]), 1500);
                        setTimeout(() => setCardFlipState([1, 1, 2]), 2500);
                    }
                    if (mode === 'soccer') {
                        setSoccer({kick: true, goal: false});
                        setTimeout(() => setSoccer(prev => ({...prev, goal: true})), 1200);
                    }
                    if (mode === 'bomb') {
                        setBomb(prev => ({...prev, size: 10}));
                        setTimeout(() => setBomb(prev => ({...prev, boom: true})), 500);
                    }
                    if (mode === 'retro') setWheelSpin(false);
                }
                return () => clearInterval(interval);
            }, [isRolling, targetName, mode, winnerObj, candidates]);

            // éŠæˆ²è¦–è¦ºç´°ç¯€
            if (mode === 'adventure') return (
                <div className="w-full h-full relative flex flex-col justify-end pb-20">
                     <div className="absolute top-[30%] left-1/2 -translate-x-1/2 flex gap-4">
                         <div className={`w-24 h-24 bg-yellow-600 border-4 border-black flex items-center justify-center text-white font-bold text-5xl ${marioPhase===4?'block-bump-anim':''}`}>?</div>
                     </div>
                     <div className="h-2 bg-red-900 w-full relative z-10"></div>
                     <div className={`absolute bottom-[20px] text-9xl ${marioPhase===1 ? 'mario-p1' : ''} ${marioPhase===2 ? 'mario-p2' : ''} ${marioPhase===4 ? 'mario-jump-anim left-1/2 -translate-x-1/2' : ''}`} style={{left: marioPhase===0?'-10%': marioPhase===3?'50%': undefined }}>ğŸš¶ğŸ¼â€â¡ï¸</div>
                     {!isRolling && marioPhase===4 && <div className="absolute top-[10%] left-1/2 -translate-x-1/2 animate__animated animate__bounceIn pixel-box p-4 text-3xl font-bold text-black">{winnerObj?.name}</div>}
                </div>
            );

            if (mode === 'slots') return (
                <div className="flex justify-center gap-6 bg-yellow-600 p-8 rounded-[2rem] border-8 border-yellow-800 pixel-box shadow-2xl">
                    {[0, 1, 2].map(col => (
                        <div key={col} className="bg-white h-56 w-32 rounded border-4 border-black relative overflow-hidden flex items-center justify-center text-black">
                            {!slotStops[col] ? <div className="reel-blur h-full w-full"></div> : 
                            <div className="animate__animated animate__bounceIn"><div className="text-7xl mb-2">{winnerObj?.avatar || 'ğŸ’'}</div><div className="text-xl font-bold text-red-600">{winnerObj?.name}</div></div>}
                        </div>
                    ))}
                </div>
            );

            if (mode === 'archery') return (
                <div className="w-full h-full relative flex items-center justify-center">
                    <div className={`w-64 h-64 bg-white rounded-full border-[20px] border-red-600 flex items-center justify-center shadow-xl ${archery.hit?'target-hit':''}`}><div className="w-32 h-32 bg-white rounded-full border-[20px] border-blue-600 flex items-center justify-center"><div className="w-10 h-10 bg-yellow-400 rounded-full"></div></div></div>
                    <div className={`absolute top-1/2 text-6xl font-bold transition-all whitespace-nowrap text-white drop-shadow-md ${archery.shoot ? 'arrow-anim' : 'hidden'}`} style={{transform: 'translateY(-50%)', display: isRolling?'none':'block'}}>+=========&gt;</div>
                    {archery.hit && <div className="absolute top-[25%] pixel-box p-4 text-3xl text-black font-bold animate__animated animate__bounceIn">{winnerObj?.name}</div>}
                </div>
            );

            if (mode === 'meteor') return (
                <div className="w-full h-full relative overflow-hidden">
                    {isRolling && Array.from({length:10}).map((_,i) => <div key={i} className="absolute text-4xl meteor-shower-item" style={{left:`${Math.random()*100}%`, animationDelay:`${Math.random()}s`}}>ğŸŒŸ</div>)}
                    {meteorStage >= 1 && <div className={`absolute text-[150px] meteor-final ${meteorStage===2?'hidden':''}`}>â˜„ï¸</div>}
                    {meteorStage === 2 && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center animate__animated animate__zoomIn"><div className="text-[150px] mb-4">ğŸ’¥</div><div className="pixel-box px-8 py-4 text-5xl text-black font-bold">{winnerObj?.name}</div></div>}
                </div>
            );

            if (mode === 'magic') return (
                <div className="flex gap-8 justify-center items-center h-full">
                    {[0,1,2].map(i => (
                        <div key={i} className={`relative w-48 h-72 card-container ${isRolling?'shuffling':''}`} style={{animationDelay:`${i*0.1}s`}}>
                            <div className={`w-full h-full card-inner ${cardFlipState[i] > 0 ? 'flipped' : ''}`}>
                                <div className="card-front text-6xl opacity-80">ğŸ”®</div>
                                <div className="card-back flex flex-col items-center justify-center text-black">
                                    {cardFlipState[i] === 1 ? <div className="text-6xl animate-bounce">ğŸ‘»</div> : 
                                     cardFlipState[i] === 2 ? <><div className="text-6xl mb-4 animate-bounce">ğŸ</div><div className="text-3xl font-bold">{winnerObj?.name}</div></> : ''}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );

            if (mode === 'retro') return (
                <div className="relative flex items-center justify-center">
                    <div className="absolute top-[-50px] text-8xl z-20 text-white drop-shadow-xl">â¬‡</div>
                    <div className={`w-[500px] h-[500px] rounded-full border-[16px] border-yellow-500 bg-red-800 flex items-center justify-center shadow-2xl overflow-hidden relative ${isRolling ? 'wheel-spinning' : ''}`}>
                         <div className="absolute inset-0 bg-[conic-gradient(from_0deg,#ff0000_0deg_36deg,#ffffff_36deg_72deg,#ff0000_72deg_108deg,#ffffff_108deg_144deg,#ff0000_144deg_180deg,#ffffff_180deg_216deg,#ff0000_216deg_252deg,#ffffff_252deg_288deg,#ff0000_288deg_324deg,#ffffff_324deg_360deg)] opacity-30"></div>
                         <div className={`w-56 h-56 bg-white rounded-full flex flex-col items-center justify-center z-10 border-8 border-gray-200`}>
                             {!isRolling && targetName ? <div className="text-center"><div className="text-6xl mb-2">{winnerObj?.avatar}</div><div className="text-2xl font-bold text-red-600">{winnerObj?.name}</div></div> : <div className="text-4xl font-black text-gray-500">SPIN</div>}
                         </div>
                    </div>
                </div>
            );

            // å…¶ä»–æ¨¡å¼é è¨­æ¸²æŸ“æ–‡å­—
            return <div className="text-9xl font-black neon-text text-yellow-400 drop-shadow-xl">{display}</div>;
        };

        const FloatingHearts = () => {
            const icons = ["ğŸ’•", "ğŸ’˜", "ğŸ˜‡", "ğŸ¥°", "ğŸ¤ª"];
            const items = useMemo(() => Array.from({length: 20}).map((_,i)=>({ id: i, icon: icons[i%icons.length], left: Math.random()*100, delay: Math.random()*2, dur: 3+Math.random()*2 })), []);
            return <div className="absolute inset-0 pointer-events-none z-0">{items.map(p => <div key={p.id} className="love-particle" style={{left:`${p.left}%`, bottom:'0', animationDelay:`${p.delay}s`, animationDuration:`${p.dur}s`}}>{p.icon}</div>)}</div>;
        };

        const IndexPage = ({ onStartHost, initialPlayers }) => {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState(initialPlayers || []);
            const { status } = useSocket(roomId, (evt, data) => {
                if (evt === 'player_list_update') setPlayers(data);
                else if (evt === 'init_data' && data.players) setPlayers(data.players);
            });

            useEffect(() => {
                let rid = new URLSearchParams(window.location.search).get('room');
                if(!rid) rid = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomId(rid);
                const url = `${window.location.href.split('?')[0]}?mode=player&room=${rid}`;
                if(typeof QRCode !== 'undefined') QRCode.toDataURL(url, { width: 300, margin: 2 }, (e, u) => !e && setQrUrl(u));
            }, []);

            return (
                <div className="min-h-screen relative flex flex-col items-center justify-center p-6">
                    <div className="text-center mb-8 animate__animated animate__bounceIn">
                        <div className="inline-block bg-red-900/80 px-8 py-2 rounded-full border border-yellow-500 text-yellow-300 font-bold mb-6">æ­¡è¿è’è‡¨</div>
                        <h1 className="text-4xl md:text-7xl font-black mb-4">å®¶é˜²ä¸­å¿ƒå°¾ç‰™</h1>
                        <div className="pixel-box p-4 bg-white flex flex-col items-center gap-4">
                            <div className="bg-white p-4 rounded-3xl shadow-inner">{qrUrl ? <img src={qrUrl} className="w-48 h-48" /> : <div>LOADING...</div>}</div>
                            <div className="text-center text-black font-black text-2xl">{players.length} äºº READY</div>
                        </div>
                    </div>
                    <div className="absolute bottom-10 right-10"><button onClick={() => onStartHost(roomId, players)} className="pixel-btn pixel-btn-yellow px-8 py-4 text-xl">é–‹å§‹ç››å…¸ &gt;</button></div>
                </div>
            );
        };

        const PlayerApp = ({ room }) => {
            const [user, setUser] = useState(null);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const { status, emit } = useSocket(room, (evt, data) => {
                if (evt === 'game_status_update') setGameStatus(data);
                if (evt === 'game_reset') { localStorage.removeItem('lottery_user'); window.location.reload(); }
            });
            useEffect(() => { const saved = localStorage.getItem('lottery_user'); if (saved) { setUser(JSON.parse(saved)); setJoined(true); } }, []);
            useEffect(() => { if (status === 'connected' && joined && user) emit('player_join', { user }); }, [status, joined]);
            
            const handleJoin = (name) => {
                const newUser = { id: Date.now().toString(), name, avatar: AVATARS[0] };
                setUser(newUser); setJoined(true); localStorage.setItem('lottery_user', JSON.stringify(newUser));
            };

            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;
            if(isWinner) return <div className="fixed inset-0 bg-yellow-500 flex flex-col items-center justify-center p-4 text-black"><div className="text-9xl mb-6">ğŸ†</div><h1 className="text-5xl font-black">ä½ ä¸­çäº†ï¼</h1><p className="text-2xl mt-4 font-bold">å¿«å»é ˜çï¼</p></div>;
            if(!joined) return <div className="min-h-screen bg-black flex flex-col items-center justify-center p-6 text-white"><input id="name-in" type="text" className="pixel-box p-4 text-black w-full mb-4 text-center text-xl" placeholder="è¼¸å…¥åå­—" /><button onClick={() => handleJoin(document.getElementById('name-in').value)} className="pixel-btn pixel-btn-yellow w-full py-4 text-xl">åŠ å…¥</button></div>;
            return <div className="min-h-screen bg-red-950 flex flex-col items-center justify-center p-8 text-center"><div className="text-6xl mb-6">{user.avatar}</div><h2 className="text-4xl font-bold">{user.name}</h2><p className="mt-4 text-yellow-400 animate-pulse">{gameStatus.status === 'playing' ? 'ğŸ² æŠ½çä¸­...' : 'ç­‰å¾…ä¸»æŒäºº...'}</p></div>;
        };

        const HostApp = ({ room, initialPlayers }) => {
            const [allPlayers, setAllPlayers] = useState(initialPlayers || []);
            const [winners, setWinners] = useState([]);
            const [isDrawing, setIsDrawing] = useState(false);
            const [gameMode, setGameMode] = useState('slots'); 
            const [targetCount, setTargetCount] = useState(1);
            const [displayState, setDisplayState] = useState({ winner: null, rolling: false, text: "READY" });

            const { emit } = useSocket(room, (evt, data) => {
                if(evt === 'player_list_update') setAllPlayers(data);
                if(evt === 'init_data' && data.players) setAllPlayers(data.players);
            });

            const MODES = ['slots', 'race', 'meteor', 'archery', 'adventure', 'shooter', 'retro', 'magic', 'radar', 'soccer', 'bomb'];
            
            const availablePlayers = useMemo(() => {
                const ids = new Set(winners.map(w => w.id));
                return allPlayers.filter(p => !ids.has(p.id));
            }, [allPlayers, winners]);

            const startDraw = async () => {
                if(availablePlayers.length === 0) return alert("åå–®å·²ç©º");
                AudioManager.init();
                const mode = MODES[Math.floor(Math.random() * MODES.length)];
                setGameMode(mode);
                setIsDrawing(true);
                emit('update_game_status', { status: { status: 'playing' } });

                const duration = (mode === 'race' || mode === 'adventure' || mode === 'archery') ? 6000 : 4000;
                setDisplayState({ rolling: true, winner: null, text: "ROLLING" });
                
                // å‹•ç•«ç­‰å¾…
                await new Promise(r => setTimeout(r, duration)); 
                
                const winner = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
                setWinners(prev => [...prev, winner]);

                // æ­æ›‰ç‹€æ…‹
                setDisplayState({ rolling: false, winner, text: winner.name });
                
                // æ’­æ”¾å‹åˆ©éŸ³æ•ˆèˆ‡èªéŸ³
                AudioManager.playWin();
                AudioManager.speak(`æ­å–œ ${winner.name} ä¸­ç`);
                confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });

                // 2ç§’å¾Œé¡¯ç¤ºå½ˆçª—
                setTimeout(() => {
                    setDisplayState(prev => ({ ...prev, showModal: true }));
                    emit('update_game_status', { status: { status: 'result', winnerName: winner.name, winnerId: winner.id } });
                    setIsDrawing(false);
                }, 2000);
            };

            return (
                <div className="h-screen bg-gray-900 flex flex-col relative overflow-hidden">
                    {displayState.showModal && displayState.winner && (
                        <div id="modal-open" className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 animate__animated animate__fadeIn">
                            <FloatingHearts />
                            <div className="text-center animate__animated animate__zoomInDown relative z-10">
                                <div className="pixel-box-dark p-12 border-8 border-yellow-500 shadow-[0_0_50px_rgba(234,179,8,0.5)]">
                                    <div className="text-9xl mb-6 animate-bounce">{displayState.winner.avatar}</div>
                                    <div className="text-5xl font-black text-white">WINNER</div>
                                    <div className="text-4xl text-yellow-300 mt-4">{displayState.winner.name}</div>
                                </div>
                                <button className="mt-8 pixel-btn bg-white text-black px-6 py-3 font-bold text-xl" onClick={() => setDisplayState({ ...displayState, showModal: false })}>é—œé–‰ / ä¸‹ä¸€ä½</button>
                            </div>
                        </div>
                    )}

                    <div className="flex-1 flex items-center justify-center p-8 z-10">
                        <VisualComponent candidates={availablePlayers} targetName={displayState.text} isRolling={displayState.rolling} mode={gameMode} winnerObj={displayState.winner} />
                    </div>

                    <div className="h-24 bg-black/60 flex items-center justify-center gap-6 p-4 z-30">
                        <button onClick={startDraw} disabled={isDrawing || availablePlayers.length === 0} className={`pixel-btn pixel-btn-yellow px-12 py-4 text-3xl font-black`}>{isDrawing ? 'ROLLING...' : 'é–‹å§‹æŠ½ç'}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('index');
            const [room, setRoom] = useState('');
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const m = params.get('mode'); const r = params.get('room');
                if (m === 'host' && r) { setMode('host'); setRoom(r); }
                else if (m === 'player' && r) { setMode('player'); setRoom(r); }
                else setMode('index');
            }, []);
            const handleStartHost = (rid, ps) => { sessionStorage.setItem(`lottery_players_${rid}`, JSON.stringify(ps)); window.location.href = `?mode=host&room=${rid}`; };
            return (
                <ErrorBoundary>
                    {mode === 'index' && <IndexPage onStartHost={handleStartHost} initialPlayers={[]} />}
                    {mode === 'host' && <HostApp room={room} initialPlayers={JSON.parse(sessionStorage.getItem(`lottery_players_${room}`) || '[]')} />}
                    {mode === 'player' && <PlayerApp room={room} />}
                </ErrorBoundary>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        removeLoading();
    </script>
</body>
</html>
