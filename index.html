<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家防中心尾牙 - 迎賓大廳</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- MQTT Library (取代 Firebase) -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        body { 
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            color: white; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            overflow: hidden;
        }
        .pattern-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23fbbf24' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        @keyframes floatUp {
            0% { transform: translateY(110vh) scale(0.8); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-20vh) scale(1.1); opacity: 0; }
        }
        .bubble {
            position: absolute;
            animation: floatUp linear infinite;
            will-change: transform, opacity;
            bottom: -100px;
        }
        .glass-panel {
            background: rgba(127, 29, 29, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(253, 230, 138, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // MQTT 設定
        const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt'; // 公用 Broker
        const generateRoomId = () => Math.floor(1000 + Math.random() * 9000).toString();

        const PlayerBubble = ({ player }) => {
            const style = useMemo(() => {
                const size = 80 + Math.random() * 60;
                const left = 5 + Math.random() * 90;
                const duration = 10 + Math.random() * 15;
                return {
                    width: `${size}px`,
                    height: `${size}px`,
                    left: `${left}%`,
                    animationDuration: `${duration}s`,
                };
            }, []);

            return (
                <div className="bubble flex flex-col items-center justify-center bg-yellow-500/20 border border-yellow-300/40 rounded-full text-center shadow-lg backdrop-blur-sm z-0" style={style}>
                    <div className="text-3xl filter drop-shadow-md">{player.avatar}</div>
                    <div className="text-white font-bold text-sm mt-1 px-2 truncate w-full shadow-black drop-shadow-md">{player.name}</div>
                </div>
            );
        };

        function IndexPage() {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState([]);
            const clientRef = useRef(null);

            useEffect(() => {
                // 1. 決定 Room ID (優先從 URL 讀取，沒有則生成)
                const urlParams = new URLSearchParams(window.location.search);
                const currentRoom = urlParams.get('room') || generateRoomId();
                setRoomId(currentRoom);

                // 2. 生成 Player URL 與 QR Code
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                const playerLink = `${baseUrl}/player.html?room=${currentRoom}`;
                
                QRCode.toDataURL(playerLink, { width: 400, margin: 1, color: { dark: '#7f1d1d', light: '#ffffff' } }, (err, url) => {
                    if(!err) setQrUrl(url);
                });

                // 3. 連接 MQTT
                const client = mqtt.connect(MQTT_BROKER);
                clientRef.current = client;

                client.on('connect', () => {
                    console.log('Connected to MQTT', currentRoom);
                    client.subscribe(`tw_lottery/${currentRoom}/join`);
                });

                client.on('message', (topic, message) => {
                    if (topic.endsWith('/join')) {
                        try {
                            const newPlayer = JSON.parse(message.toString());
                            setPlayers(prev => {
                                // 避免重複加入
                                if (prev.some(p => p.id === newPlayer.id)) return prev;
                                return [...prev, newPlayer];
                            });
                        } catch (e) { console.error(e); }
                    }
                });

                return () => { if(client) client.end(); };
            }, []);

            const startGame = () => {
                // 將目前玩家名單存入 sessionStorage 傳遞給 project.html
                sessionStorage.setItem(`lottery_players_${roomId}`, JSON.stringify(players));
                window.location.href = `project.html?room=${roomId}`;
            };

            return (
                <div className="min-h-screen relative overflow-hidden pattern-bg font-sans">
                    {/* 泡泡層 */}
                    <div className="absolute inset-0 pointer-events-none overflow-hidden">
                        {players.map((p) => <PlayerBubble key={p.id} player={p} />)}
                    </div>

                    <div className="relative z-10 min-h-screen flex flex-col items-center justify-center p-6">
                        <div className="text-center mb-10 animate-bounce-in">
                            <div className="inline-block bg-red-900/80 px-8 py-2 rounded-full border border-yellow-500/50 text-yellow-300 font-bold tracking-widest mb-6 shadow-xl backdrop-blur-md">
                                歡迎蒞臨
                            </div>
                            <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-600 drop-shadow-2xl tracking-tight mb-4">
                                家防中心尾牙
                            </h1>
                            <p className="text-red-100/90 text-xl font-light tracking-wider bg-black/20 inline-block px-4 py-1 rounded-lg backdrop-blur-sm">
                                房號: <span className="font-mono font-bold text-yellow-400">{roomId}</span>
                            </p>
                        </div>

                        <div className="glass-panel p-8 rounded-[3rem] shadow-2xl flex flex-col items-center gap-6 max-w-sm w-full mx-auto transform hover:scale-105 transition-transform duration-500">
                            <div className="bg-white p-4 rounded-3xl shadow-inner">
                                {qrUrl ? <img src={qrUrl} alt="Scan" className="w-64 h-64 object-contain" /> : <div className="w-64 h-64 flex items-center justify-center text-red-300">Loading...</div>}
                            </div>
                            <div className="text-center">
                                <div className="text-yellow-400 font-black text-4xl mb-1">{players.length} 人</div>
                                <div className="text-red-200 text-sm font-bold uppercase tracking-widest">已加入連線</div>
                            </div>
                        </div>

                        <div className="absolute bottom-8 right-8">
                            <button onClick={startGame} className="group flex items-center gap-3 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-red-900 px-8 py-4 rounded-full font-black text-xl shadow-lg transition-all hover:scale-105">
                                <span>進入大螢幕抽獎</span>
                                <span className="text-2xl group-hover:translate-x-1 transition-transform">→</span>
                            </button>
                        </div>
                        
                        <div className="absolute bottom-6 w-full text-center text-red-300/30 text-xs pointer-events-none">
                            &copy; 家防中心尾牙抽獎系統
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<IndexPage />);
    </script>
</body>
</html>