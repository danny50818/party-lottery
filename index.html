<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸</title>
    
    <!-- 1. éŒ¯èª¤æ””æˆª -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg);
            return false;
        };
    </script>

    <!-- CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        /* å­—é«”è¨­å®šï¼šå¾®è»Ÿæ­£é»‘é«”å„ªå…ˆ */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #2b0000; /* æ·±ç´…åº•è‰² */
            color: #fff;
            font-weight: bold;
            image-rendering: pixelated;
        }

        /* 8-Bit UI å…ƒä»¶ */
        .pixel-box { background: #fff; border: 4px solid #000; color: #000; box-shadow: -4px 0 0 0 #000, 4px 0 0 0 #000, 0 -4px 0 0 #000, 0 4px 0 0 #000; }
        .pixel-box-dark { background: #000; border: 4px solid #fff; color: #fff; box-shadow: -4px 0 0 0 #fff, 4px 0 0 0 #fff, 0 -4px 0 0 #fff, 0 4px 0 0 #fff; }
        .pixel-btn { border: 4px solid rgba(0,0,0,0.4); cursor: pointer; transition: transform 0.1s; box-shadow: inset -4px -4px 0 rgba(0,0,0,0.3); font-family: 'Press Start 2P', cursive; }
        .pixel-btn:active { transform: translateY(4px); }
        .pixel-btn-yellow { background: #facc15; border-color: #854d0e; color: black; text-shadow: none; }
        .pixel-btn-red { background: #ef4444; border-color: #7f1d1d; color: white; }

        /* --- ç´…è‰²æµå‹•æ–¹æ ¼èƒŒæ™¯ (Retro Grid) --- */
        .retro-grid-container {
            position: fixed; width: 200vw; height: 200vh; left: -50%; top: -50%;
            transform: perspective(400px) rotateX(60deg) translateY(0) translateZ(-100px);
            z-index: -1; pointer-events: none; overflow: hidden;
        }
        .retro-grid {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(to right, rgba(255, 50, 50, 0.4) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 50, 50, 0.4) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: grid-scroll 3s linear infinite;
        }
        .retro-grid-mask { position: fixed; top: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to bottom, #1a0000 0%, transparent 40%, #1a0000 100%); z-index: -1; pointer-events: none; }
        @keyframes grid-scroll { 0% { transform: translateY(0); } 100% { transform: translateY(60px); } }

        /* Loading */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2b0000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pixel-spinner { width: 48px; height: 48px; background: #fbbf24; animation: pixel-spin 0.8s steps(4) infinite; box-shadow: 4px 4px 0 #b45309; }
        @keyframes pixel-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- éŠæˆ²å°ˆå±¬å‹•ç•« CSS --- */
        
        /* 1. Mario */
        @keyframes mario-run { 0% { transform: translateY(0); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0); } }
        .mario-running { animation: mario-run 0.2s steps(2) infinite; }
        @keyframes mario-jump-hit { 
            0% { bottom: 20px; } 50% { bottom: 120px; } 100% { bottom: 20px; } 
        }
        .mario-jump { animation: mario-jump-hit 0.5s ease-out forwards; }
        @keyframes block-bump { 0% { transform: translateY(0); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0); } }
        .block-hit { animation: block-bump 0.2s ease-out; }

        /* 2. Slots */
        @keyframes reel-spin { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
        .reel-rolling .reel-inner { animation: reel-spin 0.1s linear infinite; filter: blur(2px); }

        /* 3. Horse */
        @keyframes horse-run { 0% { transform: translateY(0); } 50% { transform: translateY(-2px); } 100% { transform: translateY(0); } }
        .horse-sprite { animation: horse-run 0.1s steps(2) infinite; }

        /* 4. Shooter */
        @keyframes ship-move { 0% { left: 10%; } 50% { left: 90%; } 100% { left: 10%; } }
        .ship-moving { animation: ship-move 2s linear infinite; }
        @keyframes laser-shoot { 0% { bottom: 60px; opacity: 1; } 100% { bottom: 400px; opacity: 0; } }
        .laser-beam { position: absolute; width: 4px; height: 20px; background: #0f0; animation: laser-shoot 0.5s linear infinite; }

        /* 5. Claw */
        @keyframes claw-drop { 0% { top: -50px; } 50% { top: 150px; } 100% { top: -50px; } }
        .claw-anim { animation: claw-drop 3s ease-in-out forwards; }

        /* 6. Meteor */
        @keyframes meteor-fall { 0% { transform: translate(200px, -200px); opacity: 0; } 20% { opacity: 1; } 100% { transform: translate(-500px, 500px); opacity: 0; } }
        .meteor-falling { animation: meteor-fall 1s linear forwards; }

        /* 7. Tarot */
        .card-container { perspective: 1000px; }
        .card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; inset: 0; }
        .card-back { transform: rotateY(180deg); }

        /* 8. Radar */
        @keyframes radar-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .radar-line { animation: radar-spin 2s linear infinite; transform-origin: bottom right; }
        @keyframes dot-expand { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
        .radar-dot { animation: dot-expand 1s ease-out infinite; }

    </style>
</head>
<body>
    <div id="root"></div>
    
    <div class="retro-grid-mask"></div>
    <div class="retro-grid-container">
        <div class="retro-grid"></div>
    </div>

    <div id="loading-screen">
        <div class="pixel-spinner mb-8"></div>
        <div class="text-yellow-400 text-xl font-bold">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;
        const { createRoot } = ReactDOM;
        
        const AVATARS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ¦„"];
        const removeLoading = () => { const el = document.getElementById('loading-screen'); if(el) { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 500); }};

        // --- Error Boundary ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, info) { console.error("React Error:", error, info); }
            render() {
                if (this.state.hasError) {
                    removeLoading();
                    return <div className="h-screen flex flex-col items-center justify-center p-6 bg-red-900 text-white text-center font-mono"><h1>SYSTEM CRASHED</h1><button onClick={()=>window.location.reload()} className="mt-4 pixel-btn px-4 py-2">REBOOT</button></div>;
                }
                return this.props.children;
            }
        }

        // --- Socket Hook ---
        const useSocket = (roomId, onEvent) => {
            const socketRef = useRef(null);
            const [status, setStatus] = useState('connecting');
            useEffect(() => {
                if(!roomId || typeof io === 'undefined') return;
                const socket = io({ reconnectionAttempts: 5, timeout: 5000 }); 
                socketRef.current = socket;
                socket.on('connect', () => { setStatus('connected'); socket.emit('join_room', roomId); });
                socket.on('disconnect', () => setStatus('disconnected'));
                socket.on('player_list_update', (d) => onEvent && onEvent('player_list_update', d));
                socket.on('game_status_update', (d) => onEvent && onEvent('game_status_update', d));
                socket.on('init_data', (d) => onEvent && onEvent('init_data', d));
                socket.on('game_reset', (d) => onEvent && onEvent('game_reset', d));
                return () => socket.disconnect();
            }, [roomId]);
            const emit = (e, d) => { if(socketRef.current) socketRef.current.emit(e, { roomId, ...d }); };
            return { status, emit };
        };

        // --- è¦–è¦ºçµ„ä»¶ (8ç¨®æ¨¡å¼é‚è¼¯) ---
        const VisualComponent = ({ candidates, targetName, isRolling, mode, winnerObj }) => {
            // State for animations
            const [marioState, setMarioState] = useState('run');
            const [slotState, setSlotState] = useState([true, true, true]);
            const [horses, setHorses] = useState([]);
            const [shooterState, setShooterState] = useState('fly');
            const [clawPos, setClawPos] = useState('up');
            const [meteorStep, setMeteorStep] = useState(0);
            const [tarotFlip, setTarotFlip] = useState([false, false, false]);
            const [radarFound, setRadarFound] = useState(false);

            useEffect(() => {
                let interval;
                if (isRolling) {
                    // åˆå§‹åŒ–å‹•ç•«ç‹€æ…‹
                    setMarioState('run');
                    setSlotState([true, true, true]);
                    setShooterState('fly');
                    setClawPos('up');
                    setMeteorStep(0);
                    setTarotFlip([false, false, false]);
                    setRadarFound(false);

                    if (mode === 'race') {
                        // è³½é¦¬åˆå§‹åŒ–
                        const racers = candidates.slice(0, 5).map(p => ({...p, progress: 0, speed: Math.random()}));
                        while(racers.length < 5) racers.push({name:'NPC', avatar:'ğŸ', progress:0, speed: Math.random()});
                        setHorses(racers);
                        
                        // è³½é¦¬è·‘å‹•é‚è¼¯ (å¿½å¿«å¿½æ…¢)
                        interval = setInterval(() => {
                            setHorses(prev => prev.map(h => {
                                let speedChange = (Math.random() - 0.5) * 2;
                                let newSpeed = Math.max(0.5, Math.min(3, h.speed + speedChange));
                                let newProgress = h.progress + newSpeed;
                                return { ...h, speed: newSpeed, progress: Math.min(90, newProgress) };
                            }));
                        }, 100);
                    } else if (mode === 'meteor') {
                        // æµæ˜Ÿé›¨
                        interval = setInterval(() => {
                            setMeteorStep(p => (p + 1) % 4);
                        }, 500);
                    } else if (mode === 'tarot') {
                        // æ´—ç‰Œç„¡éœ€JSï¼ŒCSSè™•ç†
                    }

                } else if (targetName) {
                    // --- æ­æ›‰å‹•ç•«é‚è¼¯ ---
                    
                    if (mode === 'mario') {
                        setMarioState('jump'); // è·³èºæ’ç£š
                    }
                    else if (mode === 'slots') {
                        // é€å€‹åœæ­¢
                        setTimeout(() => setSlotState([false, true, true]), 500);
                        setTimeout(() => setSlotStops([false, false, true]), 1000); // ä¿®æ­£è®Šæ•¸å
                        setTimeout(() => setSlotState([false, false, false]), 1500);
                    }
                    else if (mode === 'race' && winnerObj) {
                        // è´å®¶è¡ç·š
                        setHorses(prev => prev.map(h => h.name === winnerObj.name ? {...h, progress: 100} : h));
                    }
                    else if (mode === 'shooter') {
                        setShooterState('shoot'); // å°„æ“Šçˆ†ç‚¸
                    }
                    else if (mode === 'claw') {
                        setClawState('drop'); // ä¸‹æŠ“
                    }
                    else if (mode === 'meteor') {
                        setMeteorStep(99); // æœ€å¾Œä¸€é¡†å¤§æµæ˜Ÿ
                    }
                    else if (mode === 'tarot') {
                        // ä¾åºç¿»é–‹ (æ¨¡æ“¬) -> æœ€å¾Œä¸€å¼µæ‰æ˜¯çœŸçš„
                        setTimeout(() => setTarotFlip([true, false, false]), 500);
                        setTimeout(() => setTarotFlip([true, true, false]), 1000);
                        setTimeout(() => setTarotFlip([true, true, true]), 1500);
                    }
                    else if (mode === 'radar') {
                        setRadarFound(true); // ç™¼ç¾ç›®æ¨™
                    }
                }
                return () => clearInterval(interval);
            }, [isRolling, targetName, mode, winnerObj, candidates]);

            // Helper: ä¿®æ­£æ‹‰éœ¸åœæ­¢ (ä¸Šé¢å¯«éŒ¯äº†è®Šæ•¸åï¼Œé€™è£¡è£œæ•‘)
            useEffect(() => {
                if(!isRolling && targetName && mode === 'slots') {
                     setTimeout(() => setSlotState([false, true, true]), 500);
                     setTimeout(() => setSlotState([false, false, true]), 1000);
                     setTimeout(() => setSlotState([false, false, false]), 1500);
                }
            }, [isRolling, targetName, mode]);


            // --- æ¸²æŸ“ç•«é¢ ---

            // 1. ç‘ªåˆ©æ­ (Adventure)
            if (mode === 'adventure') return (
                <div className="w-full h-full relative flex flex-col justify-end pb-10 overflow-visible">
                    <div className="absolute top-[20%] left-1/2 -translate-x-1/2 flex gap-4">
                        <div className={`w-24 h-24 bg-[#b85c00] border-4 border-black flex items-center justify-center text-4xl text-white font-bold ${marioState==='jump'?'animate-bounce':''}`}>?</div>
                    </div>
                    <div className="w-full h-16 bg-[#c84c0c] border-t-8 border-black relative z-10"></div>
                    <div className={`absolute bottom-20 transition-all duration-500 ease-linear ${isRolling ? 'left-0 animate-[slideRight_2s_linear_infinite]' : 'left-1/2 -translate-x-1/2'}`} style={{left: isRolling ? '0' : '50%'}}>
                        <div className={`text-9xl ${isRolling ? 'mario-running' : ''} ${marioState==='jump'?'mario-jump':''}`}>
                            {isRolling ? 'ğŸƒ' : (winnerObj?.avatar || 'ğŸ•´ï¸')}
                        </div>
                    </div>
                    {!isRolling && targetName && marioState==='jump' && (
                        <div className="absolute top-[5%] left-1/2 -translate-x-1/2 animate__animated animate__zoomIn pixel-box p-4 text-2xl text-black font-bold whitespace-nowrap">
                            {targetName}
                        </div>
                    )}
                </div>
            );

            // 2. æ‹‰éœ¸ (Slots)
            if (mode === 'slots') {
                const renderReel = (stop) => {
                    if (!stop) return <div className="reel-inner text-6xl flex flex-col gap-4 text-black opacity-50"><div>ğŸ’</div><div>7</div><div>ğŸ’</div></div>;
                    return <div className="flex flex-col items-center justify-center h-full animate__animated animate__bounceIn text-black"><div className="text-6xl">{winnerObj?.avatar}</div><div className="text-sm font-bold mt-2">{winnerObj?.name}</div></div>;
                };
                return (
                    <div className="flex gap-4 p-8 bg-yellow-600 rounded-xl border-8 border-yellow-800 shadow-2xl">
                        {[0,1,2].map(i => (
                            <div key={i} className="w-40 h-64 bg-white border-4 border-black overflow-hidden relative rounded-lg">
                                {renderReel(slotState[i] === false)} 
                            </div>
                        ))}
                    </div>
                );
            }

            // 3. è³½é¦¬ (Race)
            if (mode === 'race') return (
                <div className="w-full max-w-6xl flex flex-col gap-3 p-4 bg-green-800 border-4 border-white rounded-lg pixel-box">
                    <div className="absolute right-12 top-0 bottom-0 w-2 bg-red-500 z-0"></div>
                    {horses.map((h, i) => (
                        <div key={i} className="relative h-16 border-b-2 border-white/20 flex items-center">
                            <div className="w-24 text-right text-xs font-bold mr-2 truncate">{h.name}</div>
                            <div className="absolute text-4xl transition-all duration-300 ease-linear" style={{left: `${h.progress}%`}}>{h.avatar}</div>
                        </div>
                    ))}
                </div>
            );

            // 4. é£›æ©Ÿå°„æ“Š (Shooter)
            if (mode === 'shooter') return (
                <div className="w-full h-full relative overflow-hidden bg-black">
                    {/* æ•µæ©Ÿ (ä¸Šæ–¹) */}
                    <div className="absolute top-10 w-full flex justify-center gap-20">
                        {[0,1,2].map(i => (
                            <div key={i} className={`text-6xl transition-all duration-300 ${!isRolling && targetName && i===1 ? 'scale-150' : ''}`}>
                                {!isRolling && targetName && i===1 ? 'ğŸ’¥' : 'âœˆï¸'}
                                {!isRolling && targetName && i===1 && <div className="text-xl text-yellow-400 absolute top-full left-1/2 -translate-x-1/2 w-40 text-center">{targetName}</div>}
                            </div>
                        ))}
                    </div>
                    {/* ç©å®¶é£›èˆ¹ (ä¸‹æ–¹) */}
                    <div className={`absolute bottom-10 text-8xl transition-all duration-500 ease-in-out ${isRolling ? 'left-10' : 'left-1/2 -translate-x-1/2'}`} style={{animation: isRolling ? 'moveShip 2s infinite alternate' : 'none'}}>ğŸš€</div>
                    {/* é›·å°„ */}
                    {shooterState === 'shoot' && <div className="absolute bottom-32 left-1/2 w-2 h-[400px] bg-green-400 animate__animated animate__flash"></div>}
                    <style>{`@keyframes moveShip { 0% { left: 20%; } 100% { left: 80%; } }`}</style>
                </div>
            );

            // 5. å¤¾å¨ƒå¨ƒ (Claw)
            if (mode === 'claw') return (
                <div className="relative w-[400px] h-[500px] bg-black/50 border-8 border-pink-500 rounded-t-3xl overflow-hidden mx-auto pixel-box-dark">
                    <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-2 bg-gray-400 transition-all duration-[2000ms] ${clawState==='drop'?'h-[300px]':'h-10'}`}></div>
                    <div className={`absolute top-0 left-1/2 -translate-x-1/2 text-8xl transition-all duration-[2000ms] ${clawState==='drop'?'top-[280px]':'top-0'}`}>ğŸ‘¾</div>
                    
                    <div className="absolute bottom-0 w-full flex justify-around p-4">
                         <div className="text-5xl">ğŸ</div>
                         <div className="text-5xl">ğŸ</div>
                         <div className="text-5xl">ğŸ</div>
                    </div>

                    {!isRolling && targetName && clawState === 'drop' && (
                        <div className="absolute top-[350px] left-1/2 -translate-x-1/2 text-center z-20 animate__animated animate__zoomIn">
                            <div className="text-6xl mb-2">{winnerObj?.avatar}</div>
                            <div className="bg-white text-pink-600 px-2 font-bold">{targetName}</div>
                        </div>
                    )}
                </div>
            );

            // 6. æµæ˜Ÿ (Meteor)
            if (mode === 'meteor') return (
                <div className="w-full h-full relative overflow-hidden">
                    {/* 3é¡†æµæ˜Ÿä¾åºè½ä¸‹ */}
                    {isRolling && [0,1,2].map(i => (
                        <div key={i} className={`absolute top-[-50px] text-6xl animate-[meteorDrop_1s_linear_infinite]`} style={{left: `${20 + i*30}%`, animationDelay: `${i*0.3}s`}}>â˜„ï¸</div>
                    ))}
                    
                    {!isRolling && targetName && (
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center z-20">
                            <div className="text-[150px] animate__animated animate__zoomInDown">ğŸ’¥</div>
                            <div className="pixel-box p-6 text-4xl text-black font-bold mt-4 animate__animated animate__fadeInUp">{targetName}</div>
                        </div>
                    )}
                </div>
            );

            // 7. å¡”ç¾… (Tarot)
            if (mode === 'tarot') return (
                <div className="flex justify-center gap-8 h-full items-center">
                    {[0, 1, 2].map(i => (
                        <div key={i} className={`w-40 h-64 bg-purple-900 border-4 border-yellow-400 rounded-xl flex items-center justify-center shadow-2xl transition-transform duration-1000 ${isRolling ? 'animate-pulse' : ''} ${!isRolling && i===1 ? 'rotate-y-180' : ''}`} style={{transformStyle:'preserve-3d', transform: !isRolling && i===2 ? 'rotateY(180deg)' : 'rotateY(0deg)'}}>
                            {!isRolling && i===2 && targetName ? (
                                <div className="text-center bg-white w-full h-full flex flex-col items-center justify-center rounded-xl" style={{transform:'rotateY(180deg)'}}>
                                    <div className="text-6xl">{winnerObj?.avatar}</div>
                                    <div className="text-black font-bold mt-2">{targetName}</div>
                                </div>
                            ) : (
                                <div className="text-6xl opacity-50">ğŸ”®</div>
                            )}
                        </div>
                    ))}
                </div>
            );

            // 8. é›·é” (Radar)
            if (mode === 'radar') return (
                <div className="w-[500px] h-[500px] rounded-full border-4 border-green-500 bg-black/80 relative flex items-center justify-center overflow-hidden mx-auto">
                    {/* æƒæç·š */}
                    <div className={`absolute top-0 left-0 w-full h-full border-b-2 border-green-500 origin-center ${isRolling ? 'animate-spin' : ''}`} style={{background: 'linear-gradient(to bottom, transparent 50%, rgba(34,197,94,0.2) 50%)'}}></div>
                    
                    {!isRolling && targetName && (
                        <div className="z-10 text-center animate__animated animate__zoomIn">
                            <div className="w-6 h-6 bg-red-600 rounded-full mx-auto mb-2 animate-ping"></div>
                            <div className="text-6xl">{winnerObj?.avatar}</div>
                            <div className="text-green-400 font-bold text-2xl mt-2 pixel-box px-4 py-1 bg-black border-green-500">{targetName}</div>
                        </div>
                    )}
                </div>
            );

            return null;
        };

        // --- 1. Index Page ---
        const IndexPage = ({ onStartHost, initialPlayers }) => {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState(initialPlayers || []);
            
            useSocket(roomId, (evt, data) => {
                if (evt === 'player_list_update') setPlayers(data);
                if (evt === 'init_data' && data.players) setPlayers(data.players || []);
                if (evt === 'game_reset') setPlayers([]);
            });

            useEffect(() => {
                let rid = new URLSearchParams(window.location.search).get('room');
                if(!rid) rid = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomId(rid);
                const url = `${window.location.href.split('?')[0]}?mode=player&room=${rid}`;
                if(typeof QRCode !== 'undefined') QRCode.toDataURL(url, { width: 300, margin: 2, color: { dark: '#000000', light: '#ffffff' } }, (e, u) => !e && setQrUrl(u));
            }, []);

            return (
                <div className="min-h-screen relative overflow-hidden" style={{background:'#2b0000'}}>
                    <div className="retro-grid-mask"></div><div className="retro-grid-container"><div className="retro-grid"></div></div>
                    <div className="relative z-10 flex flex-col items-center justify-center h-screen p-6">
                        <h1 className="text-5xl font-black mb-8 text-yellow-400 drop-shadow-md">å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸</h1>
                        <div className="pixel-box p-6 bg-white flex flex-col items-center gap-4">
                            {qrUrl ? <img src={qrUrl} className="w-48 h-48" /> : <div>Loading QR...</div>}
                            <div className="text-black font-bold">{players.length} äººå·²åŠ å…¥</div>
                        </div>
                        <div className="absolute bottom-10 right-10">
                            <button onClick={() => onStartHost(roomId, players)} className="pixel-btn pixel-btn-yellow px-8 py-4 text-lg animate-bounce text-black font-bold">
                                é€²å…¥æŠ½çç³»çµ± &gt;
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 2. Player App ---
        const PlayerApp = ({ room }) => {
            const [user, setUser] = useState(null);
            const [nameInput, setNameInput] = useState("");
            const [myAvatar, setMyAvatar] = useState(AVATARS[0]);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const { status, emit } = useSocket(room, (evt, data) => {
                if (evt === 'game_status_update') setGameStatus(data);
                if (evt === 'game_reset') { localStorage.removeItem('lottery_user'); setUser(null); setJoined(false); alert("æ´»å‹•é‡ç½®ï¼Œè«‹é‡æ–°åŠ å…¥"); }
            });
            useEffect(() => { try { const u = JSON.parse(localStorage.getItem('lottery_user')); if (u) { setUser(u); setJoined(true); } } catch(e){} }, []);
            useEffect(() => { if (status === 'connected' && joined && user) emit('player_join', { user }); }, [status, joined]);
            const handleJoin = () => { if(!nameInput.trim()) return; const newUser = { id: Date.now().toString(), name: nameInput.trim(), avatar: myAvatar }; setUser(newUser); setJoined(true); localStorage.setItem('lottery_user', JSON.stringify(newUser)); emit('player_join', { user: newUser }); };
            
            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;

            if(isWinner) return <div className="fixed inset-0 bg-yellow-500 flex flex-col items-center justify-center p-6 text-center animate__animated animate__tada"><div className="text-9xl mb-4">ğŸ†</div><div className="text-4xl font-black text-black">æ­å–œä¸­çï¼</div><div className="text-2xl mt-2 text-red-700 font-bold">{user?.name}</div></div>;
            if(!joined) return <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-6"><div className="pixel-box p-6 w-full max-w-md text-center"><h1 className="text-xl mb-6 text-blue-600 font-bold">åƒåŠ è€…ç™»å…¥</h1><div className="grid grid-cols-4 gap-2 mb-6">{AVATARS.slice(0, 8).map(a => <button key={a} onClick={() => setMyAvatar(a)} className={`text-2xl p-2 border-2 ${myAvatar === a ? 'border-blue-500 bg-blue-100' : 'border-transparent'}`}>{a}</button>)}</div><input type="text" className="w-full border-4 border-black p-3 font-mono text-center mb-6 text-black" placeholder="è¼¸å…¥æš±ç¨±" value={nameInput} onChange={e => setNameInput(e.target.value)} /><button onClick={handleJoin} className="pixel-btn pixel-btn-yellow w-full py-4 text-lg font-bold">åŠ å…¥æ´»å‹•</button></div></div>;
            return <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center text-white p-6"><div className="pixel-box-dark p-8 text-center"><div className="text-6xl mb-4">{user.avatar}</div><div className="text-2xl font-bold text-yellow-400">{user.name}</div><div className="mt-4 text-green-400">â— å·²é€£ç·šï¼Œç­‰å¾…æŠ½ç</div></div></div>;
        };

        // --- 3. Host App ---
        const HostApp = ({ room, initialPlayers }) => {
            const [allPlayers, setAllPlayers] = useState(initialPlayers || []);
            const [winners, setWinners] = useState([]);
            const [isDrawing, setIsDrawing] = useState(false);
            const [gameMode, setGameMode] = useState('adventure');
            const [displayState, setDisplayState] = useState({ winner: null, rolling: false, text: "READY" });

            const { emit } = useSocket(room, (evt, data) => {
                if(evt === 'player_list_update') setAllPlayers(data);
                if(evt === 'init_data' && data.players) setAllPlayers(data.players);
                if(evt === 'game_reset') { setAllPlayers([]); setWinners([]); setIsDrawing(false); }
            });

            // æ¨¡å¼å°ç…§è¡¨ (8ç¨®)
            const MODES = [
                { id: 'adventure', name: 'å†’éšªå³¶' }, { id: 'slots', name: 'æ‹‰éœ¸æ©Ÿ' }, { id: 'race', name: 'è³½é¦¬' }, { id: 'shooter', name: 'é£›æ©Ÿå°„æ“Š' },
                { id: 'claw', name: 'å¤¾å¨ƒå¨ƒ' }, { id: 'meteor', name: 'æµæ˜Ÿ' }, { id: 'tarot', name: 'å¡”ç¾…ç‰Œ' }, { id: 'radar', name: 'é›·é”' }
            ];

            const availablePlayers = useMemo(() => allPlayers.filter(p => !winners.some(w => w.id === p.id)), [allPlayers, winners]);

            const startDraw = async () => {
                if (availablePlayers.length === 0) return alert("åå–®å·²ç©ºï¼");
                
                setIsDrawing(true);
                emit('update_game_status', { status: { status: 'playing' } });

                // éš¨æ©Ÿæ¨¡å¼
                const nextMode = MODES[Math.floor(Math.random() * MODES.length)].id;
                setGameMode(nextMode);

                const duration = 6000; // å‹•ç•«æ™‚é–“
                setDisplayState({ rolling: true, winner: null, text: "ROLLING" });

                // æŠ½é¸ (åƒ…æŠ½ä¸€ä½ç¤ºç¯„ï¼Œå¯æ“´å…… loop)
                setTimeout(() => {
                    const winner = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
                    setWinners(prev => [...prev, winner]);
                    
                    setDisplayState({ rolling: false, winner: winner, text: winner.name });
                    setIsDrawing(false);
                    
                    emit('update_game_status', { status: { status: 'result', winnerName: winner.name, winnerId: winner.id } });
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                }, duration);
            };

            const resetGame = () => { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æ¸…ç©ºã€‚")) emit('reset_game', {}); };

            return (
                <div className="h-screen bg-gray-900 flex flex-col relative overflow-hidden">
                    <div className="retro-grid-mask"></div><div className="retro-grid-container"><div className="retro-grid"></div></div>

                    {/* Header */}
                    <div className="absolute top-4 left-4 z-20 flex gap-4 text-xs font-bold">
                        <div className="pixel-box px-3 py-1 bg-blue-500 text-white">åƒèˆ‡: {allPlayers.length} / å‰©é¤˜: {availablePlayers.length}</div>
                        <div className="pixel-box px-3 py-1 bg-red-500 text-white">MODE: {gameMode.toUpperCase()}</div>
                    </div>

                    {/* Game Stage */}
                    <div className="flex-1 flex items-center justify-center p-8 z-10">
                        <VisualComponent candidates={availablePlayers} targetName={displayState.text} isRolling={displayState.rolling} mode={gameMode} winnerObj={displayState.winner} />
                    </div>

                    {/* Controls */}
                    <div className="h-24 bg-gray-800 border-t-4 border-black flex items-center justify-center gap-8 p-4 z-30">
                        <button onClick={startDraw} disabled={isDrawing || availablePlayers.length === 0} className={`pixel-btn ${isDrawing ? 'bg-gray-600' : 'pixel-btn-yellow'} px-10 py-4 text-2xl font-bold text-black shadow-lg transform hover:scale-105 transition-transform`}>
                            {isDrawing ? 'æŠ½çä¸­...' : 'é–‹å§‹æŠ½ç START'}
                        </button>
                        {!isDrawing && <button onClick={resetGame} className="pixel-btn bg-red-700 text-white px-4 py-2 text-sm border-red-900">é‡ç½®æ´»å‹•</button>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('index');
            const [room, setRoom] = useState('');
            useEffect(() => {
                const p = new URLSearchParams(window.location.search);
                const m = p.get('mode'); const r = p.get('room');
                if (m === 'host' && r) { setMode('host'); setRoom(r); }
                else if (m === 'player' && r) { setMode('player'); setRoom(r); }
                else setMode('index');
            }, []);
            const handleStartHost = (rid, ps) => {
                sessionStorage.setItem(`lottery_players_${rid}`, JSON.stringify(ps));
                window.location.href = `?mode=host&room=${rid}`;
            };
            return (
                <ErrorBoundary>
                    {mode === 'index' && <IndexPage onStartHost={handleStartHost} initialPlayers={[]} />}
                    {mode === 'host' && <HostApp room={room} initialPlayers={JSON.parse(sessionStorage.getItem(`lottery_players_${room}`) || '[]')} />}
                    {mode === 'player' && <PlayerApp room={room} />}
                </ErrorBoundary>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
