<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Russo+One&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: "Noto Sans TC", sans-serif; background: #450a0a; color: white; }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        
        /* Themes */
        .theme-cyber { background: radial-gradient(circle, #1a1a2e, #16213e, #0f3460); color: #00ffea; }
        .theme-retro { background: radial-gradient(circle, #4a0404, #7f1d1d, #2c0b0e); color: #fcd34d; }
        .theme-space { background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e); color: #e0e7ff; }
        .theme-magic { background: radial-gradient(circle at center, #581c87, #3b0764, #1a0329); color: #d8b4fe; }
        .theme-festival { background: linear-gradient(135deg, #be185d 0%, #db2777 50%, #9d174d 100%); color: #be185d; }
        .theme-race { background: linear-gradient(to bottom, #3f6212, #14532d); color: #fef08a; }

        /* Animations */
        @keyframes floatUp { 0% { transform: translateY(110vh) scale(0.8); opacity: 0; } 100% { transform: translateY(-20vh) scale(1.1); opacity: 0; } }
        .bubble { position: absolute; animation: floatUp linear infinite; bottom: -100px; }
        .neon-text { text-shadow: 0 0 10px rgba(0,255,234,0.7); font-family: 'Russo One', sans-serif; }
        
        /* Game Specific Animations */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wheel-container { transition: transform 4s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .card-flip { transform-style: preserve-3d; transition: transform 0.8s; }
        .card-flip.flipped { transform: rotateY(180deg); }
        .card-face { backface-visibility: hidden; position: absolute; inset: 0; }
        .card-back { transform: rotateY(180deg); }
        
        /* Meteor */
        @keyframes meteorFall { 0% { transform: translate(100%, -100%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, 50%) scale(1.5); opacity: 0; } }
        .meteor-anim { animation: meteorFall 1s ease-in forwards; }
        
        /* Slots */
        @keyframes reelScroll { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
        .reel-track { display: flex; flex-direction: column; }
        .reel-rolling .reel-track { animation: reelScroll 0.2s linear infinite; }
        
        /* Claw */
        @keyframes clawSwing { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
        .claw-arm { transform-origin: top center; animation: clawSwing 3s ease-in-out infinite; }
        .claw-grabbing { animation: none; transition: top 2s; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #450a0a; z-index: 50; display: flex; align-items: center; justify-content: center; color: #fbbf24; font-size: 1.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="loading">ç³»çµ±è¼‰å…¥ä¸­...</div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;
        const { createRoot } = ReactDOM;
        
        const AVATARS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ¦„"];
        const removeLoading = () => { const el = document.getElementById('loading'); if(el) el.style.display = 'none'; };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, info) { console.error(error, info); }
            render() {
                if (this.state.hasError) {
                    removeLoading();
                    return <div className="h-screen flex items-center justify-center p-6 bg-red-900 text-white"><h1âš ï¸ æ¸²æŸ“éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†</h1></div>;
                }
                return this.props.children;
            }
        }

        const useSocket = (roomId, onEvent) => {
            const socketRef = useRef(null);
            const [status, setStatus] = useState('connecting');
            useEffect(() => {
                if(!roomId || typeof io === 'undefined') return;
                const socket = io({ reconnectionAttempts: 5, timeout: 5000 }); 
                socketRef.current = socket;
                socket.on('connect', () => { setStatus('connected'); socket.emit('join_room', roomId); });
                socket.on('disconnect', () => setStatus('disconnected'));
                socket.on('player_list_update', (d) => onEvent && onEvent('player_list_update', d));
                socket.on('game_status_update', (d) => onEvent && onEvent('game_status_update', d));
                socket.on('init_data', (d) => onEvent && onEvent('init_data', d));
                socket.on('game_reset', (d) => onEvent && onEvent('game_reset', d));
                return () => socket.disconnect();
            }, [roomId]);
            const emit = (e, d) => { if(socketRef.current) socketRef.current.emit(e, { roomId, ...d }); };
            return { status, emit };
        };

        // --- è¦–è¦ºçµ„ä»¶ (ç¨ç«‹å‡ºä¾†ä»¥å…è¢«éŠ·æ¯€) ---
        const VisualComponent = ({ candidates, targetName, isRolling, mode, winnerObj }) => {
            const [display, setDisplay] = useState("READY");
            const [slotStops, setSlotStops] = useState([false, false, false]);
            const [horses, setHorses] = useState([]);
            const [impact, setImpact] = useState(false);

            // é‡ç½®ç‹€æ…‹
            useEffect(() => {
                if (isRolling) {
                    setSlotStops([false, false, false]);
                    setImpact(false);
                    // è³½é¦¬åˆå§‹åŒ–
                    if (mode === 'race') {
                         const racers = candidates.slice(0, 8).map(p => ({...p, progress: 0}));
                         while(racers.length < 5) racers.push({name:'NPC', avatar:'ğŸ´', progress:0});
                         setHorses(racers);
                    }
                }
            }, [isRolling, mode, candidates]);

            // å‹•ç•« Loop
            useEffect(() => {
                let interval;
                if (isRolling) {
                    if (mode === 'race') {
                        interval = setInterval(() => {
                            setHorses(prev => prev.map(h => ({...h, progress: Math.min(90, h.progress + Math.random()*2)})));
                        }, 100);
                    } else if (mode === 'slots') {
                        // è®“å®ƒè·‘ï¼Œä¸éœ€ setInterval æ›´æ–° stateï¼Œé  CSS å‹•ç•«
                    } else {
                        interval = setInterval(() => {
                            const randomName = candidates[Math.floor(Math.random() * candidates.length)]?.name || "...";
                            setDisplay(randomName);
                        }, 80);
                    }
                } else if (targetName) {
                    setDisplay(targetName);
                    // çµæŸæ™‚çš„ç‰¹æ®Šè™•ç†
                    if (mode === 'slots' && winnerObj) {
                        // ä¾åºåœæ­¢æ»¾è¼ª
                        setTimeout(() => setSlotStops(prev => [true, false, false]), 100);
                        setTimeout(() => setSlotStops(prev => [true, true, false]), 800);
                        setTimeout(() => setSlotStops(prev => [true, true, true]), 1500);
                    }
                    if (mode === 'meteor') {
                        setImpact(true);
                    }
                    if (mode === 'race' && winnerObj) {
                        setHorses(prev => prev.map(h => h.name === winnerObj.name ? {...h, progress: 100} : h));
                    }
                }
                return () => clearInterval(interval);
            }, [isRolling, targetName, mode, winnerObj]);

            // 1. è³½é¦¬
            if (mode === 'race') return (
                <div className="w-full max-w-5xl flex flex-col gap-2 relative p-4 bg-black/40 rounded-xl border border-white/20">
                    <div className="absolute right-4 top-0 bottom-0 w-1 bg-yellow-400 z-10"></div>
                    {horses.map((h, i) => (
                        <div key={i} className="flex items-center gap-2 relative border-b border-white/10 pb-1 h-12">
                            <div className="w-20 text-right text-sm truncate text-white/90 font-bold">{h.name}</div>
                            <div className="flex-1 relative h-full">
                                <div className="absolute top-1/2 -translate-y-1/2 text-3xl transition-all duration-300 transform -translate-x-full" style={{left: `${h.progress}%`}}>{h.avatar}</div>
                            </div>
                        </div>
                    ))}
                </div>
            );

            // 2. å¤¾å¨ƒå¨ƒ
            if (mode === 'claw') return (
                <div className="relative w-[360px] h-[500px] border-8 border-pink-400 rounded-t-3xl bg-black/30 overflow-hidden mx-auto shadow-2xl">
                    {/* çˆªå­ */}
                    <div className={`absolute top-0 left-1/2 -translate-x-1/2 flex flex-col items-center transition-all duration-[2000ms] ${isRolling ? 'animate-bounce' : targetName ? 'top-[40%]' : ''}`} style={{zIndex: 20}}>
                        <div className="w-1 h-20 bg-gray-300"></div>
                        <div className="text-6xl -mt-2">ğŸ‘¾</div>
                    </div>
                    {/* çå“å † */}
                    <div className="absolute bottom-0 w-full h-1/2 flex flex-wrap content-end justify-center p-4 gap-2 opacity-80">
                        {candidates.slice(0, 15).map((c,i) => <div key={i} className="text-4xl">{c.avatar}</div>)}
                    </div>
                    {/* ä¸­çé¡¯ç¤º */}
                    {!isRolling && targetName && (
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 text-center animate__animated animate__zoomIn">
                            <div className="text-9xl mb-2">{winnerObj?.avatar}</div>
                            <div className="bg-white text-pink-600 px-6 py-2 rounded-full font-black text-2xl shadow-lg border-4 border-pink-500">{targetName}</div>
                        </div>
                    )}
                </div>
            );

            // 3. æ‹‰éœ¸æ©Ÿ
            if (mode === 'slots') {
                // ç‚ºäº†è®“æ»¾è¼ªçœ‹èµ·ä¾†åœ¨å‹•ï¼Œæˆ‘å€‘éœ€è¦è¤‡è£½ä¸€ä»½åˆ—è¡¨
                const strip = [...candidates, ...candidates, ...candidates].slice(0, 30); 
                return (
                    <div className="flex justify-center gap-4 bg-yellow-600 p-6 rounded-3xl border-4 border-yellow-300 shadow-2xl">
                        {[0, 1, 2].map(col => (
                            <div key={col} className="bg-white h-48 w-32 md:w-40 rounded-lg border-4 border-gray-700 relative overflow-hidden">
                                <div className={`w-full ${!slotStops[col] ? 'reel-rolling' : ''}`} style={{ transform: slotStops[col] ? 'translateY(0)' : undefined }}>
                                    {!slotStops[col] ? (
                                        <div className="reel-track">
                                            {strip.map((c, i) => <div key={i} className="h-48 flex flex-col items-center justify-center border-b border-gray-200"><div className="text-5xl">{c.avatar}</div></div>)}
                                        </div>
                                    ) : (
                                        <div className="h-48 flex flex-col items-center justify-center animate__animated animate__bounceIn">
                                            <div className="text-6xl">{winnerObj?.avatar || 'ğŸ’'}</div>
                                            <div className="text-xl font-bold text-red-600 mt-2">{winnerObj?.name || targetName}</div>
                                        </div>
                                    )}
                                </div>
                                <div className="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-black/30 pointer-events-none"></div>
                            </div>
                        ))}
                    </div>
                );
            }

            // 4. æµæ˜Ÿæ’æ“Š
            if (mode === 'meteor') return (
                <div className="relative w-full h-full flex flex-col items-center justify-center">
                    {isRolling && <div className="text-white/50 text-2xl animate-pulse">âœ¨ è¨±é¡˜ä¸­... âœ¨</div>}
                    {!isRolling && targetName && (
                        <div className={`text-center z-20 ${impact ? 'animate-impact' : ''}`}>
                             <div className="text-[150px] animate__animated animate__zoomInDown mb-4">â˜„ï¸</div>
                             <div className="text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-yellow-300 drop-shadow-2xl animate__animated animate__fadeInUp">{targetName}</div>
                        </div>
                    )}
                </div>
            );

            // 5. å¹¸é‹è½‰ç›¤
            if (mode === 'retro') return (
                <div className="relative flex items-center justify-center">
                    <div className="absolute top-[-40px] text-6xl z-20 text-white drop-shadow-md">â¬‡</div>
                    <div className={`w-[500px] h-[500px] rounded-full border-8 border-yellow-500 bg-red-800 flex items-center justify-center shadow-2xl ${isRolling ? 'animate-spin' : ''}`} style={{animationDuration: '0.2s'}}>
                        {/* ç°¡å–®çš„è½‰ç›¤æ‰‡è‘‰ */}
                         <div className="absolute inset-0 rounded-full border-[250px] border-transparent border-t-yellow-400/30 border-l-red-600/30"></div>
                         <div className="absolute inset-0 rounded-full border-[250px] border-transparent border-b-blue-600/30 border-r-green-600/30"></div>
                         
                         {/* ä¸­å¿ƒ */}
                         <div className={`w-40 h-40 bg-white rounded-full flex items-center justify-center z-10 border-4 border-gray-300 ${!isRolling ? 'animate__animated animate__zoomIn' : ''}`}>
                             {!isRolling && targetName ? (
                                 <div className="text-center">
                                     <div className="text-4xl">{winnerObj?.avatar}</div>
                                     <div className="text-xl font-bold text-red-600 max-w-[120px] truncate">{targetName}</div>
                                 </div>
                             ) : <div className="text-5xl font-black text-gray-300">SPIN</div>}
                         </div>
                    </div>
                </div>
            );

            // 6. å¡”ç¾…ç‰Œ
            if (mode === 'magic') return (
                <div className="flex items-center justify-center">
                     <div className={`relative w-72 h-[420px] transition-all duration-1000 transform-style-3d ${!isRolling && targetName ? 'flipped' : ''} card-flip`}>
                         <div className="card-face absolute inset-0 bg-purple-900 rounded-2xl border-4 border-yellow-400 flex items-center justify-center shadow-2xl backface-hidden">
                             <div className="text-8xl opacity-30">ğŸ”®</div>
                         </div>
                         <div className="card-face card-back absolute inset-0 bg-white rounded-2xl border-4 border-purple-600 flex flex-col items-center justify-center shadow-2xl backface-hidden">
                             <div className="text-9xl mb-6">{winnerObj?.avatar}</div>
                             <div className="text-4xl font-bold text-purple-900">{targetName}</div>
                         </div>
                     </div>
                </div>
            );

            // 7. é è¨­ (çŸ©é™£æ»¾å‹• / é›·é”)
            return (
                <div className="flex flex-col items-center justify-center text-center">
                    <div className={`text-9xl font-black neon-text transition-all duration-300 ${isRolling ? 'opacity-70 blur-sm scale-95' : 'opacity-100 scale-110 text-yellow-300'}`}>
                        {display}
                    </div>
                    {mode === 'space' && isRolling && <div className="text-green-400 mt-8 text-xl tracking-[0.5em] animate-pulse">RADAR SCANNING...</div>}
                </div>
            );
        };

        const IndexPage = ({ onStartHost, initialPlayers }) => {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState(initialPlayers || []);
            const { status } = useSocket(roomId, (evt, data) => {
                if (evt === 'player_list_update') setPlayers(data);
                else if (evt === 'init_data' && data.players) setPlayers(data.players);
                else if (evt === 'game_reset') setPlayers([]);
            });

            useEffect(() => {
                let rid = new URLSearchParams(window.location.search).get('room');
                if(!rid) rid = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomId(rid);
                const url = `${window.location.href.split('?')[0]}?mode=player&room=${rid}`;
                if(typeof QRCode !== 'undefined') QRCode.toDataURL(url, { width: 400, margin: 1, color: { dark: '#7f1d1d', light: '#ffffff' } }, (e, u) => !e && setQrUrl(u));
            }, []);

            return (
                <div className="min-h-screen relative overflow-hidden" style={{background:'linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%)'}}>
                    <div className="absolute top-4 left-4 z-20 flex gap-2"><span className={`px-3 py-1 rounded-full text-xs font-bold ${status==='connected'?'bg-green-500 text-black':'bg-red-500 text-white'}`}>{status==='connected'?'é€£ç·šæ­£å¸¸':'é€£ç·šä¸­...'}</span><span className="text-white/50 text-xs">Room: {roomId}</span></div>
                    <div className="absolute inset-0 pointer-events-none">{players.map((p,i)=><div key={i} className="bubble flex flex-col items-center justify-center bg-yellow-500/20 border border-yellow-300/40 rounded-full text-center shadow-lg backdrop-blur-sm z-0" style={{width:`${80+Math.random()*60}px`,height:`${80+Math.random()*60}px`,left:`${5+Math.random()*90}%`,animationDuration:`${10+Math.random()*15}s`,animationDelay:`${Math.random()*-15}s`}}><div className="text-3xl drop-shadow">{p.avatar}</div><div className="text-white font-bold text-sm mt-1 px-2 truncate w-full shadow-black drop-shadow">{p.name}</div></div>)}</div>
                    <div className="relative z-10 min-h-screen flex flex-col items-center justify-center p-6">
                        <div className="text-center mb-8 animate__animated animate__bounceIn"><div className="inline-block bg-red-900/80 px-8 py-2 rounded-full border border-yellow-500/50 text-yellow-300 font-bold mb-6">æ­¡è¿è’è‡¨</div><h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-600 drop-shadow-2xl mb-4">å®¶é˜²ä¸­å¿ƒå°¾ç‰™</h1><p className="text-red-100/90 text-xl font-light bg-black/20 px-4 py-1 rounded-lg">æƒæ QR Code ç«‹å³ç°½åˆ°</p></div>
                        <div className="glass-panel p-8 rounded-[3rem] shadow-2xl flex flex-col items-center gap-6 transform hover:scale-105 transition-transform duration-500">
                            <div className="bg-white p-4 rounded-3xl shadow-inner">{qrUrl ? <img src={qrUrl} className="w-64 h-64 object-contain" /> : <div className="w-64 h-64 flex items-center justify-center text-red-300">Generating...</div>}</div>
                            <div className="text-center"><div className="text-yellow-400 font-black text-4xl mb-1">{players.length} äºº</div><div className="text-red-200 text-sm font-bold uppercase">å·²åŠ å…¥é€£ç·š</div></div>
                        </div>
                        <div className="absolute bottom-8 right-8"><button onClick={() => {sessionStorage.setItem(`lottery_players_${roomId}`, JSON.stringify(players)); window.location.search = `?mode=host&room=${roomId}`;}} className="bg-gradient-to-r from-yellow-600 to-yellow-500 text-red-900 px-8 py-4 rounded-full font-black text-xl shadow-lg hover:scale-105 transition-transform">é€²å…¥å¤§è¢å¹•æŠ½ç â†’</button></div>
                    </div>
                </div>
            );
        };

        const PlayerApp = ({ room }) => {
            const [user, setUser] = useState(null);
            const [nameInput, setNameInput] = useState("");
            const [myAvatar, setMyAvatar] = useState(AVATARS[0]);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const { status, emit } = useSocket(room, (evt, data) => {
                if(evt === 'game_status_update') setGameStatus(data);
                if(evt === 'game_reset') { localStorage.removeItem('lottery_user'); setUser(null); setJoined(false); alert("æ´»å‹•å·²é‡ç½®"); }
            });
            useEffect(() => { try { const u = JSON.parse(localStorage.getItem('lottery_user')); if (u) { setUser(u); setJoined(true); } } catch(e){} }, []);
            useEffect(() => { if (status === 'connected' && joined && user) emit('player_join', { user }); }, [status, joined]);
            const handleJoin = () => { if(!nameInput.trim()) return; const newUser = { id: Date.now()+Math.random().toString().slice(2), name: nameInput.trim(), avatar: myAvatar }; setUser(newUser); setJoined(true); localStorage.setItem('lottery_user', JSON.stringify(newUser)); emit('player_join', { user: newUser }); };
            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;
            
            if(isWinner) return <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-b from-red-900 to-black"><div className="bg-rays"></div><div className="relative z-10 text-center p-6 animate__animated animate__zoomInDown"><div className="text-[10rem] mb-4 animate__animated animate__tada infinite">ğŸ†</div><h1 className="text-5xl font-black text-yellow-400 drop-shadow-xl mb-4">æ­å–œä¸­çï¼</h1><p className="text-xl text-white">æœ¬å›åˆçš„å¹¸é‹å…’å°±æ˜¯ä½ </p><div className="mt-8 glass-panel p-6 rounded-2xl flex flex-col items-center gap-4"><div className="text-6xl">{user?.avatar}</div><div className="text-3xl font-bold text-white">{user?.name}</div><div className="bg-red-600 px-6 py-2 rounded-full font-bold animate-pulse">è«‹å‰å¾€å°å‰é ˜ç</div></div></div></div>;
            if(!joined) return <div className="min-h-screen bg-gradient-to-br from-red-900 to-black p-6 flex flex-col justify-center"><div className="w-full max-w-md mx-auto space-y-8 animate__animated animate__fadeIn"><div className="text-center"><h1 className="text-4xl font-black text-yellow-400">JOIN PARTY</h1><p className="text-red-200">è¼¸å…¥æš±ç¨±ï¼ŒåŠ å…¥ç››å…¸</p></div><div className="glass-panel rounded-3xl p-6 space-y-6"><div className="grid grid-cols-4 gap-3">{AVATARS.slice(0, 12).map(a => <button key={a} onClick={() => setMyAvatar(a)} className={`text-3xl rounded-xl p-2 ${myAvatar === a ? 'bg-red-800 border-2 border-yellow-400' : 'bg-white/10'}`}>{a}</button>)}</div><input type="text" className="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-center text-xl text-white outline-none focus:border-yellow-400" placeholder="ä¾‹å¦‚: å°æ˜" value={nameInput} onChange={e => setNameInput(e.target.value)} /><button onClick={handleJoin} className="w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-red-900 py-4 rounded-xl text-xl font-black shadow-lg">ğŸš€ ç«‹å³åŠ å…¥</button></div></div></div>;
            return <div className="min-h-screen bg-gradient-to-b from-red-900 to-black text-white flex flex-col items-center justify-center p-8 text-center relative overflow-hidden"><div className="absolute top-4 left-4 text-xs flex gap-2"><span className={`px-3 py-1 rounded-full ${status==='connected'?'bg-green-500 text-black':'bg-red-500'}`}>{status==='connected'?'é€£ç·šæ­£å¸¸':'é€£ç·šä¸­...'}</span></div>{gameStatus.status === 'playing' ? <div className="space-y-8 animate__animated animate__pulse infinite relative z-10"><div className="text-[8rem] animate-spin">ğŸ²</div><div className="text-3xl font-black text-yellow-400">æŠ½çé€²è¡Œä¸­...</div></div> : <div className="w-full space-y-8 animate__animated animate__fadeIn relative z-10"><div className="relative group"><div className="w-40 h-40 mx-auto bg-red-800 rounded-full flex items-center justify-center text-7xl border-4 border-yellow-500 shadow-2xl">{user.avatar}</div></div><div><h2 className="text-5xl font-black mb-3">{user.name}</h2><div className="inline-flex items-center px-5 py-2 rounded-full bg-green-900/50 text-green-400 border border-green-500/30">â— å·²é€£ç·š Ready</div></div>{gameStatus.winnerName && <div className="glass-panel p-6 rounded-2xl animate__animated animate__fadeInUp"><p className="text-yellow-500 text-xs mb-2">ä¸Šå›åˆå¾—ä¸»</p><div className="text-3xl font-black">{gameStatus.winnerName}</div></div>}<div className="text-red-300/50">ç­‰å¾…ä¸»æŒäººé–‹å§‹...</div></div>}<button onClick={()=>{if(confirm("ç™»å‡º?")){localStorage.removeItem('lottery_user');window.location.reload();}}} className="absolute bottom-6 text-white/30 text-sm underline z-20">ç™»å‡º</button></div>;
        };

        // --- 3. Host App ---
        const HostApp = ({ room, initialPlayers }) => {
            const [allPlayers, setAllPlayers] = useState(initialPlayers || []);
            const [winners, setWinners] = useState([]);
            const [currentRound, setCurrentRound] = useState(0);
            const [isDrawing, setIsDrawing] = useState(false);
            const [drawQueue, setDrawQueue] = useState([]);
            const [currentDisplayWinner, setCurrentDisplayWinner] = useState(null);
            const [currentDisplayWinnerObj, setCurrentDisplayWinnerObj] = useState(null);
            const [isVisualRolling, setIsVisualRolling] = useState(false);
            const [targetCount, setTargetCount] = useState(1);
            const [gameMode, setGameMode] = useState('cyber');
            const [showWinnerModal, setShowWinnerModal] = useState(false);
            const [modalWinner, setModalWinner] = useState(null);
            
            const { emit } = useSocket(room, (evt, data) => {
                if(evt === 'player_list_update') setAllPlayers(data);
                if(evt === 'init_data' && data.players) setAllPlayers(data.players);
                if(evt === 'game_reset') { setAllPlayers([]); setWinners([]); setCurrentRound(0); setIsDrawing(false); }
            });

            const GAME_MODES = [
                { id: 'cyber', name: 'çŸ©é™£æ»¾å‹•', theme: 'theme-cyber' }, { id: 'retro', name: 'å¹¸é‹è½‰ç›¤', theme: 'theme-retro' }, { id: 'magic', name: 'å‘½é‹å¡”ç¾…', theme: 'theme-magic' }, { id: 'space', name: 'é›·é”é–å®š', theme: 'theme-space' }, { id: 'vegas', name: 'é»ƒé‡‘æ‹‰éœ¸', theme: 'theme-retro' }, { id: 'meteor', name: 'æµæ˜Ÿé™è‡¨', theme: 'theme-space' }, { id: 'claw', name: 'å¤¾å¨ƒå¨ƒæ©Ÿ', theme: 'theme-festival' }, { id: 'race', name: 'æ¿€æˆ°è³½é¦¬', theme: 'theme-race' },
            ];
            const [unusedModes, setUnusedModes] = useState([...GAME_MODES.map(m => m.id)]);

            const availablePlayers = useMemo(() => {
                const ids = new Set(winners.map(w => w.id));
                return allPlayers.filter(p => !ids.has(p.id));
            }, [allPlayers, winners]);

            const resetGame = () => {
                if(confirm("ã€è­¦å‘Šã€‘ç¢ºå®šé‡ç½®ï¼Ÿå°‡æ¸…ç©ºæ‰€æœ‰ç´€éŒ„ä¸¦è¸¢å‡ºä½¿ç”¨è€…ã€‚")) {
                    emit('reset_game', {});
                    setAllPlayers([]); setWinners([]); setCurrentRound(0); setIsDrawing(false);
                }
            };

            const startDraw = async () => {
                if(availablePlayers.length < targetCount) { alert("äººæ•¸ä¸è¶³"); return; }
                let nextModes = [...unusedModes];
                if(nextModes.length === 0) nextModes = GAME_MODES.map(m=>m.id);
                const rIdx = Math.floor(Math.random()*nextModes.length);
                const mode = nextModes[rIdx];
                nextModes.splice(rIdx, 1);
                setUnusedModes(nextModes);
                setGameMode(mode);

                setIsDrawing(true);
                const nextRound = currentRound + 1;
                setCurrentRound(nextRound);

                const pool = [...availablePlayers];
                const roundWinners = [];
                for(let i=0; i<targetCount; i++){
                    const idx = Math.floor(Math.random()*pool.length);
                    roundWinners.push(pool[idx]);
                    pool.splice(idx,1);
                }
                setWinners(prev => [...prev, ...roundWinners]);
                emit('update_game_status', { status: {status:'playing', round: nextRound} });
                await processQueue(roundWinners, mode);
            };

            const processQueue = async (queue, mode) => {
                const animTime = (mode === 'race' || mode === 'claw') ? 10000 : 6000;
                await new Promise(r => setTimeout(r, 500));
                for(let i=0; i<queue.length; i++) {
                    const w = queue[i];
                    setIsVisualRolling(true);
                    setCurrentDisplayWinner(null);
                    setShowWinnerModal(false);
                    await new Promise(r => setTimeout(r, animTime)); 
                    setIsVisualRolling(false);
                    setCurrentDisplayWinner(w.name);
                    setCurrentDisplayWinnerObj(w);
                    await new Promise(r => setTimeout(r, 2500)); 
                    setModalWinner(w);
                    setShowWinnerModal(true);
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    if('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(`æ­å–œ ${w.name} ä¸­ç`);
                        u.lang = 'zh-TW';
                        window.speechSynthesis.speak(u);
                    }
                    await new Promise(r => setTimeout(r, 5000));
                    setShowWinnerModal(false);
                    emit('update_game_status', { status: {status:'result', round: currentRound+1, winnerName: w.name, winnerId: w.id} });
                    await new Promise(r => setTimeout(r, 500));
                }
                setIsDrawing(false);
            };

            const currentConfig = GAME_MODES.find(m => m.id === gameMode) || GAME_MODES[0];

            return (
                <div className={`h-screen flex flex-col relative overflow-hidden font-sans transition-colors duration-1000 ${currentConfig.theme}`}>
                    {showWinnerModal && modalWinner && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md animate__animated animate__fadeIn">
                            <div className="bg-red-900 border-4 border-yellow-500 rounded-[3rem] p-12 text-center animate__animated animate__zoomInDown shadow-[0_0_100px_rgba(255,215,0,0.5)]">
                                <div className="text-yellow-300 font-bold text-3xl mb-4 tracking-widest uppercase">Congratulations</div>
                                <div className="text-9xl mb-6 animate__animated animate__bounce infinite">{modalWinner.avatar}</div>
                                <div className="text-7xl font-black text-white drop-shadow-xl mb-4">{modalWinner.name}</div>
                                <div className="bg-yellow-500 text-red-900 px-8 py-2 rounded-full text-xl font-bold inline-block">æ­å–œä¸­ç</div>
                            </div>
                        </div>
                    )}

                    <div className="absolute top-0 left-0 w-full p-6 flex justify-between z-20 pointer-events-none">
                        <div className="glass-panel px-8 py-3 rounded-full shadow-lg flex gap-4 items-center">
                            <span className="font-bold text-2xl mr-2">{currentRound === 0 ? "æº–å‚™é–‹å§‹" : `ç¬¬ ${currentRound} å›åˆ`}</span>
                            {isDrawing && <span className="bg-red-600 text-white text-xs px-2 py-1 rounded animate-pulse">LIVE - {currentConfig.name}</span>}
                        </div>
                        <div className="glass-panel px-6 py-3 rounded-full text-white/80 font-mono">äººæ•¸: {allPlayers.length}</div>
                    </div>

                    <div className="flex-1 relative z-10 flex items-center justify-center p-8">
                        {allPlayers.length === 0 ? (
                            <div className="text-center animate__animated animate__fadeIn">
                                <div className="text-4xl opacity-50 mb-4 font-bold">ç­‰å¾…ç©å®¶åŠ å…¥...</div>
                                <div className="text-xl opacity-30 mt-2">è«‹æƒæé¦–é  QR Code</div>
                            </div>
                        ) : (
                            <VisualComponent candidates={availablePlayers.concat(drawQueue)} targetName={currentDisplayWinner} isRolling={isVisualRolling} mode={gameMode} winnerObj={currentDisplayWinnerObj} />
                        )}
                    </div>

                    <div className="absolute bottom-0 w-full p-10 flex flex-col items-center justify-center z-30 pointer-events-none bg-gradient-to-t from-black/80 to-transparent">
                        {!isDrawing && (
                            <div className="flex items-center gap-4 mb-6 bg-black/40 backdrop-blur-md px-6 py-2 rounded-full border border-white/10 pointer-events-auto">
                                <span className="text-sm font-bold opacity-70">æœ¬è¼ªæŠ½å‡º</span>
                                <button onClick={() => setTargetCount(Math.max(1, targetCount-1))} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20">-</button>
                                <span className="text-2xl font-black w-8 text-center">{targetCount}</span>
                                <button onClick={() => setTargetCount(Math.min(availablePlayers.length, targetCount+1))} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20">+</button>
                                <span className="text-sm opacity-50 ml-2">äºº (å‰©é¤˜ {availablePlayers.length})</span>
                            </div>
                        )}
                        
                        <div className="flex gap-4 pointer-events-auto">
                            <button onClick={startDraw} disabled={isDrawing || availablePlayers.length === 0} className={`px-16 py-5 rounded-full font-black text-3xl shadow-2xl transition-all transform flex items-center gap-4 border-4 ${isDrawing ? 'bg-gray-800 text-gray-500 border-gray-700 cursor-not-allowed scale-95' : 'bg-gradient-to-r from-yellow-400 to-orange-500 text-red-900 border-yellow-300 hover:scale-105'}`}>
                                {isDrawing ? <><span className="animate-spin">ğŸ²</span> æŠ½çä¸­...</> : <>{availablePlayers.length === 0 ? "æ´»å‹•çµæŸ" : "ğŸš€ é–‹å§‹æŠ½ç"}</>}
                            </button>
                            
                            {!isDrawing && (
                                <button onClick={resetGame} className="bg-red-900/80 hover:bg-red-700 text-white border border-red-500 px-6 py-5 rounded-full font-bold transition-all shadow-xl" title="é‡ç½®æ´»å‹•">
                                    ğŸ”„ é‡ç½®
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('index');
            const [room, setRoom] = useState('');

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const modeParam = params.get('mode');
                const roomParam = params.get('room');
                if (modeParam === 'host' && roomParam) { setMode('host'); setRoom(roomParam); }
                else if (modeParam === 'player' && roomParam) { setMode('player'); setRoom(roomParam); }
                else setMode('index');
            }, []);

            const handleStartHost = (roomId, players) => {
                sessionStorage.setItem(`lottery_players_${roomId}`, JSON.stringify(players));
                window.location.href = `?mode=host&room=${roomId}`;
            };

            return (
                <ErrorBoundary>
                    {mode === 'index' && <IndexPage onStartHost={handleStartHost} initialPlayers={[]} />}
                    {mode === 'host' && <HostApp room={room} initialPlayers={JSON.parse(sessionStorage.getItem(`lottery_players_${room}`) || '[]')} />}
                    {mode === 'player' && <PlayerApp room={room} />}
                </ErrorBoundary>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

        removeLoading();
    </script>
</body>
</html>