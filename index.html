import pdfplumber
import os
import re
import json
import pandas as pd
from datetime import datetime

# ==========================================
# ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¤å·¥å…· (ç¶­æŒä¸è®Š)
# ==========================================

def clean_text(text):
    if text is None: return None
    text = str(text).strip()
    return text if text else None

def clean_number(text):
    if not text: return 0
    # åªä¿ç•™æ•¸å­—èˆ‡å°æ•¸é»
    num_str = re.sub(r'[^\d.]', '', str(text))
    try:
        return int(float(num_str))
    except:
        return 0

def clean_boolean(value):
    if not value: return False
    val_str = str(value).lower().strip()
    # åˆ¤æ–·æ˜¯å¦åŒ…å«å‹¾é¸ç¬¦è™Ÿæˆ–è‚¯å®šè©
    return any(x in val_str for x in ['æ˜¯', 'yes', 'true', '1', 'v', 'â˜‘', 'â– ', 'æœ‰'])

def parse_roc_date(date_str):
    """è§£ææ°‘åœ‹å¹´å­—ä¸² -> è¥¿å…ƒæ ¼å¼å­—ä¸²"""
    if not date_str: return None
    try:
        nums = re.findall(r'\d+', date_str)
        if len(nums) >= 3:
            year = int(nums[0]) + 1911
            month = int(nums[1])
            day = int(nums[2])
            hour = int(nums[3]) if len(nums) > 3 else 0
            minute = int(nums[4]) if len(nums) > 4 else 0
            dt_obj = datetime(year, month, day, hour, minute)
            return dt_obj.strftime('%Y-%m-%d %H:%M:%S') 
    except:
        return None
    return None

# ==========================================
# ç¬¬äºŒéƒ¨åˆ†ï¼šPDF å…§å®¹æ“·å–å™¨ (æ–°å¢çš„é—œéµéƒ¨åˆ†)
# ==========================================

def extract_raw_data_from_pdf(pdf_path):
    """
    é€™éš»ç¨‹å¼è² è²¬ã€Œè®€æ‡‚ã€PDFï¼ŒæŠŠæ–‡å­—è½‰æˆæˆ‘å€‘è¦çš„ raw_data å­—å…¸ã€‚
    æ³¨æ„ï¼šå› ç‚º PDF è¡¨æ ¼è½‰æ–‡å­—æ ¼å¼ä¸ä¸€å®šæ•´é½Šï¼Œé€™è£¡ä½¿ç”¨ã€Œæ­£è¦è¡¨ç¤ºå¼ (Regex)ã€ä¾†æŠ“å–é—œéµæ¬„ä½ã€‚
    """
    raw_data = {}
    full_text = ""
    
    # 1. è®€å– PDF æ‰€æœ‰é é¢çš„æ–‡å­—
    with pdfplumber.open(pdf_path) as pdf:
        for page in pdf.pages:
            text = page.extract_text()
            if text:
                full_text += text + "\n" # ä¸²æ¥æ‰€æœ‰æ–‡å­—
    
    # ç‚ºäº†æ–¹ä¾¿æœå°‹ï¼Œç§»é™¤å¤šé¤˜æ›è¡Œï¼Œä½†ä¿ç•™ä¸€äº›é–“éš”
    one_line_text = full_text.replace('\n', '  ')

    # --- 2. ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼ (Regex) æŠ“å–è¡¨é ­è³‡è¨Š ---
    # æŠ“å–ã€Œæ¡ˆè™Ÿã€å¾Œé¢çš„æ–‡å­—
    match_case_no = re.search(r'æ¡ˆè™Ÿ[:ï¼š]\s*([^\s]+)', one_line_text)
    if match_case_no: raw_data['case_no'] = match_case_no.group(1)

    # æŠ“å–ã€Œç¤¾å·¥ã€å¾Œé¢çš„æ–‡å­—
    match_worker = re.search(r'ç¤¾å·¥(äººå“¡)?[:ï¼š]\s*([^\s]+)', one_line_text)
    if match_worker: raw_data['worker_name'] = match_worker.group(2)

    # æŠ“å–ã€Œå·¥ä½œ/æœå‹™èµ·è¿„æ™‚é–“ã€
    # é€™é‚Šå˜—è©¦æŠ“å–é¡ä¼¼ "æ°‘åœ‹ 112 å¹´..." çš„é•·å­—ä¸²
    match_time = re.search(r'èµ·è¿„æ™‚é–“(.+?)~(.+?)æœå‹™æ™‚é–“', one_line_text)
    if match_time:
        raw_data['time_start_str'] = match_time.group(1)
        raw_data['time_end_str'] = match_time.group(2)

    # æŠ“å–ã€Œæœå‹™æ™‚é–“ã€(æ™‚æ•¸)
    match_duration = re.search(r'æœå‹™æ™‚é–“\s*(\d+)\s*æ™‚\s*(\d+)\s*åˆ†', one_line_text)
    if match_duration:
        raw_data['duration_hours'] = match_duration.group(1)
        raw_data['duration_minutes'] = match_duration.group(2)

    # æŠ“å–ã€Œå·¥ä½œ/æœå‹™åœ°é»ã€
    match_loc = re.search(r'æœå‹™åœ°é»\s*([^\s]+)', one_line_text)
    if match_loc: raw_data['location'] = match_loc.group(1)

    # --- 3. æ™ºæ…§åˆ¤æ–·ï¼šå‹¾é¸äº†å“ªäº›æœå‹™ï¼Ÿ ---
    # é‚è¼¯ï¼šå¦‚æœåœ¨æ–‡ä¸­ç™¼ç¾è©²æœå‹™çš„ã€Œç‰¹å®šé—œéµå­—ã€ä¸”é™„è¿‘æœ‰å¡«å¯«å…§å®¹ï¼Œå°±åˆ¤å®šç‚ºæœ‰å‹¾é¸
    raw_data['service_items'] = []
    
    # åˆ¤æ–· A. è¨ªè«‡
    if 'è¨ªè«‡æœå‹™' in full_text and ('è‡³æ¡ˆå®¶' in full_text or 'é›»è©±' in full_text):
        raw_data['service_items'].append('interview')
        # å˜—è©¦æŠ“å–åœ°é»
        if 'è‡³æ¡ˆå®¶' in full_text: raw_data['interview_location'] = 'è‡³æ¡ˆå®¶è¨ªè«‡'
        elif 'é›»è©±' in full_text: raw_data['interview_location'] = 'é›»è©±è¨ªè«‡'

    # åˆ¤æ–· B. å®‰ç½® (é—œéµï¼šçœ‹æœ‰æ²’æœ‰å¡«å¯«å®‰ç½®æ—¥æœŸæˆ–è²»ç”¨)
    if 'å®¶å¤–å®‰ç½®' in full_text and ('å®‰ç½®æ—¥æœŸ' in full_text or 'å®‰ç½®è²»ç”¨' in full_text):
        raw_data['service_items'].append('placement')
        # å˜—è©¦æŠ“å–ç‹€æ…‹
        if 'ç·Šæ€¥å®‰ç½®' in full_text: raw_data['place_status'] = 'ç·Šæ€¥å®‰ç½®'
        elif 'ç¹¼çºŒå®‰ç½®' in full_text: raw_data['place_status'] = 'ç¹¼çºŒå®‰ç½®'
        
        # å˜—è©¦æŠ“å–è²»ç”¨ (æ‰¾ "ç”³è«‹æ¯æœˆ...å…ƒ" å‰å¾Œçš„æ•¸å­—)
        match_cost = re.search(r'å…¬è²»è£œåŠ©.*?(\d{3,}).*?å…ƒ', one_line_text)
        if match_cost: raw_data['place_cost_gov'] = match_cost.group(1)

    # åˆ¤æ–· F. å¼·åˆ¶è¦ªè· (é—œéµï¼šçœ‹æœ‰æ²’æœ‰å¡«å¯«æ™‚æ•¸)
    if 'å¼·åˆ¶è¦ªè·' in full_text and ('è™•åˆ†ç¸½æ™‚æ•¸' in full_text or 'å®Œæˆ' in full_text):
        raw_data['service_items'].append('mandatory_parenting')
        # æŠ“å–æ™‚æ•¸
        match_mp_hours = re.search(r'è™•åˆ†ç¸½æ™‚æ•¸[:ï¼š]?\s*(\d+)', one_line_text)
        if match_mp_hours: raw_data['mp_hour_total'] = match_mp_hours.group(1)

    # åˆ¤æ–· E. ä¿è­·ä»¤
    if 'è²è«‹ä¿è­·ä»¤' in full_text and ('é€šå¸¸ä¿è­·ä»¤' in full_text or 'ç·Šæ€¥ä¿è­·ä»¤' in full_text):
        raw_data['service_items'].append('protection_order')
        if 'ç·Šæ€¥ä¿è­·ä»¤' in full_text: raw_data['po_type'] = 'ç·Šæ€¥ä¿è­·ä»¤'
        if 'é€šå¸¸ä¿è­·ä»¤' in full_text: raw_data['po_type'] = 'é€šå¸¸ä¿è­·ä»¤'

    # æŠ“å–æœ€å¾Œçš„æ‘˜è¦ (é€šå¸¸åœ¨æ–‡ä»¶æœ«å°¾)
    if 'å·¥ä½œå…§å®¹æ‘˜è¦' in full_text:
        # å– "å·¥ä½œå…§å®¹æ‘˜è¦" ä¹‹å¾Œçš„æ‰€æœ‰æ–‡å­—
        parts = full_text.split('å·¥ä½œå…§å®¹æ‘˜è¦')
        if len(parts) > 1:
            raw_data['main_summary'] = parts[-1][:200].replace('\n', '') # å–å‰200å­—

    return raw_data

# ==========================================
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šè³‡æ–™æ¸…æ´—é‚è¼¯ (Clean Logic)
# ==========================================

def clean_service_record(raw_data):
    """å°‡æŠ“å‡ºä¾†çš„ raw_data é€²è¡Œæ¨™æº–åŒ–æ¸…æ´—"""
    cleaned = {}

    # Header
    cleaned['meta'] = {
        'case_no': clean_text(raw_data.get('case_no')), # æ–°å¢æ¡ˆè™Ÿ
        'worker_name': clean_text(raw_data.get('worker_name')), # æ–°å¢ç¤¾å·¥
        'time_start': parse_roc_date(raw_data.get('time_start_str')),
        'time_end': parse_roc_date(raw_data.get('time_end_str')),
        'duration_hours': clean_number(raw_data.get('duration_hours')),
        'location': clean_text(raw_data.get('location')),
        'service_items_checked': raw_data.get('service_items', []),
        'main_summary': clean_text(raw_data.get('main_summary'))
    }

    cleaned['details'] = {}
    items = cleaned['meta']['service_items_checked']

    # ç¯„ä¾‹ï¼šè™•ç†å®‰ç½® (åªç¤ºç¯„éƒ¨åˆ†ï¼Œé‚è¼¯åŒå‰)
    if 'placement' in items:
        cleaned['details']['placement'] = {
            'status': clean_text(raw_data.get('place_status')),
            'gov_subsidy': clean_number(raw_data.get('place_cost_gov'))
        }
        
    # ç¯„ä¾‹ï¼šè™•ç†å¼·åˆ¶è¦ªè·
    if 'mandatory_parenting' in items:
        cleaned['details']['mandatory_parenting'] = {
            'total_hours': clean_number(raw_data.get('mp_hour_total'))
        }
    
    # ç¯„ä¾‹ï¼šè™•ç†ä¿è­·ä»¤
    if 'protection_order' in items:
        cleaned['details']['protection_order'] = {
            'type': clean_text(raw_data.get('po_type'))
        }

    return cleaned

# ==========================================
# ç¬¬å››éƒ¨åˆ†ï¼šä¸»åŸ·è¡Œå€ (Main Execution)
# ==========================================

# 1. è¨­å®š PDF è³‡æ–™å¤¾è·¯å¾‘ (è«‹å‹™å¿…ç¢ºèªæ­¤è·¯å¾‘æ­£ç¢º)
pdf_folder = r'C:\Users\80012480\Downloads\Child_Protection_Project\pdf_source'

# 2. æº–å‚™å®¹å™¨
all_cleaned_records = []

# 3. é–‹å§‹æƒæè³‡æ–™å¤¾
if not os.path.exists(pdf_folder):
    print(f"âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™å¤¾ {pdf_folder}")
else:
    pdf_files = [f for f in os.listdir(pdf_folder) if f.endswith('.pdf')]
    print(f"ğŸ“‚ ç™¼ç¾ {len(pdf_files)} å€‹ PDF æª”æ¡ˆï¼Œé–‹å§‹è™•ç†...\n")

    for i, filename in enumerate(pdf_files):
        file_path = os.path.join(pdf_folder, filename)
        
        try:
            # A. æ“·å– (Extraction)
            raw_data = extract_raw_data_from_pdf(file_path)
            
            # B. æ¸…æ´— (Cleaning)
            cleaned = clean_service_record(raw_data)
            
            # è£œä¸Šæª”åæ–¹ä¾¿è¿½è¹¤
            cleaned['meta']['filename'] = filename
            
            all_cleaned_records.append(cleaned)
            
            # æ¯è™•ç† 10 å€‹é¡¯ç¤ºä¸€æ¬¡é€²åº¦
            if (i + 1) % 10 == 0:
                print(f" -> å·²è™•ç† {i + 1}/{len(pdf_files)} å€‹æª”æ¡ˆ...")
                
        except Exception as e:
            print(f"âš ï¸ è™•ç† {filename} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    # 4. è½‰å­˜ Excel
    print("\nğŸ“Š æ­£åœ¨ç”¢å‡º Excel å ±è¡¨...")
    
    if all_cleaned_records:
        # ä½¿ç”¨ json_normalize æ”¤å¹³è³‡æ–™
        df = pd.json_normalize(all_cleaned_records)
        
        # æ¬„ä½é‡æ–°å‘½å (è®“ Excel æ¨™é¡Œå¥½çœ‹ä¸€é»)
        df.rename(columns={
            'meta.filename': 'æª”æ¡ˆåç¨±',
            'meta.case_no': 'æ¡ˆè™Ÿ',
            'meta.worker_name': 'ç¤¾å·¥å“¡',
            'meta.time_start': 'é–‹å§‹æ™‚é–“',
            'meta.time_end': 'çµæŸæ™‚é–“',
            'meta.location': 'åœ°é»',
            'meta.main_summary': 'æ‘˜è¦',
            'details.placement.status': 'å®‰ç½®ç‹€æ…‹',
            'details.placement.gov_subsidy': 'å®‰ç½®è²»ç”¨(å…¬è²»)',
            'details.mandatory_parenting.total_hours': 'å¼·åˆ¶è¦ªè·æ™‚æ•¸',
            'details.protection_order.type': 'ä¿è­·ä»¤é¡å‹'
        }, inplace=True)
        
        output_path = 'final_service_records.xlsx'
        try:
            df.to_excel(output_path, index=False)
            print(f"âœ… æˆåŠŸï¼æª”æ¡ˆå·²å„²å­˜ç‚º: {output_path}")
            print(f"å…±åŒ¯å‡º {len(df)} ç­†è³‡æ–™ã€‚")
        except PermissionError:
            print(f"âŒ å­˜æª”å¤±æ•—ï¼šè«‹ç¢ºèª {output_path} æ²’æœ‰è¢«é–‹å•Ÿã€‚")
    else:
        print("âš ï¸ æ²’æœ‰æˆåŠŸæŠ“å–åˆ°ä»»ä½•è³‡æ–™ï¼Œè«‹æª¢æŸ¥ PDF å…§å®¹æ˜¯å¦ç‚ºæ–‡å­—æª” (éæƒæåœ–ç‰‡)ã€‚")
