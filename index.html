<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸</title>

    <!-- 1. éŒ¯èª¤æ””æˆª -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg);
            // å¿½ç•¥éè‡´å‘½éŒ¯èª¤
            if (msg.includes("ResizeObserver") || msg.includes("Script error")) return true;
            return false;
        };
    </script>

    <!-- CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        /* å­—é«”è¨­å®šï¼šå¾®è»Ÿæ­£é»‘é«”å„ªå…ˆ */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #2b0000;
            color: #fff;
            font-weight: bold;
            image-rendering: pixelated;
        }

        /* UI å…ƒä»¶ */
        .pixel-box { background: #fff; border: 4px solid #000; color: #000; box-shadow: -4px 0 0 0 #000, 4px 0 0 0 #000, 0 -4px 0 0 #000, 0 4px 0 0 #000; }
        .pixel-box-dark { background: #000; border: 4px solid #fff; color: #fff; box-shadow: -4px 0 0 0 #fff, 4px 0 0 0 #fff, 0 -4px 0 0 #fff, 0 4px 0 0 #fff; }
        .pixel-btn { border: 4px solid rgba(0,0,0,0.4); cursor: pointer; transition: transform 0.1s; box-shadow: inset -4px -4px 0 rgba(0,0,0,0.3); font-family: 'Press Start 2P', cursive; }
        .pixel-btn:active { transform: translateY(4px); }
        .pixel-btn-yellow { 
            background: #facc15; 
            border-color: #854d0e; 
            color: black; 
            text-shadow: none;
            font-family: "Microsoft JhengHei", sans-serif !important; /* å¼·åˆ¶å¾®è»Ÿæ­£é»‘ */
        }

        /* --- 3D ç´…è‰²æµå‹•æ–¹æ ¼èƒŒæ™¯ --- */
        .retro-wrapper {
            position: fixed; inset: 0; z-index: -10;
            background: radial-gradient(circle at center, #500000 0%, #1a0000 100%);
            perspective: 1000px; overflow: hidden;
        }
        .retro-grid-plane {
            position: absolute; bottom: -30%; left: -50%; width: 200%; height: 150%;
            background-image: 
                linear-gradient(rgba(255, 50, 50, 0.4) 2px, transparent 2px), 
                linear-gradient(90deg, rgba(255, 50, 50, 0.4) 2px, transparent 2px);
            background-size: 80px 80px;
            transform: rotateX(70deg);
            animation: grid-move 2s linear infinite;
            box-shadow: 0 0 150px rgba(255, 0, 0, 0.5);
        }
        @keyframes grid-move { 0% { background-position: 0 0; } 100% { background-position: 0 80px; } }

        /* Loading */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2b0000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pixel-spinner { width: 48px; height: 48px; background: #fbbf24; animation: pixel-spin 0.8s steps(4) infinite; box-shadow: 4px 4px 0 #b45309; }
        @keyframes pixel-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- éŠæˆ²å‹•ç•« Keyframes --- */
        
        /* 1. è³½é¦¬ */
        @keyframes horse-gallop { 0% { transform: translateY(0); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0); } }
        .horse-sprite { animation: horse-gallop 0.15s steps(2) infinite; display: inline-block; transform: scaleX(1); }

        /* 2. æ‹‰éœ¸ (CSS Blur) */
        @keyframes reel-move { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        .reel-blur { 
            background: repeating-linear-gradient(180deg, #fff 0, #ccc 50%, #fff 100%);
            background-size: 100% 20px;
            animation: reel-move 0.1s linear infinite;
            filter: blur(2px);
            color: transparent;
        }

        /* 3. ç‘ªåˆ©æ­ (æ…¢è·‘->è·³èº) */
        @keyframes mario-run-anim { 0% { left: -10%; } 100% { left: 50%; } } /* è·‘åˆ°ä¸­é–“ */
        @keyframes mario-jump-anim { 0% { bottom: 80px; } 50% { bottom: 200px; } 100% { bottom: 80px; } }
        .mario-running { animation: horse-gallop 0.2s steps(2) infinite; }
        .block-hit { animation: bounce 0.3s ease-out; }

        /* 4. å°„ç®­ (Archery) */
        @keyframes arrow-fly { 
            0% { left: -100px; transform: translateY(0); } 
            100% { left: 50%; transform: translateY(0); } 
        }
        @keyframes target-shake { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2) rotate(10deg); } }
        
        /* 5. é£›æ©Ÿ (Shooter) */
        @keyframes ship-sway { 0% { left: 20%; } 50% { left: 80%; } 100% { left: 20%; } }
        .ship-moving { animation: ship-sway 4s ease-in-out infinite; }
        @keyframes laser-up { 0% { height: 0; bottom: 80px; } 50% { height: 500px; bottom: 80px; } 100% { height: 0; bottom: 600px; } }
        .laser-fire { animation: laser-up 0.5s linear forwards; }

        /* 6. æµæ˜Ÿ (å…¨å±) */
        @keyframes meteor-cross { 
            0% { transform: translate(120vw, -20vh) scale(0.5); opacity: 1; } 
            100% { transform: translate(-20vw, 120vh) scale(1); opacity: 0; } 
        }
        .meteor-item { position: absolute; top: 0; left: 0; width: 4px; height: 4px; background: #fff; box-shadow: 0 0 10px #fff, 0 0 20px #ff0; border-radius: 50%; }
        .meteor-item::after { content:''; position: absolute; top: 0; right: 0; width: 100px; height: 2px; background: linear-gradient(to left, transparent, #fff); transform: rotate(-45deg); transform-origin: right top; }

        /* 7. å¡”ç¾… (ç¿»ç‰Œ) */
        .card-container { perspective: 1000px; }
        .card-inner { transition: transform 0.8s; transform-style: preserve-3d; width: 100%; height: 100%; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 1rem; }
        .card-front { background: #4c1d95; border: 4px solid #facc15; transform: rotateY(0deg); }
        .card-back { background: #fff; border: 4px solid #4c1d95; transform: rotateY(180deg); }
        .card-flipped .card-inner { transform: rotateY(180deg); }

        /* 8. é›·é” */
        @keyframes radar-scan { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .radar-beam { width: 50%; height: 2px; background: linear-gradient(to right, transparent, #0f0); position: absolute; top: 50%; left: 50%; transform-origin: left center; animation: radar-scan 2s linear infinite; }
        @keyframes dot-ping { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
        .radar-dot { width: 10px; height: 10px; background: red; border-radius: 50%; position: absolute; }
        .radar-dot::after { content:''; position: absolute; inset:0; border: 1px solid red; border-radius: 50%; animation: dot-ping 1s infinite; }
        
        /* æ³¡æ³¡ */
        @keyframes floatUp { 0% { transform: translateY(110vh) scale(0.8); opacity: 0; } 20% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-20vh) scale(1.1); opacity: 0; } }
        .bubble { position: absolute; bottom: -100px; animation: floatUp linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- 3D èƒŒæ™¯ -->
    <div class="retro-wrapper">
        <div class="retro-horizon"></div>
        <div class="retro-grid-plane"></div>
    </div>

    <div id="loading-screen">
        <div class="pixel-spinner mb-8"></div>
        <div class="text-yellow-400 text-xl font-bold">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <script type="text/babel">
        // ==========================================
        //  TODO: å¡«å…¥ Render ç¶²å€ (æœ¬åœ°æ¸¬è©¦å¯ç•™ç©º)
        // ==========================================
        const BACKEND_URL = "https://party-lottery-1.onrender.com"; 
        // ==========================================

        const { useState, useEffect, useRef, useMemo, Component } = React;
        const { createRoot } = ReactDOM;
        
        const AVATARS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ¦„"];
        const removeLoading = () => { const el = document.getElementById('loading-screen'); if(el) { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 500); }};

        // --- Error Boundary ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) {
                    removeLoading();
                    return <div className="h-screen flex flex-col items-center justify-center p-6 bg-red-900 text-white text-center font-mono"><h1>SYSTEM CRASHED</h1><button onClick={()=>window.location.reload()} className="mt-4 pixel-btn px-4 py-2 bg-white text-black">REBOOT</button></div>;
                }
                return this.props.children;
            }
        }

        // --- Socket Hook ---
        const useSocket = (roomId, onEvent) => {
            const socketRef = useRef(null);
            const [status, setStatus] = useState('connecting');
            useEffect(() => {
                if(!roomId || typeof io === 'undefined') return;
                const connectionUrl = BACKEND_URL || window.location.origin;
                const socket = io(connectionUrl, { reconnectionAttempts: 5, timeout: 10000, transports: ['websocket', 'polling'] }); 
                socketRef.current = socket;
                socket.on('connect', () => { setStatus('connected'); socket.emit('join_room', roomId); removeLoading(); });
                socket.on('disconnect', () => setStatus('disconnected'));
                socket.on('player_list_update', (d) => onEvent && onEvent('player_list_update', d));
                socket.on('game_status_update', (d) => onEvent && onEvent('game_status_update', d));
                socket.on('init_data', (d) => onEvent && onEvent('init_data', d));
                socket.on('game_reset', (d) => onEvent && onEvent('game_reset', d));
                return () => socket.disconnect();
            }, [roomId]);
            const emit = (e, d) => { if(socketRef.current) socketRef.current.emit(e, { roomId, ...d }); };
            return { status, emit };
        };

        // --- è¦–è¦ºçµ„ä»¶ (8ç¨®æ¨¡å¼ - æ·±åº¦å„ªåŒ–ç‰ˆ) ---
        const VisualComponent = ({ candidates, targetName, isRolling, mode, winnerObj }) => {
            const [display, setDisplay] = useState("READY");
            
            // éŠæˆ²ç‹€æ…‹
            const [horses, setHorses] = useState([]);
            const [slotStops, setSlotStops] = useState([false, false, false]);
            const [marioPhase, setMarioPhase] = useState(0); // 0:wait, 1:run, 2:jump, 3:win
            const [shooterPhase, setShooterPhase] = useState(0); // 0:fly, 1:shoot, 2:boom
            const [cards, setCards] = useState([0,1,2]);
            const [cardReveal, setCardReveal] = useState(false);
            const [clawPhase, setClawPhase] = useState(0); // 0:move, 1:drop, 2:grab, 3:up
            const [radarHit, setRadarHit] = useState(false);
            const [arrowHit, setArrowHit] = useState(false);
            const [wheelSpin, setWheelSpin] = useState(true);

            // æ ¼å¼åŒ–é¡¯ç¤º (åƒ…é¡¯ç¤ºåå­—ï¼Œä¸é¡¯ç¤ºç·¨è™Ÿ)
            const getDisplayString = (player) => `${player.name}`;

            useEffect(() => {
                let interval;
                if (isRolling) {
                    // --- ç‹€æ…‹é‡ç½® ---
                    setSlotStops([false, false, false]);
                    setMarioPhase(1); // é–‹å§‹è·‘
                    setShooterPhase(0);
                    setClawPhase(0);
                    setCardReveal(false);
                    setRadarHit(false);
                    setArrowHit(false);
                    setWheelSpin(true);

                    // 1. è³½é¦¬
                    if (mode === 'race') {
                        const racers = candidates.slice(0, 5).map((p) => ({...p, progress: 0}));
                        while(racers.length < 5) racers.push({name:'CPU', avatar:'ğŸ', progress:0});
                        setHorses(racers);
                        interval = setInterval(() => {
                            setHorses(prev => prev.map(h => ({...h, progress: Math.min(88, h.progress + Math.random() * 2)})));
                        }, 100);
                    } 
                    // é€šç”¨æ–‡å­—è·³å‹•
                    else if (!['slots', 'adventure', 'shooter', 'claw'].includes(mode)) {
                        interval = setInterval(() => {
                            const randomPlayer = candidates[Math.floor(Math.random() * candidates.length)];
                            setDisplay(randomPlayer ? randomPlayer.name : "...");
                        }, 100);
                    }
                } 
                else if (targetName) {
                    // --- æ­æ›‰å‹•ç•«é‚è¼¯ ---
                    setDisplay(targetName);
                    
                    if (mode === 'race' && winnerObj) {
                        setHorses(prev => prev.map(h => h.name === winnerObj.name ? {...h, progress: 95} : h));
                    }
                    else if (mode === 'slots') {
                        // ä¾åºåœæ­¢æ»¾è¼ª
                        setTimeout(() => setSlotStops([true, false, false]), 500);
                        setTimeout(() => setSlotStops([true, true, false]), 1500);
                        setTimeout(() => setSlotStops([true, true, true]), 2500);
                    }
                    else if (mode === 'adventure') {
                        setMarioPhase(2); // è·³
                        setTimeout(() => setMarioPhase(3), 600); // é¡¯
                    }
                    else if (mode === 'shooter') {
                        setShooterPhase(1); // å°„æ“Š
                        setTimeout(() => setShooterPhase(2), 600); // çˆ†ç‚¸
                    }
                    else if (mode === 'claw') {
                        setClawPhase(1); // ä¸‹è½
                        setTimeout(() => setClawPhase(2), 2000); // æŠ“
                        setTimeout(() => setClawPhase(3), 3000); // ä¸Šå‡
                    }
                    else if (mode === 'magic') {
                        setTimeout(() => setCardReveal(true), 1000);
                    }
                    else if (mode === 'radar') {
                        setTimeout(() => setRadarHit(true), 1000);
                    }
                    else if (mode === 'archery') {
                        setArrowHit(true);
                    }
                    else if (mode === 'retro') {
                        setWheelSpin(false);
                    }
                }
                return () => clearInterval(interval);
            }, [isRolling, targetName, mode, winnerObj, candidates]);

            // --- æ¸²æŸ“ ---

            // 1. ç‘ªåˆ©æ­ (Adventure) - å„ªåŒ–ç‰ˆ
            if (mode === 'adventure') return (
                <div className="w-full h-full relative flex flex-col justify-end pb-20 overflow-hidden">
                     <div className="absolute top-[30%] left-1/2 -translate-x-1/2 flex gap-4">
                         <div className={`w-24 h-24 bg-yellow-600 border-4 border-black flex items-center justify-center text-white font-bold text-5xl ${marioPhase===3 ? 'block-hit animate-bounce' : ''}`}>?</div>
                     </div>
                     <div className="h-24 bg-[#5c94fc] w-full absolute bottom-0 border-t-8 border-black"></div>
                     {/* è§’è‰²å‹•ç•«ï¼šè·‘ -> è·³ -> é¡¯ */}
                     <div className={`absolute bottom-24 text-9xl transition-all duration-[3000ms] ease-linear ${marioPhase===1 ? 'left-[50%]' : marioPhase>=2 ? 'left-[50%] bottom-[200px]' : 'left-[-10%]'}`} style={{transitionProperty: marioPhase===2?'bottom':'left'}}>
                         {marioPhase >= 3 ? (winnerObj?.avatar || 'ğŸ•´ï¸') : 'ğŸƒ'}
                     </div>
                     {!isRolling && marioPhase===3 && (
                        <div className="absolute top-[10%] left-1/2 -translate-x-1/2 pixel-box px-8 py-4 text-3xl font-bold animate__animated animate__zoomIn text-black">{getDisplayString(winnerObj)}</div>
                     )}
                </div>
            );

            // 2. æ‹‰éœ¸ (Slots) - å„ªåŒ–ç‰ˆ
            if (mode === 'slots') {
                return (
                    <div className="flex justify-center gap-6 bg-yellow-600 p-8 rounded-[2rem] border-8 border-yellow-800 pixel-box shadow-2xl">
                        {[0, 1, 2].map(col => (
                            <div key={col} className="bg-white h-56 w-32 rounded border-4 border-black relative overflow-hidden flex items-center justify-center">
                                { !slotStops[col] ? (
                                    <div className="reel-rolling-effect text-6xl text-gray-400 blur-sm">ğŸ’<br/>ğŸ’<br/>7</div> 
                                ) : (
                                    <div className="text-center animate__animated animate__bounceIn">
                                        <div className="text-7xl mb-2">{winnerObj?.avatar || 'ğŸ’'}</div>
                                        {col === 2 && <div className="text-sm font-bold text-red-600">{winnerObj?.name}</div>}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                );
            }

            // 3. è³½é¦¬ (Race)
            if (mode === 'race') return (
                <div className="w-full max-w-5xl flex flex-col gap-3 relative p-6 bg-green-800 border-4 border-white pixel-box">
                    <div className="absolute right-10 top-0 bottom-0 w-4 bg-yellow-400 border-l-4 border-dashed border-white opacity-80"></div>
                    {horses.map((h, i) => (
                        <div key={i} className="relative h-16 border-b-2 border-white/20 flex items-center">
                            <div className="w-24 text-right text-lg font-bold text-white bg-black px-1 truncate mr-2">{h.name}</div>
                            <div className="absolute text-5xl transition-all duration-300 ease-linear horse-sprite" style={{left: `${h.progress}%`}}>{h.avatar}</div>
                        </div>
                    ))}
                </div>
            );

            // 4. é£›æ©Ÿå°„æ“Š (Shooter)
            if (mode === 'shooter') return (
                <div className="w-full h-full relative overflow-hidden">
                     <div className="absolute top-20 w-full flex justify-center gap-20">
                        <div className={`text-8xl ${shooterPhase===2 ? 'invisible' : 'animate-bounce'}`}>ğŸ‘¾</div>
                        <div className={`text-8xl ${shooterPhase===2 ? 'hidden' : 'animate-bounce'}`}>ğŸ‘¾</div>
                        <div className={`text-8xl ${shooterPhase===2 ? 'invisible' : 'animate-bounce'}`}>ğŸ‘¾</div>
                     </div>
                     <div className={`absolute bottom-10 text-8xl ${isRolling ? 'ship-moving' : ''} left-1/2 -translate-x-1/2`}>ğŸš€</div>
                     {shooterPhase >= 1 && <div className="absolute bottom-32 left-1/2 -translate-x-1/2 w-2 h-[600px] bg-green-400 laser-fire"></div>}
                     {shooterPhase === 2 && (
                         <div className="absolute top-20 left-1/2 -translate-x-1/2 text-center animate__animated animate__zoomIn">
                             <div className="text-9xl mb-4">ğŸ’¥</div>
                             <div className="pixel-box px-6 py-4 text-4xl text-black font-bold">{getDisplayString(winnerObj)}</div>
                         </div>
                     )}
                </div>
            );

            // 5. å¤¾å¨ƒå¨ƒ (Claw) - å„ªåŒ–ç‰ˆ
            if (mode === 'claw') return (
                <div className="relative w-[400px] h-[500px] border-8 border-pink-500 bg-black/80 mx-auto pixel-box-dark overflow-hidden">
                    <div className={`absolute w-2 bg-gray-400 top-0 left-1/2 -translate-x-1/2 transition-all duration-[2000ms] ${clawPhase===0?'h-10':clawPhase===1?'h-[300px]':'h-20'}`}>
                        <div className="absolute bottom-0 -left-6 text-7xl">ğŸ‘¾</div>
                        {clawPhase >= 2 && <div className="absolute bottom-[-60px] left-[-20px] text-6xl animate-bounce">{winnerObj?.avatar}</div>}
                    </div>
                    <div className="absolute bottom-0 w-full h-1/2 flex flex-wrap content-end justify-center p-4 gap-2 opacity-80">
                        {candidates.slice(0, 10).map((c,i) => <div key={i} className="text-4xl animate-pulse">{c.avatar}</div>)}
                    </div>
                    {clawPhase === 3 && (
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pixel-box p-4 text-2xl font-bold text-black animate__animated animate__fadeInUp">
                            {getDisplayString(winnerObj)}
                        </div>
                    )}
                </div>
            );

            // 6. æµæ˜Ÿ (Meteor) - å…¨è¢å¹•ç‰ˆ
            if (mode === 'meteor') return (
                <div className="w-full h-full relative overflow-hidden">
                    {isRolling && [1,2,3,4,5].map(i => (
                        <div key={i} className="absolute text-6xl animate-[meteor-cross_1.5s_linear_infinite]" 
                             style={{left: `${Math.random()*100}%`, top: '-10%', animationDelay: `${Math.random()}s`}}>â˜„ï¸</div>
                    ))}
                    {!isRolling && targetName && (
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center animate__animated animate__zoomIn">
                             <div className="text-[150px] mb-4">ğŸ’¥</div>
                             <div className="pixel-box px-8 py-4 text-5xl text-black font-bold">{getDisplayString(winnerObj)}</div>
                        </div>
                    )}
                </div>
            );

            // 7. å¡”ç¾… (Magic)
            if (mode === 'magic') return (
                <div className="flex gap-8 justify-center items-center h-full">
                    {[0,1,2].map(i => (
                        <div key={i} className={`relative w-48 h-72 card-container ${isRolling ? 'animate-pulse' : ''}`}>
                            <div className={`card-inner ${cardReveal && i===1 ? 'card-flipped' : ''}`}>
                                <div className="card-front flex items-center justify-center text-6xl">ğŸ”®</div>
                                <div className="card-back bg-white border-4 border-purple-600 flex flex-col items-center justify-center text-black">
                                    {i===1 ? <><div className="text-6xl mb-4">{winnerObj?.avatar}</div><div className="text-xl font-bold">{winnerObj?.name}</div></> : <div className="text-4xl text-gray-300">X</div>}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
            
            // 8. å°„ç®­ (Archery)
            if (mode === 'archery') return (
                <div className="w-full h-full relative flex items-center justify-center">
                    <div className={`w-64 h-64 bg-white rounded-full border-[24px] border-red-600 flex items-center justify-center shadow-xl ${arrowHit?'animate-pulse':''}`}>
                         <div className="w-32 h-32 bg-white rounded-full border-[24px] border-blue-600 flex items-center justify-center">
                             <div className="w-10 h-10 bg-yellow-400 rounded-full"></div>
                         </div>
                    </div>
                    {/* ç®­ */}
                    <div className={`absolute left-0 text-6xl transition-all duration-500 ease-in ${arrowHit ? 'left-[50%]' : 'left-[-100px]'}`}>ğŸ¹</div>
                    
                    {arrowHit && <div className="absolute top-[20%] pixel-box p-4 text-3xl text-black font-bold animate__animated animate__bounceIn">{getDisplayString(winnerObj)}</div>}
                </div>
            );

            // 9. é›·é” (Radar)
            if (mode === 'radar') return (
                 <div className="w-[600px] h-[600px] rounded-full border-4 border-green-500 bg-black/80 relative flex items-center justify-center overflow-hidden">
                    <div className={`absolute w-full h-full border-b-2 border-green-500 origin-center ${isRolling ? 'animate-spin' : ''}`} style={{background: 'linear-gradient(transparent 50%, rgba(0,255,0,0.2) 100%)'}}></div>
                    {radarHit && <div className="absolute w-4 h-4 bg-red-600 rounded-full animate-ping"></div>}
                    {radarHit && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pixel-box px-4 py-2 text-2xl text-black font-bold animate__animated animate__zoomIn mt-10">{getDisplayString(winnerObj)}</div>}
                </div>
            );

            // 10. è½‰ç›¤ (Retro)
            if (mode === 'retro') return (
                <div className="relative flex flex-col items-center">
                    <div className="text-6xl mb-4">â¬‡</div>
                    <div className={`w-[500px] h-[500px] rounded-full border-[16px] border-yellow-500 bg-red-800 flex items-center justify-center shadow-2xl relative ${isRolling || wheelSpin ? 'animate-spin' : ''}`} style={{animationDuration: isRolling?'0.2s':'3s'}}>
                         <div className="absolute inset-0 bg-[conic-gradient(from_0deg,#ff0000_0deg_36deg,#ffffff_36deg_72deg,#ff0000_72deg_108deg,#ffffff_108deg_144deg,#ff0000_144deg_180deg,#ffffff_180deg_216deg,#ff0000_216deg_252deg,#ffffff_252deg_288deg,#ff0000_288deg_324deg,#ffffff_324deg_360deg)] opacity-30"></div>
                         <div className="w-40 h-40 bg-white rounded-full flex items-center justify-center z-10 border-8 border-gray-200">
                             {!wheelSpin && targetName ? <div className="text-4xl">ğŸ</div> : <div className="text-4xl font-black text-gray-500">SPIN</div>}
                         </div>
                    </div>
                    {!wheelSpin && targetName && <div className="mt-8 pixel-box p-4 text-3xl text-black font-bold animate__animated animate__fadeInUp">{getDisplayString(winnerObj)}</div>}
                </div>
            );

            return null;
        };

        // --- 1. Index Page (è¿è³“) ---
        const IndexPage = ({ onStartHost, initialPlayers }) => {
            const [qrUrl, setQrUrl] = useState('');
            const [roomId, setRoomId] = useState('');
            const [players, setPlayers] = useState(initialPlayers || []);
            
            const { status } = useSocket(roomId, (event, data) => {
                if (event === 'player_list_update') setPlayers(data);
                else if (event === 'init_data' && data.players) setPlayers(data.players || []);
                else if (event === 'game_reset') setPlayers([]);
            });

            useEffect(() => {
                let rid = new URLSearchParams(window.location.search).get('room');
                if(!rid) rid = Math.floor(1000 + Math.random() * 9000).toString();
                setRoomId(rid);
                const url = `${window.location.href.split('?')[0]}?mode=player&room=${rid}`;
                if(typeof QRCode !== 'undefined') QRCode.toDataURL(url, { width: 300, margin: 2, color: { dark: '#000000', light: '#ffffff' } }, (e, u) => !e && setQrUrl(u));
            }, []);

            const PlayerBubble = ({ p }) => {
                const style = useMemo(() => ({ width: `${80+Math.random()*60}px`, height: `${80+Math.random()*60}px`, left: `${5+Math.random()*90}%`, animationDuration: `${10+Math.random()*15}s`, animationDelay: `${Math.random()*-15}s` }), []);
                return <div className="bubble flex flex-col items-center justify-center bg-yellow-500/20 border border-yellow-300/40 rounded-full text-center shadow-lg backdrop-blur-sm z-0" style={style}><div className="text-3xl drop-shadow">{p.avatar}</div><div className="text-white font-bold text-sm mt-1 px-2 truncate w-full shadow-black drop-shadow">{p.name}</div></div>;
            };

            return (
                <div className="min-h-screen relative overflow-hidden">
                    <div className="retro-grid-mask"></div><div className="retro-grid-container"><div className="retro-grid"></div></div>
                    <div className="absolute top-4 left-4 z-20 flex gap-2"><span className="pixel-box px-2 py-1 text-xs bg-blue-300 text-black">ROOM: {roomId}</span></div>
                    <div className="absolute inset-0 pointer-events-none">{players.map((p,i)=><PlayerBubble key={i} p={p}/>)}</div>
                    <div className="relative z-10 min-h-screen flex flex-col items-center justify-center p-6">
                        <div className="text-center mb-8 animate__animated animate__bounceIn"><div className="inline-block bg-red-900/80 px-8 py-2 rounded-full border border-yellow-500/50 text-yellow-300 font-bold mb-6">æ­¡è¿è’è‡¨</div><h1 className="text-4xl md:text-6xl text-white drop-shadow-[4px_4px_0_#000] leading-tight mb-4">å®¶é˜²ä¸­å¿ƒ<br/>å°¾ç‰™ç››å…¸</h1><div className="inline-block bg-red-600 border-4 border-white text-white px-4 py-2 text-sm shadow-[4px_4px_0_#000]">SCAN QR TO JOIN</div></div>
                        <div className="pixel-box p-4 bg-white flex flex-col items-center gap-4 transform hover:scale-105 transition-transform">
                            <div className="bg-white p-4 rounded-3xl shadow-inner">{qrUrl ? <img src={qrUrl} className="w-48 h-48 object-contain" /> : <div className="w-48 h-48 flex items-center justify-center text-black">LOADING...</div>}</div>
                            <div className="text-center text-black"><div className="text-2xl mb-1">{players.length} äºº</div><div className="text-xs">READY</div></div>
                        </div>
                        <div className="absolute bottom-10 right-10"><button onClick={() => onStartHost(roomId, players)} className="pixel-btn pixel-btn-yellow px-6 py-4 text-xs animate-bounce text-black">ä¸»æŒäººå…¥å£ &gt;</button></div>
                    </div>
                </div>
            );
        };

        // --- 2. Player App ---
        const PlayerApp = ({ room }) => {
            const [user, setUser] = useState(null);
            const [nameInput, setNameInput] = useState("");
            const [myAvatar, setMyAvatar] = useState(AVATARS[0]);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const [playerIndex, setPlayerIndex] = useState(0);

            const { status, emit } = useSocket(room, (evt, data) => {
                if (evt === 'game_status_update') setGameStatus(data);
                if (evt === 'game_reset') { localStorage.removeItem('lottery_user'); setUser(null); setJoined(false); alert("æ´»å‹•å·²é‡ç½®"); }
                if (evt === 'init_data' && data.players && user) {
                    const idx = data.players.findIndex(p => p.id === user.id);
                    if(idx !== -1) setPlayerIndex(idx+1);
                }
            });

            useEffect(() => { try { const u = JSON.parse(localStorage.getItem('lottery_user')); if (u) { setUser(u); setJoined(true); } } catch(e){} }, []);
            useEffect(() => { if (status === 'connected' && joined && user) emit('player_join', { user }); }, [status, joined]);
            const handleJoin = () => { if(!nameInput.trim()) return; const newUser = { id: Date.now().toString(), name: nameInput.trim(), avatar: myAvatar }; setUser(newUser); setJoined(true); localStorage.setItem('lottery_user', JSON.stringify(newUser)); emit('player_join', { user: newUser }); };
            
            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;

            if(isWinner) return <div className="fixed inset-0 z-50 bg-yellow-500 flex flex-col items-center justify-center p-4 text-center"><div className="animate__animated animate__tada animate__infinite text-9xl mb-6">ğŸ†</div><div className="pixel-box-dark p-6 mb-4"><h1 className="text-2xl text-yellow-400 mb-2">YOU WIN!</h1><p className="text-sm">æ­å–œä¸­çï¼</p></div><div className="pixel-box p-4 flex flex-col items-center"><div className="text-6xl mb-2">{user?.avatar}</div><div className="text-xl font-bold">No.{playerIndex}<br/>{user?.name}</div></div></div>;
            if(!joined) return <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-4"><div className="pixel-box p-6 w-full max-w-sm text-center"><h1 className="text-xl mb-6 text-blue-600">PLAYER JOIN</h1><div className="grid grid-cols-4 gap-2 mb-6">{AVATARS.slice(0, 8).map(a => <button key={a} onClick={() => setMyAvatar(a)} className={`text-2xl p-2 border-2 ${myAvatar === a ? 'border-blue-500 bg-blue-100' : 'border-transparent'}`}>{a}</button>)}</div><input type="text" className="w-full border-4 border-black p-3 font-mono text-center mb-6 text-black" placeholder="YOUR NAME" value={nameInput} onChange={e => setNameInput(e.target.value)} maxLength={8} /><button onClick={handleJoin} className="pixel-btn pixel-btn-yellow w-full py-4 text-lg">ENTER</button></div></div>;
            return <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center text-white p-4"><div className="absolute top-2 right-2 text-[10px] text-green-400">{status}</div>{gameStatus.status === 'playing' ? <div className="text-center animate-pulse"><div className="text-6xl mb-4">ğŸ²</div><div className="text-yellow-400 text-xl">ROLLING...</div></div> : <div className="text-center w-full max-w-sm"><div className="pixel-box-dark p-8 mb-6"><div className="text-6xl mb-4">{user.avatar}</div><div className="text-2xl text-yellow-400">No.{playerIndex}<br/><span className="text-sm text-white">{user.name}</span></div><div className="mt-4 text-xs text-green-400 border border-green-400 px-2 py-1 inline-block">READY</div></div></div>}</div>;
        };

        // --- 3. Host App ---
        const HostApp = ({ room, initialPlayers }) => {
            const [allPlayers, setAllPlayers] = useState(initialPlayers || []);
            const [winners, setWinners] = useState([]);
            const [isDrawing, setIsDrawing] = useState(false);
            const [gameMode, setGameMode] = useState('slots'); 
            const [targetCount, setTargetCount] = useState(1);
            const [displayState, setDisplayState] = useState({ winner: null, rolling: false, text: "READY" });

            const { emit } = useSocket(room, (evt, data) => {
                if(evt === 'player_list_update') setAllPlayers(data);
                if(evt === 'init_data' && data.players) setAllPlayers(data.players);
                if(evt === 'game_reset') { setAllPlayers([]); setWinners([]); setIsDrawing(false); setDisplayState({winner:null, rolling:false, text:"READY"}); }
            });

            // éŠæˆ²æ¨¡å¼åˆ—è¡¨
            const MODES = [
                { id: 'adventure', name: 'å†’éšªå³¶' }, { id: 'slots', name: 'æ‹‰éœ¸æ©Ÿ' }, { id: 'race', name: 'è³½é¦¬' }, { id: 'shooter', name: 'é£›æ©Ÿå°„æ“Š' },
                { id: 'claw', name: 'å¤¾å¨ƒå¨ƒ' }, { id: 'meteor', name: 'æµæ˜Ÿé›¨' }, { id: 'magic', name: 'å¡”ç¾…ç‰Œ' }, { id: 'radar', name: 'é›·é”' }, { id: 'archery', name: 'åç¾¿å°„æ—¥' }, { id: 'retro', name: 'è½‰ç›¤' }
            ];
            const [unusedModes, setUnusedModes] = useState([...MODES.map(m => m.id)]);

            const availablePlayers = useMemo(() => {
                const ids = new Set(winners.map(w => w.id));
                return allPlayers.filter(p => !ids.has(p.id));
            }, [allPlayers, winners]);

            const resetGame = () => { if(confirm("RESET SYSTEM?")) emit('reset_game', {}); };

            const startDraw = async () => {
                if(availablePlayers.length < targetCount) { alert("äººæ•¸ä¸è¶³"); return; }
                
                let pool = [...unusedModes];
                if(pool.length === 0) pool = MODES.map(m=>m.id);
                const rIdx = Math.floor(Math.random() * pool.length);
                const mode = pool[rIdx];
                pool.splice(rIdx, 1);
                setUnusedModes(pool);
                setGameMode(mode);

                setIsDrawing(true);
                emit('update_game_status', { status: { status: 'playing' } });

                const duration = (mode === 'race' || mode === 'claw' || mode === 'adventure') ? 8000 : 5000;
                
                setDisplayState({ rolling: true, winner: null, text: "ROLLING" });

                const shuffled = [...availablePlayers].sort(() => 0.5 - Math.random());
                const roundWinners = shuffled.slice(0, targetCount);
                setWinners(prev => [...prev, ...roundWinners]);

                await processWinners(roundWinners, mode, duration);
            };

            const processWinners = async (winnersList, mode, duration) => {
                for (let i = 0; i < winnersList.length; i++) {
                    const w = winnersList[i];
                    
                    setDisplayState({ rolling: true, winner: null, text: "ROLLING" });
                    
                    // å‹•ç•«æ’­æ”¾
                    await new Promise(r => setTimeout(r, duration)); 
                    
                    // æ­æ›‰ç‹€æ…‹ (è§¸ç™¼ VisualComponent çš„ targetName é‚è¼¯)
                    setDisplayState({ rolling: false, winner: w, text: `No.${allPlayers.findIndex(p => p.id === w.id)+1} - ${w.name}` });
                    confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
                    
                    // ç­‰å¾…æ­æ›‰å‹•ç•«æ¼”å®Œ (ä¾‹å¦‚çˆ†ç‚¸ã€ç¿»ç‰Œ)
                    await new Promise(r => setTimeout(r, 4000)); 
                    
                    // é¡¯ç¤ºä¸­çå½ˆçª—
                    setDisplayState(prev => ({ ...prev, showModal: true }));
                    emit('update_game_status', { status: { status: 'result', winnerName: w.name, winnerId: w.id } });

                    // ç­‰å¾…é—œé–‰
                    await new Promise(resolve => {
                         const check = setInterval(() => {
                             // é€™è£¡ç„¡æ³•ç›´æ¥è®€å–æœ€æ–°çš„ stateï¼Œæ‰€ä»¥æˆ‘å€‘è¨­å®šä¸€å€‹å›ºå®šå±•ç¤ºæ™‚é–“ (10ç§’)
                             // å¦‚æœéœ€è¦æ‰‹å‹•é—œé–‰æ‰èƒ½ç¹¼çºŒï¼Œå‰‡éœ€è¦å°‡é‚è¼¯ç§»å‡º loop (è¼ƒè¤‡é›œ)
                             // ç›®å‰è¨­å®šï¼š10ç§’å¾Œè‡ªå‹•ä¸‹ä¸€ä½ï¼Œæˆ–é»æ“Šé—œé–‰ç«‹å³ä¸‹ä¸€ä½(éœ€é‡æ§‹)
                             // ç°¡å–®åšæ³•ï¼šå›ºå®šå±•ç¤º 8 ç§’
                         }, 100);
                         setTimeout(() => { clearInterval(check); resolve(); }, 8000);
                    });
                    
                    setDisplayState(prev => ({ ...prev, showModal: false }));
                    await new Promise(r => setTimeout(r, 500));
                }
                setIsDrawing(false);
            };

            return (
                <div className="h-screen bg-gray-900 flex flex-col relative overflow-hidden">
                    <div className="retro-grid-mask"></div><div className="retro-grid-container"><div className="retro-grid"></div></div>

                    {/* å¾—çå½ˆçª— (å¯æ‰‹å‹•é—œé–‰) */}
                    {displayState.showModal && displayState.winner && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 animate__animated animate__fadeIn">
                            <div className="text-center animate__animated animate__zoomInDown">
                                <div className="pixel-box-dark p-12 border-8 border-yellow-500 shadow-[0_0_50px_rgba(234,179,8,0.5)]">
                                    <div className="text-9xl mb-6 animate-bounce">{displayState.winner.avatar}</div>
                                    <div className="text-5xl font-black text-white">No.{allPlayers.findIndex(p => p.id === displayState.winner.id)+1}</div>
                                    <div className="text-2xl text-yellow-300 mt-2">{displayState.winner.name}</div>
                                    <div className="mt-8 bg-red-600 text-white px-6 py-2 text-xl inline-block">WINNER</div>
                                </div>
                                <button className="mt-8 pixel-btn bg-white text-black px-6 py-3 font-bold text-xl" onClick={() => setDisplayState(prev => ({...prev, showModal: false}))}>é—œé–‰ / ä¸‹ä¸€ä½</button>
                            </div>
                        </div>
                    )}

                    <div className="absolute top-0 left-0 w-full p-4 flex justify-between z-20">
                        <div className="pixel-box px-4 py-2 bg-blue-600 text-white text-xs">P: {allPlayers.length} / Left: {availablePlayers.length}</div>
                        <div className="pixel-box px-4 py-2 bg-red-600 text-white text-xs">MODE: {gameMode.toUpperCase()}</div>
                    </div>

                    <div className="flex-1 flex items-center justify-center p-8 z-10">
                        <VisualComponent candidates={availablePlayers} targetName={displayState.text} isRolling={displayState.rolling} mode={gameMode} winnerObj={displayState.winner} />
                    </div>

                    <div className="h-24 bg-gray-800 border-t-4 border-black flex items-center justify-center gap-6 p-4 z-30">
                        {!isDrawing && <div className="flex items-center gap-4 bg-black p-2 border-2 border-white"><span className="text-xs text-gray-400">COUNT</span><button className="text-yellow-400 font-bold" onClick={()=>setTargetCount(Math.max(1,targetCount-1))}>-</button><span className="text-xl w-8 text-center">{targetCount}</span><button className="text-yellow-400 font-bold" onClick={()=>setTargetCount(Math.min(10,targetCount+1))}>+</button></div>}
                        <button onClick={startDraw} disabled={isDrawing || allPlayers.length === 0} className={`pixel-btn ${isDrawing ? 'bg-gray-600' : 'pixel-btn-yellow'} px-8 py-3 text-xl font-bold`}>{isDrawing ? 'ROLLING...' : 'START'}</button>
                        {!isDrawing && <button onClick={resetGame} className="pixel-btn bg-gray-600 text-xs px-4 py-3">RESET</button>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('index');
            const [room, setRoom] = useState('');
            useEffect(() => {
                const p = new URLSearchParams(window.location.search);
                const m = p.get('mode'); const r = p.get('room');
                if (m === 'host' && r) { setMode('host'); setRoom(r); }
                else if (m === 'player' && r) { setMode('player'); setRoom(r); }
                else setMode('index');
            }, []);
            const handleStartHost = (rid, ps) => {
                sessionStorage.setItem(`lottery_players_${rid}`, JSON.stringify(ps));
                window.location.href = `?mode=host&room=${rid}`;
            };
            return (
                <ErrorBoundary>
                    {mode === 'index' && <IndexPage onStartHost={handleStartHost} initialPlayers={[]} />}
                    {mode === 'host' && <HostApp room={room} initialPlayers={JSON.parse(sessionStorage.getItem(`lottery_players_${room}`) || '[]')} />}
                    {mode === 'player' && <PlayerApp room={room} />}
                </ErrorBoundary>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        removeLoading();
    </script>
</body>
</html>
