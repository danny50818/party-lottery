<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº’å‹•æŠ½ç - ç©å®¶</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
    
    <!-- React Libs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tools -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        body { 
            background: #450a0a; 
            color: white; 
            overscroll-behavior: none; 
            font-family: "Microsoft JhengHei", sans-serif; 
            margin: 0;
            overflow: hidden;
        }
        
        /* åŸºç¤æ¨£å¼ */
        .glass-panel {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* æ—‹è½‰å…‰èŠ’èƒŒæ™¯ */
        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .bg-rays {
            position: absolute;
            inset: -150%;
            background: repeating-conic-gradient(from 0deg, #b45309 0deg 10deg, transparent 10deg 20deg);
            opacity: 0.15;
            animation: rotate-slow 60s linear infinite;
            pointer-events: none;
        }

        /* é–ƒçˆæ–‡å­— */
        @keyframes shine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .text-shine {
            background: linear-gradient(to right, #fcd34d 20%, #ffffff 40%, #fcd34d 60%);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shine 3s linear infinite;
        }

        /* æ¼‚æµ®ç²’å­ */
        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-10vh) scale(1.5); opacity: 0; }
        }
        .particle {
            position: absolute;
            background: radial-gradient(circle, #fbbf24 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const AVATARS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ¦„"];

        // æ¼‚æµ®ç²’å­çµ„ä»¶
        const FloatingParticles = () => {
            const particles = useMemo(() => Array.from({ length: 20 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + '%',
                size: Math.random() * 20 + 5 + 'px',
                duration: Math.random() * 5 + 5 + 's',
                delay: Math.random() * -10 + 's'
            })), []);

            return (
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                    {particles.map(p => (
                        <div key={p.id} className="particle" style={{
                            left: p.left,
                            width: p.size,
                            height: p.size,
                            animationDuration: p.duration,
                            animationDelay: p.delay
                        }}></div>
                    ))}
                </div>
            );
        };

        const PlayerApp = () => {
            const [roomId, setRoomId] = useState('');
            const [user, setUser] = useState(null);
            const [nameInput, setNameInput] = useState("");
            const [myAvatar, setMyAvatar] = useState(AVATARS[0]);
            const [joined, setJoined] = useState(false);
            const [gameStatus, setGameStatus] = useState({ status: 'lobby' }); 
            const [mqttStatus, setMqttStatus] = useState('connecting'); // connecting, connected, error
            const clientRef = useRef(null);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const rid = urlParams.get('room');
                
                // å¦‚æœæ²’æœ‰æˆ¿é–“è™Ÿ (ç›´æ¥æ‰“é–‹æª”æ¡ˆ)ï¼Œé¡¯ç¤ºæç¤º
                if (!rid) { 
                    setMqttStatus('no-room');
                    return; 
                }
                setRoomId(rid);

                const savedUser = localStorage.getItem(`lottery_user_${rid}`);
                if (savedUser) {
                    const u = JSON.parse(savedUser);
                    setUser(u);
                    setJoined(true);
                    connectMqtt(u, rid);
                }
            }, []);

            const connectMqtt = (u, rid) => {
                setMqttStatus('connecting');
                const client = mqtt.connect(MQTT_BROKER);
                clientRef.current = client;
                
                client.on('connect', () => {
                    console.log('MQTT Connected');
                    setMqttStatus('connected');
                    client.publish(`tw_lottery/${rid}/join`, JSON.stringify(u));
                    client.subscribe(`tw_lottery/${rid}/status`);
                });

                client.on('error', (err) => {
                    console.error('MQTT Error', err);
                    setMqttStatus('error');
                });

                client.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        setGameStatus(data);
                    } catch (e) { console.error(e); }
                });
            };

            const handleJoin = () => {
                if (!nameInput.trim()) return;
                const newUser = {
                    id: Date.now().toString() + Math.random().toString().slice(2),
                    name: nameInput.trim(),
                    avatar: myAvatar
                };
                setUser(newUser);
                setJoined(true);
                if(roomId) {
                    localStorage.setItem(`lottery_user_${roomId}`, JSON.stringify(newUser));
                    connectMqtt(newUser, roomId);
                }
            };

            const logout = () => {
                if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                    if(roomId) localStorage.removeItem(`lottery_user_${roomId}`);
                    setJoined(false);
                    setNameInput("");
                }
            };

            // åˆ¤æ–·æ˜¯å¦ä¸­ç
            const isWinner = gameStatus.status === 'result' && gameStatus.winnerId === user?.id;

            // ç‰¹æ•ˆï¼šä¸­çæ™‚æŒçºŒæ”¾ç…™ç«
            useEffect(() => {
                if (isWinner) {
                    const duration = 5000;
                    const end = Date.now() + duration;
                    const frame = () => {
                        confetti({ 
                            particleCount: 3, 
                            angle: 60, 
                            spread: 55, 
                            origin: { x: 0 }, 
                            colors: ['#FFD700', '#FFA500', '#FFFFFF'] 
                        });
                        confetti({ 
                            particleCount: 3, 
                            angle: 120, 
                            spread: 55, 
                            origin: { x: 1 }, 
                            colors: ['#FFD700', '#FFA500', '#FFFFFF'] 
                        });
                        if (Date.now() < end && isWinner) requestAnimationFrame(frame);
                    };
                    frame();
                }
            }, [isWinner]);

            // --- éŒ¯èª¤/æç¤ºç•«é¢ ---
            if (mqttStatus === 'no-room') {
                return <div className="min-h-screen flex items-center justify-center bg-black text-red-400 p-6 text-center">
                    <div>
                        <div className="text-4xl mb-2">âš ï¸</div>
                        <div className="font-bold text-xl">é€£çµç„¡æ•ˆ</div>
                        <p className="text-sm mt-2">è«‹é‡æ–°æƒæå¤§è¢å¹•ä¸Šçš„ QR Code</p>
                    </div>
                </div>;
            }

            // --- ç•«é¢ A: ä¸­çç•«é¢ (è¶…ç´šè¯éº—ç‰ˆ) ---
            if (isWinner) {
                return (
                    <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-b from-red-900 via-red-800 to-black overflow-hidden">
                        {/* èƒŒæ™¯ç‰¹æ•ˆå±¤ */}
                        <div className="bg-rays"></div>
                        <FloatingParticles />
                        
                        {/* å…‰æšˆ */}
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-yellow-500/20 rounded-full blur-[100px] animate-pulse"></div>

                        {/* ä¸»è¦å…§å®¹ */}
                        <div className="relative z-10 text-center p-6 w-full max-w-lg">
                            <div className="animate__animated animate__zoomInDown">
                                {/* çç›ƒ */}
                                <div className="text-[12rem] mb-4 filter drop-shadow-[0_0_50px_rgba(255,215,0,0.6)] animate__animated animate__tada animate__infinite animate__slower">
                                    ğŸ†
                                </div>
                                
                                {/* æ­å–œæ–‡å­— */}
                                <div className="space-y-2 mb-8">
                                    <h2 className="text-3xl text-yellow-200 font-bold tracking-[0.5em] uppercase border-b border-yellow-500/50 pb-2 inline-block">
                                        Congratulations
                                    </h2>
                                    <h1 className="text-6xl font-black text-shine drop-shadow-xl mt-4">
                                        æ­å–œä¸­çï¼
                                    </h1>
                                    <p className="text-xl text-yellow-100/90 font-bold mt-4">
                                        ä½ æ˜¯æœ¬å›åˆçš„å¹¸é‹å…’
                                    </p>
                                </div>

                                {/* å¡ç‰‡è³‡è¨Š */}
                                <div className="glass-panel p-8 rounded-3xl transform hover:scale-105 transition-transform duration-300 border-2 border-yellow-400/50 shadow-[0_0_30px_rgba(234,179,8,0.3)]">
                                    <div className="flex flex-col items-center gap-4">
                                        <div className="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center text-5xl border-2 border-white/50 shadow-inner">
                                            {user.avatar}
                                        </div>
                                        <div className="text-3xl font-bold text-white">{user.name}</div>
                                        <div className="bg-red-600 text-white px-6 py-2 rounded-full font-bold animate-pulse shadow-lg">
                                            è«‹ç›¡é€Ÿå‰å¾€å°å‰é ˜ç
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- ç•«é¢ B: ç™»å…¥å‰ ---
            if (!joined) {
                return (
                    <div className="min-h-screen bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-red-900 via-red-950 to-black p-6 flex flex-col justify-center relative overflow-hidden">
                        <FloatingParticles />
                        <div className="w-full max-w-md mx-auto space-y-8 relative z-10 animate__animated animate__fadeIn">
                            <div className="text-center space-y-2">
                                <h1 className="text-5xl font-black gold-text drop-shadow-lg tracking-tight">JOIN PARTY</h1>
                                <p className="text-red-200 text-sm tracking-widest border-t border-red-500/30 pt-2 mt-2 inline-block">è¼¸å…¥æš±ç¨±ï¼ŒåŠ å…¥ç››å…¸</p>
                            </div>
                            <div className="glass-panel rounded-[2rem] p-8 space-y-8 shadow-2xl">
                                <div className="space-y-4">
                                    <label className="text-xs font-bold text-yellow-500/80 uppercase tracking-widest">é¸æ“‡é ­åƒ</label>
                                    <div className="grid grid-cols-4 gap-3">
                                        {AVATARS.slice(0, 12).map((a) => (
                                            <button 
                                                key={a} 
                                                onClick={() => setMyAvatar(a)} 
                                                className={`aspect-square text-3xl rounded-2xl transition-all border-2 flex items-center justify-center ${myAvatar === a ? 'bg-red-800 border-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.5)] scale-110' : 'bg-red-900/30 border-transparent hover:bg-red-900/50'}`}
                                            >
                                                {a}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <label className="text-xs font-bold text-yellow-500/80 uppercase tracking-widest">æ‚¨çš„æš±ç¨±</label>
                                    <input 
                                        type="text" 
                                        className="w-full bg-red-950/50 border border-red-800 rounded-xl p-4 text-center text-2xl font-bold text-white focus:border-yellow-500 outline-none placeholder:text-red-900/50 transition-all focus:shadow-[0_0_20px_rgba(234,179,8,0.2)]" 
                                        placeholder="ä¾‹å¦‚: å°æ˜" 
                                        value={nameInput} 
                                        onChange={e => setNameInput(e.target.value)} 
                                        maxLength={10} 
                                    />
                                </div>
                                <button 
                                    onClick={handleJoin} 
                                    className="w-full bg-gradient-to-r from-yellow-500 via-yellow-400 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-red-950 py-4 rounded-xl text-xl font-black shadow-lg transition-all active:scale-95 hover:shadow-yellow-500/30"
                                >
                                    ğŸš€ ç«‹å³åŠ å…¥
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- ç•«é¢ C: ç­‰å¾…/éŠæˆ²ä¸­ ---
            return (
                <div className="min-h-screen bg-[radial-gradient(circle_at_center,_#991b1b_0%,_#450a0a_100%)] flex flex-col relative overflow-hidden text-white font-sans">
                    <FloatingParticles />
                    
                    <div className="flex-1 flex flex-col items-center justify-center p-8 relative z-10 text-center w-full max-w-md mx-auto">
                        
                        {/* é€£ç·šç‹€æ…‹æç¤º (åƒ…åœ¨é€£ç·šæœ‰å•é¡Œæ™‚é¡¯ç¤º) */}
                        {mqttStatus === 'error' && (
                            <div className="absolute top-4 left-0 w-full px-4">
                                <div className="bg-red-600/90 text-white text-xs py-2 px-4 rounded-full shadow-lg animate-pulse mx-auto w-fit">
                                    âš ï¸ é€£ç·šä¸ç©©ï¼Œå˜—è©¦é‡é€£ä¸­...
                                </div>
                            </div>
                        )}

                        {gameStatus.status === 'playing' ? (
                            // æŠ½çé€²è¡Œä¸­
                            <div className="space-y-8 animate__animated animate__pulse animate__infinite">
                                <div className="relative">
                                    <div className="absolute inset-0 bg-yellow-500/20 blur-xl rounded-full animate-pulse"></div>
                                    <div className="text-[8rem] relative z-10 animate-spin" style={{animationDuration: '3s'}}>ğŸ²</div>
                                </div>
                                <div>
                                    <div className="text-3xl font-black text-yellow-400 tracking-widest mb-2">æŠ½çé€²è¡Œä¸­</div>
                                    <div className="text-red-200 text-lg">ç¬¬ {gameStatus.round} å›åˆ</div>
                                </div>
                                <div className="bg-black/30 px-6 py-2 rounded-full text-sm text-yellow-200/70 border border-yellow-500/20">
                                    ç¥ä½ å¥½é‹ Good Luck!
                                </div>
                            </div>
                        ) : (
                            // ç­‰å¾…ç‹€æ…‹
                            <div className="w-full space-y-8 animate__animated animate__fadeIn">
                                <div className="relative group">
                                    <div className="absolute inset-0 bg-yellow-500/20 blur-2xl rounded-full group-hover:bg-yellow-500/30 transition-all"></div>
                                    <div className="w-40 h-40 mx-auto bg-gradient-to-br from-red-800 to-red-950 rounded-full flex items-center justify-center text-7xl shadow-2xl border-4 border-yellow-500 relative z-10 transform group-hover:scale-105 transition-transform">
                                        {user.avatar}
                                    </div>
                                    <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-yellow-500 text-red-900 text-xs font-bold px-3 py-1 rounded-full shadow-lg">ME</div>
                                </div>
                                
                                <div>
                                    <h2 className="text-5xl font-black mb-3 drop-shadow-md text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-300">
                                        {user.name}
                                    </h2>
                                    <div className="inline-flex items-center px-5 py-2 rounded-full bg-green-900/40 text-green-400 text-sm font-bold border border-green-500/30 backdrop-blur-sm">
                                        <span className={`w-2 h-2 rounded-full mr-2 ${mqttStatus === 'connected' ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>
                                        {mqttStatus === 'connected' ? 'å·²é€£ç·š Ready' : 'é€£ç·šä¸­...'}
                                    </div>
                                </div>

                                {gameStatus.winnerName ? (
                                    <div className="glass-panel p-6 rounded-2xl animate__animated animate__fadeInUp">
                                        <p className="text-yellow-500/70 text-xs uppercase tracking-widest font-bold mb-2">ä¸Šå›åˆå¾—ä¸»</p>
                                        <div className="text-3xl font-black text-white">{gameStatus.winnerName}</div>
                                    </div>
                                ) : (
                                    <div className="text-red-200/50 text-sm animate-pulse">
                                        ç­‰å¾…ä¸»æŒäººé–‹å§‹ä¸‹ä¸€å›åˆ...
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* åº•éƒ¨åŠŸèƒ½åˆ— */}
                    <div className="p-6 relative z-10 text-center">
                        <button 
                            onClick={logout} 
                            className="text-red-300/40 text-sm hover:text-white transition-colors underline decoration-dotted underline-offset-4"
                        >
                            ç™»å‡º / åˆ‡æ›å¸³è™Ÿ
                        </button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<PlayerApp />);
    </script>
</body>
</html>